<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-neuroviz2">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>
  </template>
  <script src="../bower_components/three.js/build/three.js"></script>
  <script src="../bower_components/three.js/examples/js/loaders/OBJLoader.js"></script>
  <script src="../bower_components/three.js/examples/js/renderers/SVGRenderer.js"></script>
  <script src="../bower_components/mojs/build/mo.js"></script>
  <script>
    let scene;
    let raycaster = new THREE.Raycaster();
    let camera;
    let mouse = new THREE.Vector2(), INTERSECTED;
    let mouseX = 0;
    let mouseY = 0;
    let renderer = new THREE.WebGLRenderer();
    let markers = [];
    renderer.setPixelRatio( window.devicePixelRatio );
    let windowHalfX = window.innerWidth / 2;
		let windowHalfY = window.innerHeight / 2;
    document.addEventListener('mousemove', onDocumentMouseMove, false);
    init();
    render();


    function init(){
      scene = new THREE.Scene();

      var gridHelper = new THREE.GridHelper( 200, 200, 0x0000ff, 0x808080 );
				gridHelper.position.y = 0;
				gridHelper.position.x = 0;
				// scene.add( gridHelper );
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );
      camera.position.x = 10;//10;
      camera.position.y = 10;
      camera.position.z = 10;



			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

      var loader = new THREE.JSONLoader();

      loader.load(
        '../src/models/new_neuron.js',
        function(geometry, materials) {
          var material = new THREE.MeshNormalMaterial();   //MultiMaterial(materials);
          var theNeuron = new THREE.Mesh(geometry, material);
          console.log(theNeuron.position.x)
          console.log(theNeuron)
          theNeuron.scale.x = 3;
          theNeuron.scale.y = 3;
          theNeuron.scale.z = 3;
          theNeuron.name = "the Neuron"
          scene.add(theNeuron);
        }
      )

      console.log(markers);
      initMarkers();
      console.log(markers);

//       var geometry = new THREE.CircleBufferGeometry( .4, 32 );
//       var material = new THREE.MeshNormalMaterial();
// var circle = new THREE.Mesh( geometry, material );
// scene.add( circle );


      window.addEventListener( 'resize', onWindowResize, false );

    }


    function initMarkers() {
      let markerXYZ = [
        { x:8, y:2.3, z:0 },
        { x:1, y:3, z:1 },
        { x:-5, y:3.5, z:0 },
        { x:-7, y:2.6, z:3 },
        { x:10, y:3.1, z:2 }
       ];

      for (i = 0; i < markerXYZ.length; i++) {
        current = markerXYZ[i];
        console.log(current)

        let newGeo = new THREE.OctahedronGeometry(.4,0);
        let newGeoMaterial = new THREE.MeshBasicMaterial( { color: "red" } );
        let marker = new THREE.Mesh(newGeo, newGeoMaterial);

        marker.position.x = current.x;
        marker.position.y = current.y;
        marker.position.z = current.z;
        scene.add(marker);

        markers.push(marker);

      }



    }

      function onDocumentMouseMove(){

        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	      mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

        mouseX = ( event.clientX - windowHalfX );
				mouseY = ( event.clientY - windowHalfY );
        // console.log(mouseX, mouseY)
      }

      function onWindowResize() {
      				camera.aspect = window.innerWidth / window.innerHeight;
      				camera.updateProjectionMatrix();
      				renderer.setSize( window.innerWidth, window.innerHeight );
      			};


      function updateCamera() {
          // if (mouseX >= -52 && mouseX <= 84) {
            camera.position.x = mouseX *.05;//( mouseX - camera.position.x ) * .05;
          // };
          // if (mouseY >= 37.5 && mouseY <= 57.5) {
  				camera.position.y = mouseY *.05;//( - mouseY - camera.position.y ) * .05;
        // }
      }


      function intersectedNode( node ) {
        console.log('pop up')

        const tri = new mojs.Shape({
  shape:      'polygon',
  fill:       'orange',
  radius:     65,
  angle:      { [-120]: -40 },

  scaleX:     { 0 : 1.3 },

  repeat:     10,
  duration:   800,
  isYoyo:     true,
  backwardEasing: 'sin.in',

  isShowEnd:  false
}).play();

      }

      function render () {
				requestAnimationFrame( render );
        // updateCamera();
        camera.lookAt( scene.position );
				renderer.render(scene, camera);

        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects( scene.children );

        if ( intersects.length > 0 ) {
          if ( INTERSECTED != intersects[ 0 ].object ) {
            current = intersects[ 0 ].object ;
            if (current.name != "the Neuron") {
              intersectedNode(current);
            }
          }
        } else {
          /// not intersected with anything!
        }
			};


  </script>
  <script>
    Polymer({
      is: 'my-neuroviz2'
    });
  </script>
</dom-module>
