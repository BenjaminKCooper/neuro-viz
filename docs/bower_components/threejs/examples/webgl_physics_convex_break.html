<html lang="en"><head>
        <title>Convex object breaking example</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,user-scalable=no,minimum-scale=1,maximum-scale=1">
        <style>
            body {
                color: #61443e;
                font-family:Monospace;
                font-size:13px;
                text-align:center;

                background-color: #bfd1e5;
                margin: 0px;
                overflow: hidden;
            }

            #info {
                position: absolute;
                top: 0px; width: 100%;
                padding: 5px;
            }

            a {
                color: #a06851;
            }

        </style>
    </head>
    <body>
	<div id="info">Physics threejs demo with convex objects breaking in real time<br>Press mouse to throw balls and move the camera.</div>
        <div id="container"><br><br><br><br><br>Loading...</div>

	<script src="../build/three.js"></script>
	<script src="js/libs/ammo.js"></script>
	<script src="js/controls/OrbitControls.js"></script>
        <script src="js/Detector.js"></script>
	<script src="js/libs/stats.min.js"></script>
	<script src="js/ConvexObjectBreaker.js"></script>
	<script src="js/geometries/ConvexGeometry.js"></script>

        <script>function init(){initGraphics(),initPhysics(),createObjects(),initInput()}function initGraphics(){container=document.getElementById("container"),camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.2,2e3),scene=new THREE.Scene,camera.position.x=-14,camera.position.y=8,camera.position.z=16,controls=new THREE.OrbitControls(camera),controls.target.y=2,renderer=new THREE.WebGLRenderer,renderer.setClearColor(12571109),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,textureLoader=new THREE.TextureLoader;var e=new THREE.AmbientLight(7368816);scene.add(e);var t=new THREE.DirectionalLight(16777215,1);t.position.set(-10,18,5),t.castShadow=!0;var r=14;t.shadow.camera.left=-r,t.shadow.camera.right=r,t.shadow.camera.top=r,t.shadow.camera.bottom=-r,t.shadow.camera.near=2,t.shadow.camera.far=50,t.shadow.mapSize.x=1024,t.shadow.mapSize.y=1024,scene.add(t),container.innerHTML="",container.appendChild(renderer.domElement),stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",container.appendChild(stats.domElement),window.addEventListener("resize",onWindowResize,!1)}function initPhysics(){collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,dispatcher=new Ammo.btCollisionDispatcher(collisionConfiguration),broadphase=new Ammo.btDbvtBroadphase,solver=new Ammo.btSequentialImpulseConstraintSolver,physicsWorld=new Ammo.btDiscreteDynamicsWorld(dispatcher,broadphase,solver,collisionConfiguration),physicsWorld.setGravity(new Ammo.btVector3(0,-gravityConstant,0))}function createObject(e,t,r,o,a){var n=new THREE.Mesh(new THREE.BoxGeometry(2*t.x,2*t.y,2*t.z),a);n.position.copy(r),n.quaternion.copy(o),convexBreaker.prepareBreakableObject(n,e,new THREE.Vector3,new THREE.Vector3,!0),createDebrisFromBreakableObject(n)}function createObjects(){pos.set(0,-.5,0),quat.set(0,0,0,1);var e=createParalellepipedWithPhysics(40,1,40,0,pos,quat,new THREE.MeshPhongMaterial({color:16777215}));e.receiveShadow=!0,textureLoader.load("textures/grid.png",function(t){t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.repeat.set(40,40),e.material.map=t,e.material.needsUpdate=!0});var t=1e3,r=new THREE.Vector3(2,5,2);pos.set(-8,5,0),quat.set(0,0,0,1),createObject(t,r,pos,quat,createMaterial(15769636)),pos.set(8,5,0),quat.set(0,0,0,1),createObject(t,r,pos,quat,createMaterial(16032545));var o=100,a=new THREE.Vector3(7,.2,1.5);pos.set(0,10.2,0),quat.set(0,0,0,1),createObject(o,a,pos,quat,createMaterial(11765813));var n=120,i=new THREE.Vector3(1,2,.15),s=8;quat.set(0,0,0,1);for(var c=0;c<s;c++)pos.set(0,2,15*(.5-c/(s+1))),createObject(n,i,pos,quat,createMaterial(11579568));var m=860,d=new THREE.Vector3(4,5,4);pos.set(5,.5*d.y,-7),quat.set(0,0,0,1);var l=[];l.push(new THREE.Vector3(d.x,-d.y,d.z)),l.push(new THREE.Vector3(-d.x,-d.y,d.z)),l.push(new THREE.Vector3(d.x,-d.y,-d.z)),l.push(new THREE.Vector3(-d.x,-d.y,-d.z)),l.push(new THREE.Vector3(0,d.y,0));var p=new THREE.Mesh(new THREE.ConvexGeometry(l),createMaterial(16757827));p.position.copy(pos),p.quaternion.copy(quat),convexBreaker.prepareBreakableObject(p,m,new THREE.Vector3,new THREE.Vector3,!0),createDebrisFromBreakableObject(p)}function createParalellepipedWithPhysics(e,t,r,o,a,n,i){var s=new THREE.Mesh(new THREE.BoxGeometry(e,t,r,1,1,1),i),c=new Ammo.btBoxShape(new Ammo.btVector3(.5*e,.5*t,.5*r));return c.setMargin(margin),createRigidBody(s,c,o,a,n),s}function createDebrisFromBreakableObject(e){e.castShadow=!0,e.receiveShadow=!0;var t=createConvexHullPhysicsShape(e.geometry.vertices);t.setMargin(margin);var r=createRigidBody(e,t,e.userData.mass,null,null,e.userData.velocity,e.userData.angularVelocity),o=new Ammo.btVector3(0,0,0);o.threeObject=e,r.setUserPointer(o)}function removeDebris(e){scene.remove(e),physicsWorld.removeRigidBody(e.userData.physicsBody)}function createConvexHullPhysicsShape(e){for(var t=new Ammo.btConvexHullShape,r=0,o=e.length;r<o;r++){var a=e[r];this.tempBtVec3_1.setValue(a.x,a.y,a.z);var n=r===o-1;t.addPoint(this.tempBtVec3_1,n)}return t}function createRigidBody(e,t,r,o,a,n,i){o?e.position.copy(o):o=e.position,a?e.quaternion.copy(a):a=e.quaternion;var s=new Ammo.btTransform;s.setIdentity(),s.setOrigin(new Ammo.btVector3(o.x,o.y,o.z)),s.setRotation(new Ammo.btQuaternion(a.x,a.y,a.z,a.w));var c=new Ammo.btDefaultMotionState(s),m=new Ammo.btVector3(0,0,0);t.calculateLocalInertia(r,m);var d=new Ammo.btRigidBodyConstructionInfo(r,c,t,m),l=new Ammo.btRigidBody(d);return l.setFriction(.5),n&&l.setLinearVelocity(new Ammo.btVector3(n.x,n.y,n.z)),i&&l.setAngularVelocity(new Ammo.btVector3(i.x,i.y,i.z)),e.userData.physicsBody=l,e.userData.collided=!1,scene.add(e),r>0&&(rigidBodies.push(e),l.setActivationState(4)),physicsWorld.addRigidBody(l),l}function createRandomColor(){return Math.floor(Math.random()*(1<<24))}function createMaterial(e){return e=e||createRandomColor(),new THREE.MeshPhongMaterial({color:e})}function initInput(){window.addEventListener("mousedown",function(e){mouseCoords.set(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1),raycaster.setFromCamera(mouseCoords,camera);var t=35,r=.4,o=new THREE.Mesh(new THREE.SphereGeometry(r,14,10),ballMaterial);o.castShadow=!0,o.receiveShadow=!0;var a=new Ammo.btSphereShape(r);a.setMargin(margin),pos.copy(raycaster.ray.direction),pos.add(raycaster.ray.origin),quat.set(0,0,0,1);var n=createRigidBody(o,a,t,pos,quat);pos.copy(raycaster.ray.direction),pos.multiplyScalar(24),n.setLinearVelocity(new Ammo.btVector3(pos.x,pos.y,pos.z))},!1)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function animate(){requestAnimationFrame(animate),render(),stats.update()}function render(){var e=clock.getDelta();updatePhysics(e),controls.update(e),renderer.render(scene,camera),time+=e}function updatePhysics(e){physicsWorld.stepSimulation(e,10);for(var t=0,r=rigidBodies.length;t<r;t++){var o=rigidBodies[t],a=o.userData.physicsBody,n=a.getMotionState();if(n){n.getWorldTransform(transformAux1);var i=transformAux1.getOrigin(),s=transformAux1.getRotation();o.position.set(i.x(),i.y(),i.z()),o.quaternion.set(s.x(),s.y(),s.z(),s.w()),o.userData.collided=!1}}for(var t=0,r=dispatcher.getNumManifolds();t<r;t++){var c=dispatcher.getManifoldByIndexInternal(t),m=c.getBody0(),d=c.getBody1(),l=Ammo.castObject(m.getUserPointer(),Ammo.btVector3).threeObject,p=Ammo.castObject(d.getUserPointer(),Ammo.btVector3).threeObject;if(l||p){var u=l?l.userData:null,w=p?p.userData:null,h=!!u&&u.breakable,b=!!w&&w.breakable,y=!!u&&u.collided,E=!!w&&w.collided;if(!(!h&&!b||y&&E)){for(var v=!1,g=0,R=0,T=c.getNumContacts();R<T;R++){var f=c.getContactPoint(R);if(f.getDistance()<0){v=!0;var H=f.getAppliedImpulse();if(H>g){g=H;var x=f.get_m_positionWorldOnB(),B=f.get_m_normalWorldOnB();impactPoint.set(x.x(),x.y(),x.z()),impactNormal.set(B.x(),B.y(),B.z())}break}}if(v){var A=250;if(h&&!y&&g>A){for(var V=convexBreaker.subdivideByImpact(l,impactPoint,impactNormal,1,2,1.5),M=V.length,R=0;R<M;R++)createDebrisFromBreakableObject(V[R]);objectsToRemove[numObjectsToRemove++]=l,u.collided=!0}if(b&&!E&&g>A){for(var V=convexBreaker.subdivideByImpact(p,impactPoint,impactNormal,1,2,1.5),M=V.length,R=0;R<M;R++)createDebrisFromBreakableObject(V[R]);objectsToRemove[numObjectsToRemove++]=p,w.collided=!0}}}}}for(var t=0;t<numObjectsToRemove;t++)removeDebris(objectsToRemove[t]);numObjectsToRemove=0}Detector.webgl||(Detector.addGetWebGLMessage(),document.getElementById("container").innerHTML="");for(var container,stats,camera,controls,scene,renderer,textureLoader,clock=new THREE.Clock,mouseCoords=new THREE.Vector2,raycaster=new THREE.Raycaster,ballMaterial=new THREE.MeshPhongMaterial({color:2105376}),gravityConstant=7.8,collisionConfiguration,dispatcher,broadphase,solver,physicsWorld,margin=.05,convexBreaker=new THREE.ConvexObjectBreaker,rigidBodies=[],pos=new THREE.Vector3,quat=new THREE.Quaternion,transformAux1=new Ammo.btTransform,tempBtVec3_1=new Ammo.btVector3(0,0,0),time=0,objectsToRemove=[],i=0;i<500;i++)objectsToRemove[i]=null;var numObjectsToRemove=0,impactPoint=new THREE.Vector3,impactNormal=new THREE.Vector3;init(),animate();</script>

    

</body></html>