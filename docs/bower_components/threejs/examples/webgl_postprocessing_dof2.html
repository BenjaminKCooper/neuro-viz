<!DOCTYPE html><html lang="en"><head>
		<title>three.js webgl - postprocessing - depth-of-field</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,minimum-scale=1,maximum-scale=1">
		<style>
			body {
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
				text-align:center;
			}

			a {
				color:#0078ff;
			}

			#info {
				color:#fff;
				position: relative;
				top: 0px;
				width: 100em;
				margin: 0 auto -2.1em;
				padding: 5px;
				z-index:100;
			}
		</style>
	</head>

	<body>
		<script src="../build/three.js"></script>
		<script src="js/shaders/BokehShader2.js"></script>

		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>

		<div id="info">
			<a href="http://threejs.org" target="_blank">three.js</a> - webgl realistic depth-of-field bokeh example -
			shader ported from <a href="http://blenderartists.org/forum/showthread.php?237488-GLSL-depth-of-field-with-bokeh-v2-4-(update)">Martins Upitis</a>
		</div>

		<script>function init(){container=document.createElement("div"),document.body.appendChild(container),camera=new THREE.PerspectiveCamera(70,window.innerWidth/height,1,3e3),camera.position.y=150,camera.position.z=450,scene=new THREE.Scene,scene.add(camera),renderer=new THREE.WebGLRenderer({antialias:!1}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,height),renderer.sortObjects=!1,container.appendChild(renderer.domElement),material_depth=new THREE.MeshDepthMaterial;var e="textures/cube/Bridge2/",n=[e+"posx.jpg",e+"negx.jpg",e+"posy.jpg",e+"negy.jpg",e+"posz.jpg",e+"negz.jpg"],t=(new THREE.CubeTextureLoader).load(n);t.format=THREE.RGBFormat;var o=THREE.ShaderLib.cube;o.uniforms.tCube.value=t;var r=new THREE.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:o.uniforms,depthWrite:!1,side:THREE.BackSide});h=new THREE.Mesh(new THREE.BoxGeometry(1e3,1e3,1e3),r),camera.add(h);var a=new THREE.PlaneBufferGeometry(10,10,1,1),i=new THREE.MeshPhongMaterial({color:6710886,shininess:.5,specular:16777215,envMap:t,side:THREE.DoubleSide}),s=Math.random;for(c=0;c<leaves;c++)plane=new THREE.Mesh(a,i),plane.rotation.set(s(),s(),s()),plane.rotation.dx=.1*s(),plane.rotation.dy=.1*s(),plane.rotation.dz=.1*s(),plane.position.set(150*s(),0+300*s(),150*s()),plane.position.dx=s()-.5,plane.position.dz=s()-.5,scene.add(plane),planes.push(plane);var d=new THREE.JSONLoader;d.load("obj/Suzanne.js",function(e){for(var n=new THREE.MeshPhongMaterial({color:16777215,specular:16777215,envMap:t,combine:THREE.MultiplyOperation,shininess:50,reflectivity:1}),o=20,r=0;r<o;r++){var a=new THREE.Mesh(e,n);a.scale.multiplyScalar(30),a.position.z=200*Math.cos(r/o*Math.PI*2),a.position.y=20*Math.sin(r/o*Math.PI*3),a.position.x=200*Math.sin(r/o*Math.PI*2),a.rotation.x=Math.PI/2,a.rotation.z=-r/o*Math.PI*2,scene.add(a)}});for(var l=new THREE.SphereGeometry(1,20,20),c=0;c<20;c++){var p=new THREE.MeshPhongMaterial({color:16777215*Math.random(),shininess:.5,specular:16777215,envMap:t}),h=new THREE.Mesh(l,p);h.position.x=200*(Math.random()-.5),h.position.y=50*Math.random(),h.position.z=200*(Math.random()-.5),h.scale.multiplyScalar(10),scene.add(h)}scene.add(new THREE.AmbientLight(2236962)),directionalLight=new THREE.DirectionalLight(16777215,2),directionalLight.position.set(2,1.2,10).normalize(),scene.add(directionalLight),directionalLight=new THREE.DirectionalLight(16777215,1),directionalLight.position.set(-2,1.2,-10).normalize(),scene.add(directionalLight),initPostprocessing(),renderer.autoClear=!1,renderer.domElement.style.position="absolute",renderer.domElement.style.left="0px",stats=new Stats,container.appendChild(stats.dom),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.addEventListener("touchstart",onDocumentTouchStart,!1),document.addEventListener("touchmove",onDocumentTouchMove,!1),effectController={enabled:!0,jsDepthCalculation:!0,shaderFocus:!1,fstop:2.2,maxblur:1,showFocus:!1,focalDepth:2.8,manualdof:!1,vignetting:!1,depthblur:!1,threshold:.5,gain:2,bias:.5,fringe:.7,focalLength:35,noise:!0,pentagon:!1,dithering:1e-4};var g=function(){for(var e in effectController)e in postprocessing.bokeh_uniforms&&(postprocessing.bokeh_uniforms[e].value=effectController[e]);postprocessing.enabled=effectController.enabled,postprocessing.bokeh_uniforms.znear.value=camera.near,postprocessing.bokeh_uniforms.zfar.value=camera.far,camera.setFocalLength(effectController.focalLength)},f=new dat.GUI;f.add(effectController,"enabled").onChange(g),f.add(effectController,"jsDepthCalculation").onChange(g),f.add(effectController,"shaderFocus").onChange(g),f.add(effectController,"focalDepth",0,200).listen().onChange(g),f.add(effectController,"fstop",.1,22,.001).onChange(g),f.add(effectController,"maxblur",0,5,.025).onChange(g),f.add(effectController,"showFocus").onChange(g),f.add(effectController,"manualdof").onChange(g),f.add(effectController,"vignetting").onChange(g),f.add(effectController,"depthblur").onChange(g),f.add(effectController,"threshold",0,1,.001).onChange(g),f.add(effectController,"gain",0,100,.001).onChange(g),f.add(effectController,"bias",0,3,.001).onChange(g),f.add(effectController,"fringe",0,5,.001).onChange(g),f.add(effectController,"focalLength",16,80,.001).onChange(g),f.add(effectController,"noise").onChange(g),f.add(effectController,"dithering",0,.001,1e-4).onChange(g),f.add(effectController,"pentagon").onChange(g),f.add(shaderSettings,"rings",1,8).step(1).onChange(shaderUpdate),f.add(shaderSettings,"samples",1,13).step(1).onChange(shaderUpdate),g(),window.addEventListener("resize",onWindowResize,!1)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function onDocumentMouseMove(e){mouse.x=(e.clientX-windowHalfX)/windowHalfX,mouse.y=-(e.clientY-windowHalfY)/windowHalfY,postprocessing.bokeh_uniforms.focusCoords.value.set(e.clientX/window.innerWidth,1-e.clientY/window.innerHeight)}function onDocumentTouchStart(e){1==e.touches.length&&(e.preventDefault(),mouse.x=(e.touches[0].pageX-windowHalfX)/windowHalfX,mouse.y=-(e.touches[0].pageY-windowHalfY)/windowHalfY)}function onDocumentTouchMove(e){1==e.touches.length&&(e.preventDefault(),mouse.x=(e.touches[0].pageX-windowHalfX)/windowHalfX,mouse.y=-(e.touches[0].pageY-windowHalfY)/windowHalfY)}function initPostprocessing(){postprocessing.scene=new THREE.Scene,postprocessing.camera=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4),postprocessing.camera.position.z=100,postprocessing.scene.add(postprocessing.camera);var e={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};postprocessing.rtTextureDepth=new THREE.WebGLRenderTarget(window.innerWidth,height,e),postprocessing.rtTextureColor=new THREE.WebGLRenderTarget(window.innerWidth,height,e);var n=THREE.BokehShader;postprocessing.bokeh_uniforms=THREE.UniformsUtils.clone(n.uniforms),postprocessing.bokeh_uniforms.tColor.value=postprocessing.rtTextureColor.texture,postprocessing.bokeh_uniforms.tDepth.value=postprocessing.rtTextureDepth.texture,postprocessing.bokeh_uniforms.textureWidth.value=window.innerWidth,postprocessing.bokeh_uniforms.textureHeight.value=height,postprocessing.materialBokeh=new THREE.ShaderMaterial({uniforms:postprocessing.bokeh_uniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,defines:{RINGS:shaderSettings.rings,SAMPLES:shaderSettings.samples}}),postprocessing.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(window.innerWidth,window.innerHeight),postprocessing.materialBokeh),postprocessing.quad.position.z=-500,postprocessing.scene.add(postprocessing.quad)}function shaderUpdate(){postprocessing.materialBokeh.defines.RINGS=shaderSettings.rings,postprocessing.materialBokeh.defines.SAMPLES=shaderSettings.samples,postprocessing.materialBokeh.needsUpdate=!0}function animate(){requestAnimationFrame(animate,renderer.domElement),render(),stats.update()}function linearize(e){var n=camera.far,t=camera.near;return-n*t/(e*(n-t)-n)}function smoothstep(e,n,t){var o=saturate((t-e)/(n-e));return o*o*(3-2*o)}function saturate(e){return Math.max(0,Math.min(1,e))}function render(){var e=15e-5*Date.now();if(camera.position.x=400*Math.cos(e),camera.position.z=500*Math.sin(e),camera.position.y=100*Math.sin(e/1.4),camera.lookAt(target),camera.updateMatrixWorld(),effectController.jsDepthCalculation){raycaster.setFromCamera(mouse,camera);var n=raycaster.intersectObjects(scene.children,!0);if(n.length>0){var t=n[0].distance;distance+=.03*(t-distance);var o=smoothstep(camera.near,camera.far,distance),r=linearize(1-o);postprocessing.bokeh_uniforms.focalDepth.value=r,effectController.focalDepth=r}}for(i=0;i<leaves;i++)plane=planes[i],plane.rotation.x+=plane.rotation.dx,plane.rotation.y+=plane.rotation.dy,plane.rotation.z+=plane.rotation.dz,plane.position.y-=2,plane.position.x+=plane.position.dx,plane.position.z+=plane.position.dz,plane.position.y<0&&(plane.position.y+=300);postprocessing.enabled?(renderer.clear(),scene.overrideMaterial=null,renderer.render(scene,camera,postprocessing.rtTextureColor,!0),scene.overrideMaterial=material_depth,renderer.render(scene,camera,postprocessing.rtTextureDepth,!0),renderer.render(postprocessing.scene,postprocessing.camera)):(scene.overrideMaterial=null,renderer.clear(),renderer.render(scene,camera))}Detector.webgl||Detector.addGetWebGLMessage();var container,stats,camera,scene,renderer,material_depth,windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2,height=window.innerHeight,postprocessing={enabled:!0},shaderSettings={rings:3,samples:4},singleMaterial=!1,mouse=new THREE.Vector2,raycaster=new THREE.Raycaster,distance=100,target=new THREE.Vector3(0,20,-50),effectController,planes=[],leaves=100;init(),animate();</script>
	

</body></html>