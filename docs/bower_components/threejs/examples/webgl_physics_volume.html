<html lang="en"><head>
        <title>Ammo.js softbody volume demo</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,user-scalable=no,minimum-scale=1,maximum-scale=1">
        <style>
            body {
                color: #61443e;
                font-family:Monospace;
                font-size:13px;
                text-align:center;

                background-color: #bfd1e5;
                margin: 0px;
                overflow: hidden;
            }

            #info {
                position: absolute;
                top: 0px; width: 100%;
                padding: 5px;
            }

            a {

                color: #a06851;
            }

        </style>
    </head>
    <body>
	<div id="info">Ammo.js physics soft body volume demo<br>Click to throw a ball</div>
        <div id="container"><br><br><br><br><br>Loading...</div>

	<script src="../build/three.js"></script>
	<script src="js/libs/ammo.js"></script>
	<script src="js/controls/OrbitControls.js"></script>
        <script src="js/Detector.js"></script>
	<script src="js/libs/stats.min.js"></script>

        <script>function init(){initGraphics(),initPhysics(),createObjects(),initInput()}function initGraphics(){container=document.getElementById("container"),camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.2,2e3),scene=new THREE.Scene,camera.position.x=-7,camera.position.y=5,camera.position.z=8,controls=new THREE.OrbitControls(camera),controls.target.y=2,renderer=new THREE.WebGLRenderer,renderer.setClearColor(12571109),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,textureLoader=new THREE.TextureLoader;var e=new THREE.AmbientLight(4210752);scene.add(e);var t=new THREE.DirectionalLight(16777215,1);t.position.set(-10,10,5),t.castShadow=!0;var o=20;t.shadow.camera.left=-o,t.shadow.camera.right=o,t.shadow.camera.top=o,t.shadow.camera.bottom=-o,t.shadow.camera.near=2,t.shadow.camera.far=50,t.shadow.mapSize.x=1024,t.shadow.mapSize.y=1024,scene.add(t),container.innerHTML="",container.appendChild(renderer.domElement),stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",container.appendChild(stats.domElement),window.addEventListener("resize",onWindowResize,!1)}function initPhysics(){collisionConfiguration=new Ammo.btSoftBodyRigidBodyCollisionConfiguration,dispatcher=new Ammo.btCollisionDispatcher(collisionConfiguration),broadphase=new Ammo.btDbvtBroadphase,solver=new Ammo.btSequentialImpulseConstraintSolver,softBodySolver=new Ammo.btDefaultSoftBodySolver,physicsWorld=new Ammo.btSoftRigidDynamicsWorld(dispatcher,broadphase,solver,collisionConfiguration,softBodySolver),physicsWorld.setGravity(new Ammo.btVector3(0,gravityConstant,0)),physicsWorld.getWorldInfo().set_m_gravity(new Ammo.btVector3(0,gravityConstant,0))}function createObjects(){pos.set(0,-.5,0),quat.set(0,0,0,1);var e=createParalellepiped(40,1,40,0,pos,quat,new THREE.MeshPhongMaterial({color:16777215}));e.castShadow=!0,e.receiveShadow=!0,textureLoader.load("textures/grid.png",function(t){t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.repeat.set(40,40),e.material.map=t,e.material.needsUpdate=!0});var t=15,o=new THREE.SphereBufferGeometry(1.5,40,25);o.translate(5,5,0),createSoftVolume(o,t,250);var r=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(1,1,5,4,4,20));r.translate(-2,5,0),createSoftVolume(r,t,120),pos.set(3,1,0),quat.setFromAxisAngle(new THREE.Vector3(0,0,1),30*Math.PI/180);var a=createParalellepiped(10,1,4,0,pos,quat,new THREE.MeshPhongMaterial({color:6316128}));a.castShadow=!0,a.receiveShadow=!0}function processGeometry(e){var t=(new THREE.Geometry).fromBufferGeometry(e),o=(t.mergeVertices(),createIndexedBufferGeometryFromGeometry(t));mapIndices(e,o)}function createIndexedBufferGeometryFromGeometry(e){for(var t=e.vertices.length,o=e.faces.length,r=new THREE.BufferGeometry,a=new Float32Array(3*t),n=new(3*o>65535?Uint32Array:Uint16Array)(3*o),i=0;i<t;i++){var s=e.vertices[i],c=3*i;a[c]=s.x,a[c+1]=s.y,a[c+2]=s.z}for(var i=0;i<o;i++){var d=e.faces[i],c=3*i;n[c]=d.a,n[c+1]=d.b,n[c+2]=d.c}return r.setIndex(new THREE.BufferAttribute(n,1)),r.addAttribute("position",new THREE.BufferAttribute(a,3)),r}function isEqual(e,t,o,r,a,n){var i=1e-6;return Math.abs(r-e)<i&&Math.abs(a-t)<i&&Math.abs(n-o)<i}function mapIndices(e,t){var o=e.attributes.position.array,r=t.attributes.position.array,a=t.index.array,n=r.length/3,i=o.length/3;e.ammoVertices=r,e.ammoIndices=a,e.ammoIndexAssociation=[];for(var s=0;s<n;s++){var c=[];e.ammoIndexAssociation.push(c);for(var d=3*s,m=0;m<i;m++){var l=3*m;isEqual(r[d],r[d+1],r[d+2],o[l],o[l+1],o[l+2])&&c.push(l)}}}function createSoftVolume(e,t,o){processGeometry(e);var r=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:16777215}));r.castShadow=!0,r.receiveShadow=!0,r.frustumCulled=!1,scene.add(r),textureLoader.load("textures/colors.png",function(e){r.material.map=e,r.material.needsUpdate=!0});var a=softBodyHelpers.CreateFromTriMesh(physicsWorld.getWorldInfo(),e.ammoVertices,e.ammoIndices,e.ammoIndices.length/3,!0),n=a.get_m_cfg();n.set_viterations(40),n.set_piterations(40),n.set_collisions(17),n.set_kDF(.1),n.set_kDP(.01),n.set_kPR(o),a.get_m_materials().at(0).set_m_kLST(.9),a.get_m_materials().at(0).set_m_kAST(.9),a.setTotalMass(t,!1),Ammo.castObject(a,Ammo.btCollisionObject).getCollisionShape().setMargin(margin),physicsWorld.addSoftBody(a,1,-1),r.userData.physicsBody=a,a.setActivationState(4),softBodies.push(r)}function createParalellepiped(e,t,o,r,a,n,i){var s=new THREE.Mesh(new THREE.BoxGeometry(e,t,o,1,1,1),i),c=new Ammo.btBoxShape(new Ammo.btVector3(.5*e,.5*t,.5*o));return c.setMargin(margin),createRigidBody(s,c,r,a,n),s}function createRigidBody(e,t,o,r,a){e.position.copy(r),e.quaternion.copy(a);var n=new Ammo.btTransform;n.setIdentity(),n.setOrigin(new Ammo.btVector3(r.x,r.y,r.z)),n.setRotation(new Ammo.btQuaternion(a.x,a.y,a.z,a.w));var i=new Ammo.btDefaultMotionState(n),s=new Ammo.btVector3(0,0,0);t.calculateLocalInertia(o,s);var c=new Ammo.btRigidBodyConstructionInfo(o,i,t,s),d=new Ammo.btRigidBody(c);return e.userData.physicsBody=d,scene.add(e),o>0&&(rigidBodies.push(e),d.setActivationState(4)),physicsWorld.addRigidBody(d),d}function initInput(){window.addEventListener("mousedown",function(e){clickRequest||(mouseCoords.set(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1),clickRequest=!0)},!1)}function processClick(){if(clickRequest){raycaster.setFromCamera(mouseCoords,camera);var e=3,t=.4,o=new THREE.Mesh(new THREE.SphereGeometry(t,18,16),ballMaterial);o.castShadow=!0,o.receiveShadow=!0;var r=new Ammo.btSphereShape(t);r.setMargin(margin),pos.copy(raycaster.ray.direction),pos.add(raycaster.ray.origin),quat.set(0,0,0,1);var a=createRigidBody(o,r,e,pos,quat);a.setFriction(.5),pos.copy(raycaster.ray.direction),pos.multiplyScalar(14),a.setLinearVelocity(new Ammo.btVector3(pos.x,pos.y,pos.z)),clickRequest=!1}}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function animate(){requestAnimationFrame(animate),render(),stats.update()}function render(){var e=clock.getDelta();updatePhysics(e),processClick(),controls.update(e),renderer.render(scene,camera)}function updatePhysics(e){physicsWorld.stepSimulation(e,10);for(var t=0,o=softBodies.length;t<o;t++){for(var r=softBodies[t],a=r.geometry,n=r.userData.physicsBody,i=a.attributes.position.array,s=a.attributes.normal.array,c=a.ammoIndexAssociation,d=c.length,m=n.get_m_nodes(),l=0;l<d;l++)for(var p=m.at(l),u=p.get_m_x(),w=u.x(),y=u.y(),h=u.z(),f=p.get_m_n(),g=f.x(),E=f.y(),v=f.z(),R=c[l],b=0,A=R.length;b<A;b++){var S=R[b];i[S]=w,s[S]=g,S++,i[S]=y,s[S]=E,S++,i[S]=h,s[S]=v}a.attributes.position.needsUpdate=!0,a.attributes.normal.needsUpdate=!0}for(var t=0,o=rigidBodies.length;t<o;t++){var T=rigidBodies[t],B=T.userData.physicsBody,H=B.getMotionState();if(H){H.getWorldTransform(transformAux1);var x=transformAux1.getOrigin(),M=transformAux1.getRotation();T.position.set(x.x(),x.y(),x.z()),T.quaternion.set(M.x(),M.y(),M.z(),M.w())}}}Detector.webgl||(Detector.addGetWebGLMessage(),document.getElementById("container").innerHTML="");var container,stats,camera,controls,scene,renderer,textureLoader,clock=new THREE.Clock,clickRequest=!1,mouseCoords=new THREE.Vector2,raycaster=new THREE.Raycaster,ballMaterial=new THREE.MeshPhongMaterial({color:2105376}),pos=new THREE.Vector3,quat=new THREE.Quaternion,gravityConstant=-9.8,collisionConfiguration,dispatcher,broadphase,solver,physicsWorld,rigidBodies=[],softBodies=[],margin=.05,hinge,transformAux1=new Ammo.btTransform,softBodyHelpers=new Ammo.btSoftBodyHelpers,armMovement=0;init(),animate();</script>

    

</body></html>