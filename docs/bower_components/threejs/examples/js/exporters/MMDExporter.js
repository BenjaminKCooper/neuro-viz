THREE.MMDExporter=function(){function r(r){if(void 0===e){var n=new MMDParser.CharsetEncoder,t=n.s2uTable;e={};for(var a=Object.keys(t),o=0,i=a.length;o<i;o++){var s=a[o],u=t[s];s=parseInt(s),e[u]=s}}for(var p=[],o=0,i=r.length;o<i;o++){var h=r.charCodeAt(o),u=e[h];if(void 0===u)throw"cannot convert charcode 0x"+h.toString(16);u>255?(p.push(u>>8&255),p.push(255&u)):p.push(255&u)}return new Uint8Array(p)}function n(r){var n=r.clone();return n.pose(),n.skeleton.bones}var e;this.parseVpd=function(e,t,a){function o(r){Math.abs(r)<1e-6&&(r=0);var n=r.toString();n.indexOf(".")===-1&&(n+="."),n+="000000";var e=n.indexOf("."),t=n.slice(0,e),a=n.slice(e+1,e+7);return t+"."+a}function i(r){for(var n=[],e=0,t=r.length;e<t;e++)n.push(o(r[e]));return n.join(",")}if(e.isSkinnedMesh!==!0)return console.warn("THREE.MMDExporter: parseVpd() requires SkinnedMesh instance."),null;e.updateMatrixWorld(!0);var s=e.skeleton.bones,u=n(e),p=new THREE.Vector3,h=new THREE.Quaternion,c=new THREE.Quaternion,l=new THREE.Matrix4,v=[];v.push("Vocaloid Pose Data file"),v.push(""),v.push((""!==e.name?e.name.replace(/\s/g,"_"):"skin")+".osm;"),v.push(s.length+";"),v.push("");for(var f=0,d=s.length;f<d;f++){var E=s[f],M=u[f];a===!0&&void 0!==E.userData.ik&&void 0!==E.userData.ik.originalMatrix?l.fromArray(E.userData.ik.originalMatrix):l.copy(E.matrix),p.setFromMatrixPosition(l),h.setFromRotationMatrix(l);var x=p.sub(M.position).toArray(),g=c.copy(M.quaternion).conjugate().multiply(h).toArray();x[2]=-x[2],g[0]=-g[0],g[1]=-g[1],v.push("Bone"+f+"{"+E.name),v.push("  "+i(x)+";"),v.push("  "+i(g)+";"),v.push("}"),v.push("")}v.push("");var k=v.join("\n");return t===!0?r(k):k}};