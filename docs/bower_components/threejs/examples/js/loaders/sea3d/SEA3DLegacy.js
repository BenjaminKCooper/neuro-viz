"use strict";Object.assign(THREE.SEA3D.prototype,{_onHead:THREE.SEA3D.prototype.onHead,_updateTransform:THREE.SEA3D.prototype.updateTransform,_readVertexAnimation:THREE.SEA3D.prototype.readVertexAnimation,_readGeometryBuffer:THREE.SEA3D.prototype.readGeometryBuffer,_readLine:THREE.SEA3D.prototype.readLine,_getAnimationType:THREE.SEA3D.prototype.getAnimationType,_readAnimation:THREE.SEA3D.prototype.readAnimation}),THREE.SEA3D.prototype.isLegacy=function(t){var e=t.sea3d;return"S3D"==e.sign&&!t._legacy&&(t._legacy=1==e.typeUnique[t.type],e.config.legacy)},THREE.SEA3D.prototype.flipVec3=function(t){if(t){for(var e=2;e<t.length;)t[e]=-t[e],e+=3;return t}},THREE.SEA3D.prototype.expandJoints=function(t){for(var e=4*t.numVertex,i=t.isBig?new Uint32Array(e):new Uint16Array(e),n=new Float32Array(e),r=0,o=t.jointPerVertex,a=0;a<t.numVertex;a++){var s=4*a,E=a*o;i[s]=t.joint[E],o>1&&(i[s+1]=t.joint[E+1]),o>2&&(i[s+2]=t.joint[E+2]),o>3&&(i[s+3]=t.joint[E+3]),n[s]=t.weight[E],o>1&&(n[s+1]=t.weight[E+1]),o>2&&(n[s+2]=t.weight[E+2]),o>3&&(n[s+3]=t.weight[E+3]),r=n[s]+n[s+1]+n[s+2]+n[s+3],n[s]+=1-r}t.joint=i,t.weight=n,t.jointPerVertex=4},THREE.SEA3D.prototype.compressJoints=function(t){for(var e=4*t.numVertex,i=t.isBig?new Uint32Array(e):new Uint16Array(e),n=new Float32Array(e),r=0,o=t.jointPerVertex,a=0;a<t.numVertex;a++){var s=4*a,E=a*o;i[s]=t.joint[E],i[s+1]=t.joint[E+1],i[s+2]=t.joint[E+2],i[s+3]=t.joint[E+3],n[s]=t.weight[E],n[s+1]=t.weight[E+1],n[s+2]=t.weight[E+2],n[s+3]=t.weight[E+3],r=n[s]+n[s+1]+n[s+2]+n[s+3],n[s]+=1-r}t.joint=i,t.weight=n,t.jointPerVertex=4},THREE.SEA3D.prototype.flipIndexes=function(t){for(var e=1;e<t.length;){var i=t[e+1];t[e+1]=t[e],t[e]=i,e+=3}return t},THREE.SEA3D.prototype.flipBoneMatrix=function(){var t=new THREE.Vector3;return function(e){var i=THREE.SEA3D.VECBUF.setFromMatrixPosition(e);return i.z=-i.z,e.setPosition(t),e.multiplyMatrices(THREE.SEA3D.MTXBUF.makeRotationZ(THREE.Math.degToRad(180)),e),e.setPosition(i),e}}(),THREE.SEA3D.prototype.flipScaleMatrix=function(){var t=new THREE.Vector3,e=new THREE.Quaternion,i=new THREE.Vector3;return function(n,r,o,a){return o&&n.multiplyMatrices(o,n),n.decompose(t,e,i),i.z=-i.z,n.compose(t,e,i),r&&n.multiplyMatrices(n,THREE.SEA3D.MTXBUF.makeRotationZ(THREE.Math.degToRad(180))),o&&(o=o.clone(),this.flipScaleMatrix(o,a),n.multiplyMatrices(o.getInverse(o),n)),n}}(),THREE.SEA3D.prototype.flipDefaultAnimation=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.Vector3,n=new THREE.Quaternion,r=new THREE.Vector3,o=new THREE.Vector3,a=new THREE.Quaternion,s=new THREE.Vector3;return function(E,p,c){if(!E.isFliped){for(var l=E.dataList,m=[],f=0;f<l.length;f++){var A=l[f],y=A.data,T=A.kind,u=y.length/A.blockSize;switch(T){case SEA3D.Animation.POSITION:case SEA3D.Animation.ROTATION:case SEA3D.Animation.SCALE:m.push({kind:T,numFrames:u,raw:y})}}if(m.length>0){var u=m[0].numFrames,h=void 0;c?(t.identity(),h=this.flipScaleMatrix(e.copy(p.matrixWorld))):(p.parent&&(h=this.flipScaleMatrix(e.copy(p.parent.matrixWorld))),this.flipScaleMatrix(t.copy(p.matrix),!1,h)),t.decompose(i,n,r);for(var R,x,S=0;S<u;S++){for(R=0;R<m.length;R++){var y=m[R].raw,T=m[R].kind;switch(T){case SEA3D.Animation.POSITION:x=3*S,i.set(y[x],y[x+1],y[x+2]);break;case SEA3D.Animation.ROTATION:x=4*S,n.set(y[x],y[x+1],y[x+2],y[x+3]);break;case SEA3D.Animation.SCALE:x=4*S,r.set(y[x],y[x+1],y[x+2])}}for(t.compose(i,n,r),this.flipScaleMatrix(t,!1,e),t.decompose(o,a,s),R=0;R<m.length;R++){var y=m[R].raw,T=m[R].kind;switch(T){case SEA3D.Animation.POSITION:x=3*S,y[x]=o.x,y[x+1]=o.y,y[x+2]=o.z;break;case SEA3D.Animation.ROTATION:x=4*S,y[x]=a.x,y[x+1]=a.y,y[x+2]=a.z,y[x+3]=a.w;break;case SEA3D.Animation.SCALE:x=3*S,y[x]=s.x,y[x+1]=s.y,y[x+2]=s.z}}}}E.isFliped=!0}}}(),THREE.SEA3D.prototype.readAnimation=function(t){this.isLegacy(t)||this._readAnimation(t)},THREE.SEA3D.prototype.getAnimationType=function(t){var e=t.sea;if(this.isLegacy(e))switch(e.type){case SEA3D.SkeletonAnimation.prototype.type:return this.readSkeletonAnimationLegacy(e,t.skeleton),e.tag;case SEA3D.Animation.prototype.type:return t.scope instanceof THREE.Object3D&&this.flipDefaultAnimation(e,t.scope,t.relative),this._readAnimation(e),e.tag}return this._getAnimationType(t)},THREE.SEA3D.prototype.updateTransform=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4;return function(i,n){this.isLegacy(n)?(n.transform?t.elements.set(n.transform):t.makeTranslation(n.position.x,n.position.y,n.position.z),this.flipScaleMatrix(t,!1,i.parent?i.parent.matrixWorld:e,i.parent instanceof THREE.Bone),i.position.setFromMatrixPosition(t),i.scale.setFromMatrixScale(t),t.scale(THREE.SEA3D.VECBUF.set(1/i.scale.x,1/i.scale.y,1/i.scale.z)),i.rotation.setFromRotationMatrix(t),i.updateMatrixWorld()):this._updateTransform(i,n)}}(),THREE.SEA3D.prototype.readSkeleton=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.Matrix4,n=new THREE.Vector3,r=new THREE.Quaternion;return function(o){for(var a=[],s=o.sea3d.config.legacy,E=0;E<o.joint.length;E++){var p=o.joint[E];t.elements=p.inverseBindMatrix,e.getInverse(t),s&&this.flipBoneMatrix(e),p.parentIndex>-1&&(t.elements=o.joint[p.parentIndex].inverseBindMatrix,i.getInverse(t),s&&this.flipBoneMatrix(i),i.getInverse(i),e.multiplyMatrices(i,e)),n.setFromMatrixPosition(e),r.setFromRotationMatrix(e),a[E]={name:p.name,pos:[n.x,n.y,n.z],rotq:[r.x,r.y,r.z,r.w],parent:p.parentIndex}}return o.tag=a}}(),THREE.SEA3D.prototype.readSkeletonAnimationLegacy=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.Matrix4,n=new THREE.Matrix4;return function(r,o){if(r.tag)return r.tag;for(var a=[],s=1e3/r.frameRate/1e3,E=[1,1,1],p=0;p<r.sequence.length;p++){for(var c=r.sequence[p],l=c.start,m=l+c.count,f={name:c.name,repeat:c.repeat,fps:r.frameRate,JIT:0,length:s*c.count,hierarchy:[]},A=r.numJoints,y=r.raw,T=0;T<A;T++){for(var u=o.joint[T],h={parent:u.parentIndex,keys:[]},R=h.keys,x=0,S=l;S<m;S++){var d=S*A*7+7*T;e.makeRotationFromQuaternion(THREE.SEA3D.QUABUF.set(y[d+3],y[d+4],y[d+5],y[d+6])),e.setPosition(THREE.SEA3D.VECBUF.set(y[d],y[d+1],y[d+2])),u.parentIndex>-1?(t.elements=o.joint[u.parentIndex].inverseBindMatrix,n.getInverse(t),i.multiplyMatrices(n,e),this.flipBoneMatrix(i),this.flipBoneMatrix(n),n.getInverse(n),e.multiplyMatrices(n,i)):this.flipBoneMatrix(e);var g=THREE.SEA3D.VECBUF.setFromMatrixPosition(e),H=THREE.SEA3D.QUABUF.setFromRotationMatrix(e);R.push({time:x,pos:[g.x,g.y,g.z],rot:[H.x,H.y,H.z,H.w],scl:E}),x+=s}f.hierarchy[T]=h}a.push(THREE.SEA3D.AnimationClip.fromClip(THREE.AnimationClip.parseAnimation(f,o.tag),c.repeat))}this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[r.name+".anm"]=r.tag=a)}}(),THREE.SEA3D.prototype.readVertexAnimation=function(t){if(this.isLegacy(t))for(var e=0,i=t.frame.length;e<i;e++){var n=t.frame[e];this.flipVec3(n.vertex),this.flipVec3(n.normal)}this._readVertexAnimation(t)},THREE.SEA3D.prototype.readGeometryBuffer=function(t){this.isLegacy(t)&&(this.flipVec3(t.vertex,!0),this.flipVec3(t.normal,!0),this.flipIndexes(t.indexes),t.jointPerVertex>4?this.compressJoints(t):t.jointPerVertex<4&&this.expandJoints(t)),this._readGeometryBuffer(t)},THREE.SEA3D.prototype.readLines=function(t){this.isLegacy(t)&&this.flipVec3(t.vertex),this._readLines(t)},THREE.SEA3D.prototype.onHead=function(t){if("S3D"!=t.sign&&"TJS"!=t.sign)throw new Error("Sign '"+t.sign+"' unknown.")},THREE.SEA3D.EXTENSIONS_LOADER.push({setTypeRead:function(){this.config.legacy=void 0==this.config.legacy||this.config.legacy,this.file.typeRead[SEA3D.Skeleton.prototype.type]=this.readSkeleton}});