THREE.VRMLLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.VRMLLoader.prototype={constructor:THREE.VRMLLoader,isRecordingPoints:!1,isRecordingFaces:!1,points:[],indexes:[],isRecordingAngles:!1,isRecordingColors:!1,angles:[],colors:[],recordingFieldname:null,load:function(e,i,r,s){var o=this,n=new THREE.FileLoader(this.manager);n.load(e,function(e){i(o.parse(e))},r,s)},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e){var i=this.texturePath||"",r=new THREE.TextureLoader(this.manager);r.setCrossOrigin(this.crossOrigin);for(var s=function(e,i){console.warn("VRML V1.0 not supported yet")},o=function(e,s){var o={},n=/(\b|\-|\+)([\d\.e]+)/,t=/([\d\.\+\-e]+)\s+([\d\.\+\-e]+)/g,a=/([\d\.\+\-e]+)\s+([\d\.\+\-e]+)\s+([\d\.\+\-e]+)/g,l=function(e,i,r){var s=e.r-i.r,o=e.g-i.g,n=e.b-i.b,t=new THREE.Color;return t.r=e.r-r*s,t.g=e.g-r*o,t.b=e.b-r*n,t},c=function(e,i,r,s,o){for(var n,t,a,c,d,g,h,f,p=o?1:-1,v=["a","b","c","d"],y=[],u=1,E={},x={},m=!1,R=0;R<r.length;R++){var T={};T.y=p*(Math.cos(r[R])*i),T.x=p*(Math.sin(r[R])*i),y.push(T)}for(var b=0;b<e.faces.length;b++){n=e.faces[b],t=n instanceof THREE.Face3?3:4;for(var F=0;F<t;F++){c=n[v[F]],a=e.vertices[c];for(var w=0;w<s.length;w++)0===w?(E.x=0,E.y=o?i:-1*i):(E.x=y[w-1].x,E.y=y[w-1].y),x=y[w],void 0!==x?(m=o?a.y<=E.y&&a.y>x.y:a.y>=E.y&&a.y<x.y,m&&(h=s[w+1],g=s[w],u=Math.abs(a.y-E.y)/(E.y-x.y),d=l(g,h,u),n.vertexColors[F]=d)):void 0===n.vertexColors[F]&&(f=o?s.length-1:0,n.vertexColors[F]=s[f])}}},d=[],g=function(e,i){for(var r,s,o,l=[],c={},g=/[^\s,\[\]]+/g;null!=(r=g.exec(i));)l.push(r[0]);switch(s=l[0]){case"skyAngle":case"groundAngle":this.recordingFieldname=s,this.isRecordingAngles=!0,this.angles=[];break;case"skyColor":case"groundColor":this.recordingFieldname=s,this.isRecordingColors=!0,this.colors=[];break;case"point":this.recordingFieldname=s,this.isRecordingPoints=!0,this.points=[];break;case"coordIndex":case"texCoordIndex":this.recordingFieldname=s,this.isRecordingFaces=!0,this.indexes=[]}if(this.isRecordingFaces){if(l.length>0)for(var h=0;h<l.length;h++)/(-?\d+)/.test(l[h])&&("-1"===l[h]?(d.length>0&&this.indexes.push(d),d=[]):d.push(parseInt(l[h])));/]/.exec(i)&&(d.length>0&&this.indexes.push(d),d=[],this.isRecordingFaces=!1,e[this.recordingFieldname]=this.indexes)}else if(this.isRecordingPoints){if("Coordinate"==e.nodeType)for(;null!==(l=a.exec(i));)o={x:parseFloat(l[1]),y:parseFloat(l[2]),z:parseFloat(l[3])},this.points.push(o);if("TextureCoordinate"==e.nodeType)for(;null!==(l=t.exec(i));)o={x:parseFloat(l[1]),y:parseFloat(l[2])},this.points.push(o);/]/.exec(i)&&(this.isRecordingPoints=!1,e.points=this.points)}else if(this.isRecordingAngles){if(l.length>0)for(var h=0;h<l.length;h++)n.test(l[h])&&this.angles.push(parseFloat(l[h]));/]/.exec(i)&&(this.isRecordingAngles=!1,e[this.recordingFieldname]=this.angles)}else if(this.isRecordingColors){for(;null!==(l=a.exec(i));)color={r:parseFloat(l[1]),g:parseFloat(l[2]),b:parseFloat(l[3])},this.colors.push(color);/]/.exec(i)&&(this.isRecordingColors=!1,e[this.recordingFieldname]=this.colors)}else if("NULL"!==l[l.length-1]&&"children"!==s){switch(s){case"diffuseColor":case"emissiveColor":case"specularColor":case"color":if(4!=l.length){console.warn("Invalid color format detected for "+s);break}c={r:parseFloat(l[1]),g:parseFloat(l[2]),b:parseFloat(l[3])};break;case"location":case"direction":case"translation":case"scale":case"size":if(4!=l.length){console.warn("Invalid vector format detected for "+s);break}c={x:parseFloat(l[1]),y:parseFloat(l[2]),z:parseFloat(l[3])};break;case"intensity":case"cutOffAngle":case"radius":case"topRadius":case"bottomRadius":case"height":case"transparency":case"shininess":case"ambientIntensity":if(2!=l.length){console.warn("Invalid single float value specification detected for "+s);break}c=parseFloat(l[1]);break;case"rotation":if(5!=l.length){console.warn("Invalid quaternion format detected for "+s);break}c={x:parseFloat(l[1]),y:parseFloat(l[2]),z:parseFloat(l[3]),w:parseFloat(l[4])};break;case"on":case"ccw":case"solid":case"colorPerVertex":case"convex":if(2!=l.length){console.warn("Invalid format detected for "+s);break}c="TRUE"===l[1]}e[s]=c}return c},h=function(e){for(var i,r,s={string:"Scene",children:[]},o=s,n=0;n<e.length;n++){var t="",a=e[n];if(null===(result=/^\s+?$/g.exec(a))&&(a=a.trim(),""!==a)){if(/#/.exec(a)){var l=a.split("#");a=l[0],t=l[1]}if(i=/([^\s]*){1}(?:\s+)?{/.exec(a)){var c={nodeType:i[1],string:a,parent:o,children:[],comment:t};o.children.push(c),o=c,/}/.exec(a)&&(r=/{(.*)}/.exec(a)[1],c.children.push(r),g(o,r),o=o.parent)}else/}/.exec(a)?o=o.parent:""!==a&&(g(o,a),o.children.push(a))}}return s},f=function(e,n){if("string"!=typeof e){var t=n;if(e.string.indexOf("AmbientLight")>-1&&"PointLight"==e.nodeType&&(e.nodeType="AmbientLight"),l_visible=e.on,void 0==l_visible&&(l_visible=!0),l_intensity=e.intensity,void 0==l_intensity&&(l_intensity=!0),void 0!=e.color?l_color=new THREE.Color(e.color.r,e.color.g,e.color.b):l_color=new THREE.Color(0,0,0),"AmbientLight"===e.nodeType)t=new THREE.AmbientLight(l_color.getHex(),l_intensity),t.visible=l_visible,n.add(t);else if("PointLight"===e.nodeType)l_distance=0,l_decay=0,void 0!=e.radius&&e.radius<1e3&&(l_distance=e.radius,l_decay=1),t=new THREE.PointLight(l_color.getHex(),l_intensity,l_distance),t.visible=l_visible,n.add(t);else if("SpotLight"===e.nodeType)l_intensity=1,l_distance=0,l_angle=Math.PI/3,l_penumbra=0,l_decay=0,l_visible=!0,void 0!=e.radius&&e.radius<1e3&&(l_distance=e.radius,l_decay=1),void 0!=e.cutOffAngle&&(l_angle=e.cutOffAngle),t=new THREE.SpotLight(l_color.getHex(),l_intensity,l_distance,l_angle,l_penumbra,l_decay),t.visible=l_visible,n.add(t);else if("Transform"===e.nodeType||"Group"===e.nodeType){if(t=new THREE.Object3D,/DEF/.exec(e.string)&&(t.name=/DEF\s+([^\s]+)/.exec(e.string)[1],o[t.name]=t),void 0!==e.translation){var a=e.translation;t.position.set(a.x,a.y,a.z)}if(void 0!==e.rotation){var l=e.rotation;t.quaternion.setFromAxisAngle(new THREE.Vector3(l.x,l.y,l.z),l.w)}if(void 0!==e.scale){var d=e.scale;t.scale.set(d.x,d.y,d.z)}n.add(t)}else if("Shape"===e.nodeType)t=new THREE.Mesh,/DEF/.exec(e.string)&&(t.name=/DEF\s+([^\s]+)/.exec(e.string)[1],o[t.name]=t),n.add(t);else if("Background"===e.nodeType){var g=20,h=2e4,p=new THREE.SphereGeometry(h,g,g),v=new THREE.MeshBasicMaterial({fog:!1,side:THREE.BackSide});if(e.skyColor.length>1)c(p,h,e.skyAngle,e.skyColor,!0),v.vertexColors=THREE.VertexColors;else{var y=e.skyColor[0];v.color.setRGB(y.r,y.b,y.g)}if(s.add(new THREE.Mesh(p,v)),void 0!==e.groundColor){h=12e3;var u=new THREE.SphereGeometry(h,g,g,0,2*Math.PI,.5*Math.PI,1.5*Math.PI),E=new THREE.MeshBasicMaterial({fog:!1,side:THREE.BackSide,vertexColors:THREE.VertexColors});c(u,h,e.groundAngle,e.groundColor,!1),s.add(new THREE.Mesh(u,E))}}else{if(/geometry/.exec(e.string)){if("Box"===e.nodeType){var d=e.size;n.geometry=new THREE.BoxGeometry(d.x,d.y,d.z)}else if("Cylinder"===e.nodeType)n.geometry=new THREE.CylinderGeometry(e.radius,e.radius,e.height);else if("Cone"===e.nodeType)n.geometry=new THREE.CylinderGeometry(e.topRadius,e.bottomRadius,e.height);else if("Sphere"===e.nodeType)n.geometry=new THREE.SphereGeometry(e.radius);else if("IndexedFaceSet"===e.nodeType){for(var x,m,R,T=new THREE.Geometry,b=0,F=e.children.length;b<F;b++){var w,C=e.children[b];if("TextureCoordinate"===C.nodeType&&(R=C.points),"Coordinate"===C.nodeType){if(C.points)for(var H=0,_=C.points.length;H<_;H++){var M=C.points[H];w=new THREE.Vector3(M.x,M.y,M.z),T.vertices.push(w)}if(C.string.indexOf("DEF")>-1){var k=/DEF\s+([^\s]+)/.exec(C.string)[1];o[k]=T.vertices}if(C.string.indexOf("USE")>-1){var L=/USE\s+([^\s]+)/.exec(C.string)[1];T.vertices=o[L]}}}var I=0;if(e.coordIndex)for(var b=0,F=e.coordIndex.length;b<F;b++)for(x=e.coordIndex[b],e.texCoordIndex&&(m=e.texCoordIndex[b]),I=0;x.length>=3&&I<x.length-2;){var S=new THREE.Face3(x[0],x[I+(e.ccw?1:2)],x[I+(e.ccw?2:1)],null);R&&m&&T.faceVertexUvs[0].push([new THREE.Vector2(R[m[0]].x,R[m[0]].y),new THREE.Vector2(R[m[I+(e.ccw?1:2)]].x,R[m[I+(e.ccw?1:2)]].y),new THREE.Vector2(R[m[I+(e.ccw?2:1)]].x,R[m[I+(e.ccw?2:1)]].y)]),I++,T.faces.push(S)}else n.parent.remove(n);!1===e.solid&&(n.material.side=THREE.DoubleSide),T.solid=e.solid,T.computeFaceNormals(),T.computeBoundingSphere(),/DEF/.exec(e.string)&&(T.name=/DEF ([^\s]+)/.exec(e.string)[1],o[T.name]=T),n.geometry=T}return}if(/appearance/.exec(e.string)){for(var b=0;b<e.children.length;b++){var C=e.children[b];if("Material"===C.nodeType){var A=new THREE.MeshPhongMaterial;if(void 0!==C.diffuseColor){var V=C.diffuseColor;A.color.setRGB(V.r,V.g,V.b)}if(void 0!==C.emissiveColor){var D=C.emissiveColor;A.emissive.setRGB(D.r,D.g,D.b)}if(void 0!==C.specularColor){var d=C.specularColor;A.specular.setRGB(d.r,d.g,d.b)}if(void 0!==C.transparency){var a=C.transparency;A.opacity=Math.abs(1-a),A.transparent=!0}/DEF/.exec(e.string)&&(A.name=/DEF ([^\s]+)/.exec(e.string)[1],o[A.name]=A),n.material=A}if("ImageTexture"===C.nodeType){var O=/"([^"]+)"/.exec(C.children[0]);O&&(n.material.name=O[1],n.material.map=r.load(i+O[1]))}}return}}for(var b=0,_=e.children.length;b<_;b++){var C=e.children[b];f(e.children[b],t)}}else if(/USE/.exec(e)){var L=/USE\s+?([^\s]+)/.exec(e)[1];if(void 0==o[L])console.warn(L+" is not defined.");else if(/appearance/.exec(e)&&L)n.material=o[L].clone();else if(/geometry/.exec(e)&&L)n.geometry=o[L].clone(),void 0!==o[L].solid&&o[L].solid===!1&&(n.geometry.solid=!1,n.material.side=THREE.DoubleSide);else if(L){var t=o[L].clone();n.add(t)}}};f(h(e),s)},n=new THREE.Scene,t=e.split("\n"),a=t.length-1;a>-1;a--){if(/{.*[{\[]/.test(t[a])){var l=t[a].split("{").join("{\n").split("\n");l.unshift(1),l.unshift(a),t.splice.apply(t,l)}else if(/\].*}/.test(t[a])){var l=t[a].split("]").join("]\n").split("\n");l.unshift(1),l.unshift(a),t.splice.apply(t,l)}if(/}.*}/.test(t[a])){var l=t[a].split("}").join("}\n").split("\n");l.unshift(1),l.unshift(a),t.splice.apply(t,l)}t[a].indexOf("coord")>-1&&t[a].indexOf("[")<0&&t[a].indexOf("{")<0&&(t[a]+=" Coordinate {}")}var c=t.shift();return/V1.0/.exec(c)?s(t,n):/V2.0/.exec(c)&&o(t,n),n}};