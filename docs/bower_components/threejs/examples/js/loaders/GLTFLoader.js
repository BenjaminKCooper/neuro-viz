THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function r(){var e={};return{get:function(r){return e[r]},add:function(r,t){e[r]=t},remove:function(r){delete e[r]},removeAll:function(){e={}},update:function(r,t){for(var a in e){var n=e[a];n.update&&n.update(r,t)}}}}function t(e,r){var t={},a=e.material.uniforms;for(var n in a){var i=a[n];if(i.semantic){var s=i.node,o=e;s&&(o=r[s]),t[n]={semantic:i.semantic,sourceNode:o,targetNode:e,uniform:i}}}this.boundUniforms=t,this._m4=new THREE.Matrix4}function a(e,r){for(var t=[],a=0,n=r.length;a<n;a++){var i=r[a];i.times=THREE.AnimationUtils.arraySlice(i.times,0),i.values=THREE.AnimationUtils.arraySlice(i.values,0),i.target.updateMatrix(),i.target.matrixAutoUpdate=!0,t.push(new THREE.KeyframeTrack(i.name,i.times,i.values,i.type))}return new THREE.AnimationClip(e,void 0,t)}function n(e,r,t){if(!e)return Promise.resolve();var a,n=[];if("[object Array]"===Object.prototype.toString.call(e)){a=[];for(var i=e.length,s=0;s<i;s++){var o=r.call(t||this,e[s],s);o&&(n.push(o),o instanceof Promise?o.then(function(e,r){a[s]=r}.bind(this,c)):a[s]=o)}}else{a={};for(var c in e)if(e.hasOwnProperty(c)){var o=r.call(t||this,e[c],c);o&&(n.push(o),o instanceof Promise?o.then(function(e,r){a[e]=r}.bind(this,c)):a[c]=o)}}return Promise.all(n).then(function(){return a})}function i(e,r){return"string"!=typeof e||""===e?"":/^https?:\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:(r||"")+e}function s(e,r){var t={};for(var a in r.attributes){var n=r.attributes[a],i=r.parameters[n],s=i.type,o=i.semantic;t[a]={type:s,semantic:o}}var c=r.parameters,u=r.attributes,f={};for(var a in t){var n=u[a],p=c[n],o=p.semantic;o&&(f[a]=p)}for(var n in f){var i=f[n],o=i.semantic,m=new RegExp("\\b"+n+"\\b","g");switch(o){case"POSITION":e=e.replace(m,"position");break;case"NORMAL":e=e.replace(m,"normal");break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":e=e.replace(m,"uv");break;case"WEIGHT":e=e.replace(m,"skinWeight");break;case"JOINT":e=e.replace(m,"skinIndex")}}return e}function o(e){this.isDeferredShaderMaterial=!0,this.params=e}function c(e,t){this.json=e||{},this.options=t||{},this.cache=new r}e.prototype={constructor:e,load:function(e,r,t,a){var n=this,i=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),s=new THREE.FileLoader(n.manager);s.load(e,function(e){n.parse(JSON.parse(e),r,i)},t,a)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,r,t){console.time("GLTFLoader");var a=new c(e,{path:t||this.path,crossOrigin:!!this.crossOrigin});a.parse(function(e,t,a){console.timeEnd("GLTFLoader");var n={scene:e,cameras:t,animations:a};r(n)})}},e.Shaders=new r,t.prototype.update=function(e,r){e.updateMatrixWorld(),r.updateMatrixWorld(),r.matrixWorldInverse.getInverse(r.matrixWorld);var t=this.boundUniforms;for(var a in t){var n=t[a];switch(n.semantic){case"MODELVIEW":var i=n.uniform.value;i.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=n.uniform.value;this._m4.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld),s.getNormalMatrix(this._m4);break;case"PROJECTION":var i=n.uniform.value;i.copy(r.projectionMatrix);break;case"JOINTMATRIX":for(var o=n.uniform.value,c=0;c<o.length;c++)o[c].getInverse(n.sourceNode.matrixWorld).multiply(n.targetNode.skeleton.bones[c].matrixWorld).multiply(n.targetNode.skeleton.boneInverses[c]).multiply(n.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+n.semantic)}}},e.Animations={update:function(){console.warn("THREE.GLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var u={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},f={5126:Number,35675:THREE.Matrix3,35676:THREE.Matrix4,35664:THREE.Vector2,35665:THREE.Vector3,35666:THREE.Vector4,35678:THREE.Texture},p={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},m={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},l={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},d={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},h={scale:"scale",translation:"position",rotation:"quaternion"},v={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete};return o.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var r in this.params.uniforms){var t=this.params.uniforms[r];t.value instanceof THREE.Texture&&(e[r].value=t.value,e[r].value.needsUpdate=!0),e[r].semantic=t.semantic,e[r].node=t.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},c.prototype._withDependencies=function(e){for(var r={},t=0;t<e.length;t++){var a=e[t],i="load"+a.charAt(0).toUpperCase()+a.slice(1),s=this.cache.get(a);if(void 0!==s)r[a]=s;else if(this[i]){var o=this[i]();this.cache.add(a,o),r[a]=o}}return n(r,function(e){return e})},c.prototype.parse=function(e){var r=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(t){var a=t.scenes[r.scene],n=[];for(var i in t.cameras){var s=t.cameras[i];n.push(s)}var o=[];for(var i in t.animations)o.push(t.animations[i]);e(a,n,o)})},c.prototype.loadShaders=function(){var e=this.json,r=this.options;return n(e.shaders,function(e){return new Promise(function(t){var a=new THREE.FileLoader;a.responseType="text",a.load(i(e.uri,r.path),function(e){t(e)})})})},c.prototype.loadBuffers=function(){var e=this.json,r=this.options;return n(e.buffers,function(e){if("arraybuffer"===e.type)return new Promise(function(t){var a=new THREE.FileLoader;a.responseType="arraybuffer",a.load(i(e.uri,r.path),function(e){t(e)})})})},c.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(r){return n(e.bufferViews,function(e){var t=r.buffers[e.buffer];return t.slice(e.byteOffset,e.byteOffset+e.byteLength)})})},c.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(r){return n(e.accessors,function(e){var t=r.bufferViews[e.bufferView],a=d[e.type],n=p[e.componentType],i=n.BYTES_PER_ELEMENT,s=i*a;if(e.byteStride&&e.byteStride!==s){var o=new n(t),c=new THREE.InterleavedBuffer(o,e.byteStride/i);return new THREE.InterleavedBufferAttribute(c,a,e.byteOffset/i)}return o=new n(t,e.byteOffset,e.count*a),new THREE.BufferAttribute(o,a)})})},c.prototype.loadTextures=function(){var e=this.json,r=this.options;return n(e.textures,function(t){if(t.source)return new Promise(function(a){var n=e.images[t.source],s=THREE.Loader.Handlers.get(n.uri);null===s&&(s=new THREE.TextureLoader),s.crossOrigin=r.crossOrigin||!1,s.load(i(n.uri,r.path),function(r){if(r.flipY=!1,t.sampler){var n=e.samplers[t.sampler];r.magFilter=m[n.magFilter],r.minFilter=m[n.minFilter],r.wrapS=l[n.wrapS],r.wrapT=l[n.wrapT]}a(r)},void 0,function(){a()})})})},c.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(r){return n(e.materials,function(t){var a,n,i={},c={};if(t.extensions&&t.extensions.KHR_materials_common?n=t.extensions.KHR_materials_common:e.extensions&&e.extensions.KHR_materials_common&&(n=e.extensions.KHR_materials_common),n){switch(n.technique){case"BLINN":case"PHONG":a=THREE.MeshPhongMaterial;break;case"LAMBERT":a=THREE.MeshLambertMaterial;break;case"CONSTANT":default:a=THREE.MeshBasicMaterial}Object.assign(i,n.values),(n.doubleSided||i.doubleSided)&&(c.side=THREE.DoubleSide),(n.transparent||i.transparent)&&(c.transparent=!0,c.opacity=void 0!==i.transparency?i.transparency:1)}else if(void 0===t.technique)a=THREE.MeshPhongMaterial,Object.assign(i,t.values);else{a=o;var p=e.techniques[t.technique];c.uniforms={};var m=e.programs[p.program];if(m){c.fragmentShader=r.shaders[m.fragmentShader],c.fragmentShader||(console.warn("ERROR: Missing fragment shader definition:",m.fragmentShader),a=THREE.MeshPhongMaterial);var l=r.shaders[m.vertexShader];l||(console.warn("ERROR: Missing vertex shader definition:",m.vertexShader),a=THREE.MeshPhongMaterial),c.vertexShader=s(l,p);var d=p.uniforms;for(var h in d){var v=d[h],E=p.parameters[v],T=E.type;if(!f[T])throw new Error("Unknown shader uniform param type: "+T);var R=E.count,y=t.values[v],w=new f[T],A=E.semantic,g=E.node;switch(T){case u.FLOAT:w=E.value,"transparency"==v&&(c.transparent=!0),void 0!==y&&(w=y);break;case u.FLOAT_VEC2:case u.FLOAT_VEC3:case u.FLOAT_VEC4:case u.FLOAT_MAT3:E&&E.value&&w.fromArray(E.value),y&&w.fromArray(y);break;case u.FLOAT_MAT2:console.warn("FLOAT_MAT2 is not a supported uniform type");break;case u.FLOAT_MAT4:if(R){w=new Array(R);for(var H=0;H<R;H++)w[H]=new f[T];if(E&&E.value){var b=E.value;w.fromArray(b)}y&&w.fromArray(y)}else{if(E&&E.value){var M=E.value;w.fromArray(M)}y&&w.fromArray(y)}break;case u.SAMPLER_2D:w=y?r.textures[y]:null}c.uniforms[h]={value:w,semantic:A,node:g}}}}Array.isArray(i.diffuse)?c.color=(new THREE.Color).fromArray(i.diffuse):"string"==typeof i.diffuse&&(c.map=r.textures[i.diffuse]),delete c.diffuse,"string"==typeof i.reflective&&(c.envMap=r.textures[i.reflective]),"string"==typeof i.bump&&(c.bumpMap=r.textures[i.bump]),Array.isArray(i.emission)?a===THREE.MeshBasicMaterial?c.color=(new THREE.Color).fromArray(i.emission):c.emissive=(new THREE.Color).fromArray(i.emission):"string"==typeof i.emission&&(a===THREE.MeshBasicMaterial?c.map=r.textures[i.emission]:c.emissiveMap=r.textures[i.emission]),Array.isArray(i.specular)?c.specular=(new THREE.Color).fromArray(i.specular):"string"==typeof i.specular&&(c.specularMap=r.textures[i.specular]),void 0!==i.shininess&&(c.shininess=i.shininess);var x=new a(c);return x.name=t.name,x})})},c.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(r){return n(e.meshes,function(e){var t=new THREE.Object3D;t.name=e.name;var a=e.primitives;for(var n in a){var i=a[n];if(i.mode===u.TRIANGLES||void 0===i.mode){var s=new THREE.BufferGeometry,o=i.attributes;for(var c in o){var f=o[c];if(!f)return;var p=r.accessors[f];switch(c){case"POSITION":s.addAttribute("position",p);break;case"NORMAL":s.addAttribute("normal",p);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":s.addAttribute("uv",p);break;case"WEIGHT":s.addAttribute("skinWeight",p);break;case"JOINT":s.addAttribute("skinIndex",p)}}if(i.indices){var m=r.accessors[i.indices];s.setIndex(m);var l={start:0,index:0,count:m.count};s.groups.push(l),s.computeBoundingSphere()}var d=r.materials[i.material],h=new THREE.Mesh(s,d);h.castShadow=!0,t.add(h)}else console.warn("Non-triangular primitives are not supported")}return t})})},c.prototype.loadCameras=function(){var e=this.json;return n(e.cameras,function(e){if("perspective"==e.type&&e.perspective){var r=e.perspective.yfov,t=e.perspective.xfov,a=e.perspective.aspect_ratio||1;t=void 0===t&&r?r*a:t;var n=new THREE.PerspectiveCamera(THREE.Math.radToDeg(t),a,e.perspective.znear||1,e.perspective.zfar||2e6);return n.name=e.name,n}if("orthographic"==e.type&&e.orthographic){var n=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return n.name=e.name,n}})},c.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(r){return n(e.skins,function(e){var t={bindShapeMatrix:(new THREE.Matrix4).fromArray(e.bindShapeMatrix),jointNames:e.jointNames,inverseBindMatrices:r.accessors[e.inverseBindMatrices]};return t})})},c.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(r){return n(e.animations,function(e,t){var n=[];for(var i in e.channels){var s=e.channels[i],o=e.samplers[s.sampler];if(o&&e.parameters){var c=s.target,u=c.id,f=e.parameters[o.input],p=e.parameters[o.output],m=r.accessors[f],l=r.accessors[p],d=r.nodes[u];if(d){var E={times:m.array,values:l.array,target:d,type:v[o.interpolation],name:d.name+"."+h[c.path]};n.push(E)}}}return a("animation_"+t,n)})})},c.prototype.loadNodes=function(){var e=this.json,r=this;return n(e.nodes,function(e){var r,t=new THREE.Matrix4;return e.jointName?(r=new THREE.Bone,r.jointName=e.jointName):r=new THREE.Object3D,r.name=e.name,r.matrixAutoUpdate=!1,void 0!==e.matrix?(t.fromArray(e.matrix),r.applyMatrix(t)):(void 0!==e.translation&&r.position.fromArray(e.translation),void 0!==e.rotation&&r.quaternion.fromArray(e.rotation),void 0!==e.scale&&r.scale.fromArray(e.scale)),r}).then(function(t){return r._withDependencies(["meshes","skins","cameras","extensions"]).then(function(r){return n(t,function(a,n){var i=e.nodes[n];if(void 0!==i.meshes)for(var s in i.meshes){var o=i.meshes[s],c=r.meshes[o];for(var u in c.children){var f,p=c.children[u],m=p.material,l=p.geometry;m.isDeferredShaderMaterial?m=f=m.create():f=m,p=new THREE.Mesh(l,f),p.castShadow=!0;var d;if(i.skin&&(d=r.skins[i.skin]),d){var h=l,f=m;f.skinning=!0,p=new THREE.SkinnedMesh(h,f,!1),p.castShadow=!0;for(var v=[],E=[],T=Object.keys(t),R=0,y=d.jointNames.length;R<y;R++){for(var w,A=d.jointNames[R],g=0,H=T.length;g<H;g++){var b=t[T[g]];if(b.jointName===A){w=b;break}}if(w){w.skin=p,v.push(w);var M=d.inverseBindMatrices.array,x=(new THREE.Matrix4).fromArray(M,16*R);E.push(x)}else console.warn("WARNING: joint: ''"+A+"' could not be found")}p.bind(new THREE.Skeleton(v,E,!1),d.bindShapeMatrix)}a.add(p)}}if(void 0!==i.camera){var O=r.cameras[i.camera];a.add(O)}if(i.extensions&&i.extensions.KHR_materials_common&&i.extensions.KHR_materials_common.light){var S=r.extensions.KHR_materials_common.lights[i.extensions.KHR_materials_common.light];a.add(S)}return a})})})},c.prototype.loadExtensions=function(){var e=this.json;return n(e.extensions,function(e,r){switch(r){case"KHR_materials_common":var t={lights:{}},a=e.lights;for(var n in a){var i,s=a[n],o=s[s.type],c=(new THREE.Color).fromArray(o.color);switch(s.type){case"directional":i=new THREE.DirectionalLight(c),i.position.set(0,0,1);break;case"point":i=new THREE.PointLight(c);break;case"spot ":i=new THREE.SpotLight(c),i.position.set(0,0,1);break;case"ambient":i=new THREE.AmbientLight(c)}i&&(t.lights[n]=i)}return t}})},c.prototype.loadScenes=function(){function r(e,t,n){var i=n[e];t.add(i);var s=a.nodes[e];if(s.children)for(var o=s.children,c=0,u=o.length;c<u;c++){var f=o[c];r(f,i,n)}}var a=this.json;return this._withDependencies(["nodes"]).then(function(i){return n(a.scenes,function(a){var n=new THREE.Scene;n.name=a.name;for(var s=a.nodes,o=0,c=s.length;o<c;o++){var u=s[o];r(u,n,i.nodes)}return n.traverse(function(r){if(r.material&&r.material.isRawShaderMaterial){var a=new t(r,i.nodes);e.Shaders.add(r.uuid,a)}}),n})})},e}();