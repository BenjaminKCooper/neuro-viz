THREE.ThreeMFLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.availableExtensions=[]},THREE.ThreeMFLoader.prototype={constructor:THREE.ThreeMFLoader,load:function(e,t,r,n){var a=this,o=new THREE.FileLoader(a.manager);o.setResponseType("arraybuffer"),o.load(e,function(e){t(a.parse(e))},r,n)},parse:function(e){function t(e){var t,n,a=new DataView(e),o=null,i=null,l=[],s=[],u=[],g=[],f={},p={},v={},d={};try{o=new JSZip(e)}catch(e){if(e instanceof ReferenceError)return console.log("\tjszip missing and file is compressed."),null}for(i in o.files)i.match(/\.rels$/)?t=i:i.match(/^3D\/.*\.model$/)?l.push(i):i.match(/^3D\/Metadata\/.*\.xml$/)?s.push(i):i.match(/^3D\/Textures\/.*/)?u.push(i):i.match(/^3D\/Other\/.*/)&&g.push(i);var h=new DataView(o.file(t).asArrayBuffer()),b=new TextDecoder("utf-8").decode(h);n=r(b);for(var m=0;m<l.length;m++){var E=l[m];if(a=new DataView(o.file(E).asArrayBuffer()),void 0===TextDecoder)return console.log("\tTextDecoder not present.\tPlease use TextDecoder polyfill."),null;var A=new TextDecoder("utf-8").decode(a),y=(new DOMParser).parseFromString(A,"application/xml");"model"!==y.documentElement.nodeName.toLowerCase()&&console.log("\tError loading 3MF - no 3MF document found: "+E);for(var x=y.querySelector("model"),T={},m=0;m<x.attributes.length;m++){var w=x.attributes[m];w.name.match(/^xmlns:(.+)$/)&&(T[w.value]=RegExp.$1)}var R=c(x);R.xml=x,0<Object.keys(T).length&&(R.extensions=T),f[E]=R}for(var m=0;m<u.length;m++){var D=u[m];v[D]=o.file(D).asBinary()}return{rels:n,model:f,printTicket:p,texture:v,other:d}}function r(e){var t=(new DOMParser).parseFromString(e,"application/xml"),r=t.querySelector("Relationship"),n=r.getAttribute("Target"),a=r.getAttribute("Id"),o=r.getAttribute("Type");return{target:n,id:a,type:o}}function n(e){for(var t={},r=0;r<e.length;r++){var n=e[r],a=n.getAttribute("name"),o=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"];0<=o.indexOf(a)&&(t[a]=n.textContent)}return t}function a(e){}function o(e,t){for(var r={},n=[],a=e.querySelectorAll("vertices vertex"),o=0;o<a.length;o++){var i=a[o],l=i.getAttribute("x"),s=i.getAttribute("y"),u=i.getAttribute("z");n.push(parseFloat(l),parseFloat(s),parseFloat(u))}r.vertices=new Float32Array(n.length);for(var o=0;o<n.length;o++)r.vertices[o]=n[o];for(var c=[],g=[],f=e.querySelectorAll("triangles triangle"),o=0;o<f.length;o++){var p=f[o],v=p.getAttribute("v1"),d=p.getAttribute("v2"),h=p.getAttribute("v3"),b=p.getAttribute("p1"),m=p.getAttribute("p2"),E=p.getAttribute("p3"),A=p.getAttribute("pid");g.push(parseInt(v,10),parseInt(d,10),parseInt(h,10));var y={};b&&(y.p1=parseInt(b,10)),m&&(y.p2=parseInt(m,10)),E&&(y.p3=parseInt(E,10)),A&&(y.pid=A),0<Object.keys(y).length&&c.push(y)}r.triangleProperties=c,r.triangles=new Uint32Array(g.length);for(var o=0;o<g.length;o++)r.triangles[o]=g[o];return r}function i(e){}function l(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var n=e.getAttribute("pid");n&&(t.pid=n);var a=e.getAttribute("pindex");a&&(t.pindex=a);var l=e.getAttribute("thumbnail");l&&(t.thumbnail=l);var s=e.getAttribute("partnumber");s&&(t.partnumber=s);var u=e.getAttribute("name");u&&(t.name=u);var c=e.querySelector("mesh");c&&(t.mesh=o(c));var g=e.querySelector("components");return g&&(t.components=i(g)),t}function s(e){var t={},r=e.querySelector("basematerials");r&&(t.basematerial=a(r)),t.object={};for(var n=e.querySelectorAll("object"),o=0;o<n.length;o++){var i=n[o],s=l(i);t.object[s.id]=s}return t}function u(e){for(var t=[],r=e.querySelectorAll("item"),n=0;n<r.length;n++){var a=r[n],o={objectid:a.getAttribute("objectid")},i=a.getAttribute("transform");if(i){var l=[];i.split(" ").forEach(function(e){l.push(parseFloat(e))});var s=new THREE.Matrix4;o.transform=s.set(l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,l[9],l[10],l[11],1)}t.push(o)}return t}function c(e){var t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=n(r));var a=e.querySelector("resources");a&&(t.resources=s(a));var o=e.querySelector("build");return o&&(t.build=u(o)),t}function g(e,t){var r=new THREE.BufferGeometry;r.setIndex(new THREE.BufferAttribute(e.triangles,1)),r.addAttribute("position",new THREE.BufferAttribute(e.vertices,3)),e.colors&&r.addAttribute("color",new THREE.BufferAttribute(e.colors,3)),r.computeBoundingSphere();var n={shading:THREE.FlatShading};e.colors&&0<e.colors.length?n.vertexColors=THREE.VertexColors:n.color=11184895;var a=new THREE.MeshPhongMaterial(n);return new THREE.Mesh(r,a)}function f(e,t,r,n){if(e){for(var a=[],o=Object.keys(e),i=0;i<o.length;i++)for(var l=o[i],s=0;s<d.availableExtensions.length;s++){var u=d.availableExtensions[s];u.ns===l&&a.push(u)}for(var i=0;i<a.length;i++){var u=a[i];u.apply(r,e[u.ns],t)}}}function p(e){for(var t=e.model,r={},n=Object.keys(t),a=0;a<n.length;a++)for(var o=n[a],i=t[o],l=i.xml,s=i.extensions,u=Object.keys(i.resources.object),c=0;c<u.length;c++){var p=u[c],v=i.resources.object[p],d=v.mesh;f(s,d,l,e),r[p]=g(d,e)}return r}function v(e,t,r){for(var n=new THREE.Group,a=r.model[t.target.substring(1)].build,o=0;o<a.length;o++){var i=a[o],l=e[i.objectid];i.transform&&l.geometry.applyMatrix(i.transform),n.add(l)}return n}var d=this,h=t(e),b=p(h);return v(b,h.rels,h)},addExtension:function(e){this.availableExtensions.push(e)}};