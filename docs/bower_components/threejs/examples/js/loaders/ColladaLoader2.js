THREE.ColladaLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,load:function(e,t,a,r){var n=this,i=new THREE.FileLoader(n.manager);i.load(e,function(e){t(n.parse(e))},a,r)},options:{set convertUpAxis(e){console.log("ColladaLoder.options.convertUpAxis: TODO")}},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e){function t(e,t){for(var a=[],r=e.childNodes,n=0,i=r.length;n<i;n++){var o=r[n];o.nodeName===t&&a.push(o)}return a}function a(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),a=new Array(t.length),r=0,n=t.length;r<n;r++)a[r]=parseFloat(t[r]);return a}function r(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),a=new Array(t.length),r=0,n=t.length;r<n;r++)a[r]=parseInt(t[r]);return a}function n(e){return e.substring(1)}function i(e){return{unit:o(t(e,"unit")[0]),upAxis:s(t(e,"up_axis")[0])}}function o(e){return void 0!==e?parseFloat(e.getAttribute("meter")):1}function s(e){return void 0!==e?e.textContent:"Y_UP"}function c(e,a,r,n){var i=t(e,a)[0];if(void 0!==i)for(var o=t(i,r),s=0;s<o.length;s++)n(o[s])}function l(e,t){for(var a in e){var r=e[a];r.build=t(e[a])}}function d(e,t){return void 0!==e.build?e.build:(e.build=t(e),e.build)}function u(e){var a={init_from:t(e,"init_from")[0].textContent};de.images[e.getAttribute("id")]=a}function f(e){return void 0!==e.build?e.build:new Image}function h(e){return d(de.images[e],f)}function m(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"profile_COMMON":t.profile=p(n)}}de.effects[e.getAttribute("id")]=t}function p(e){for(var t={surfaces:{},samplers:{}},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"newparam":v(n,t);break;case"technique":t.technique=N(n)}}return t}function v(e,t){for(var a=e.getAttribute("sid"),r=0,n=e.childNodes.length;r<n;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"surface":t.surfaces[a]=g(i);break;case"sampler2D":t.samplers[a]=b(i)}}}function g(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"init_from":t.init_from=n.textContent}}return t}function b(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"source":t.source=n.textContent}}return t}function N(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=n.nodeName,t.parameters=E(n)}}return t}function E(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"emission":case"diffuse":case"specular":case"shininess":case"transparent":case"transparency":t[n.nodeName]=w(n)}}return t}function w(e){for(var t={},r=0,n=e.childNodes.length;r<n;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"color":t[i.nodeName]=a(i.textContent);break;case"float":t[i.nodeName]=parseFloat(i.textContent);break;case"texture":t[i.nodeName]={id:i.getAttribute("texture"),extra:y(i)}}}return t}function y(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"extra":t=T(n)}}return t}function T(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"technique":t[n.nodeName]=A(n)}}return t}function A(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":t[n.nodeName]=parseInt(n.textContent)}}return t}function C(e){return e}function x(e){return d(de.effects[e],C)}function R(e){for(var t={name:e.getAttribute("name")},a=0,r=e.childNodes.length;a<r;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"instance_effect":t.url=n(i.getAttribute("url"))}}de.materials[e.getAttribute("id")]=t}function k(e){function t(e){var t=r.profile.samplers[e.id];if(void 0!==t){var a=r.profile.surfaces[t.source],n=new THREE.Texture(h(a.init_from)),i=e.extra;if(void 0!==i&&void 0!==i.technique){var o=i.technique;n.wrapS=o.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.wrapT=o.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.offset.set(o.offsetU,o.offsetV),n.repeat.set(o.repeatU,o.repeatV)}else n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping;return n.needsUpdate=!0,n}return console.error("ColladaLoder: Undefined sampler",e.id),null}var a,r=x(e.url),n=r.profile.technique;switch(n.type){case"phong":case"blinn":a=new THREE.MeshPhongMaterial;break;case"lambert":a=new THREE.MeshLambertMaterial;break;default:a=new THREE.MeshBasicMaterial}a.name=e.name;var i=n.parameters;for(var o in i){var s=i[o];switch(o){case"diffuse":s.color&&a.color.fromArray(s.color),s.texture&&(a.map=t(s.texture));break;case"specular":s.color&&a.specular&&a.specular.fromArray(s.color);break;case"shininess":s.float&&a.shininess&&(a.shininess=s.float);break;case"emission":s.color&&a.emissive&&a.emissive.fromArray(s.color);break;case"transparent":a.transparent=!0;break;case"transparency":void 0!==s.float&&(a.opacity=s.float),a.transparent=!0}}return a}function H(e){return d(de.materials[e],k)}function _(e){for(var t={name:e.getAttribute("name")},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"optics":t.optics=L(n)}}de.cameras[e.getAttribute("id")]=t}function L(e){for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];switch(a.nodeName){case"technique_common":return M(a)}}return{}}function M(e){for(var t={},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];switch(r.nodeName){case"perspective":case"orthographic":t.technique=r.nodeName,t.parameters=O(r)}}return t}function O(e){for(var t={},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];switch(r.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[r.nodeName]=parseFloat(r.textContent)}}return t}function q(e){var t;switch(e.optics.technique){case"perspective":t=new THREE.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":t=new THREE.OrthographicCamera;break;default:t=new THREE.PerspectiveCamera}return t.name=e.name,t}function P(e){return d(de.cameras[e],q)}function U(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"technique_common":t=F(n)}}de.lights[e.getAttribute("id")]=t}function F(e){for(var t={},a=0,r=e.childNodes.length;a<r;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=n.nodeName,t.parameters=S(n)}}return t}function S(e){for(var t={},r=0,n=e.childNodes.length;r<n;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"color":var o=a(i.textContent);t.color=(new THREE.Color).fromArray(o);break;case"falloff_angle":t.falloffAngle=parseFloat(i.textContent);break;case"quadratic_attenuation":var s=parseFloat(i.textContent);t.distance=s?Math.sqrt(1/s):0}}return t}function D(e){var t;switch(e.technique){case"directional":t=new THREE.DirectionalLight;break;case"point":t=new THREE.PointLight;break;case"spot":t=new THREE.SpotLight;break;case"ambient":t=new THREE.AmbientLight}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function V(e){return d(de.lights[e],D)}function B(e){for(var a={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=t(e,"mesh")[0],n=0;n<r.childNodes.length;n++){var i=r.childNodes[n];if(1===i.nodeType){var o=i.getAttribute("id");switch(i.nodeName){case"source":a.sources[o]=G(i);break;case"vertices":a.vertices=I(i);break;case"polygons":console.warn("ColladaLoader: Unsupported primitive type: ",i.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":a.primitives.push(W(i));break;default:console.log(i)}}}de.geometries[e.getAttribute("id")]=a}function G(e){for(var r={array:[],stride:3},n=0;n<e.childNodes.length;n++){var i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"float_array":r.array=a(i.textContent);break;case"technique_common":var o=t(i,"accessor")[0];void 0!==o&&(r.stride=parseInt(o.getAttribute("stride")));break;default:console.log(i)}}return r}function I(e){for(var t={},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];1===r.nodeType&&(t[r.getAttribute("semantic")]=n(r.getAttribute("source")))}return t}function W(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),inputs:{},stride:0},a=0,i=e.childNodes.length;a<i;a++){var o=e.childNodes[a];if(1===o.nodeType)switch(o.nodeName){case"input":var s=n(o.getAttribute("source")),c=o.getAttribute("semantic"),l=parseInt(o.getAttribute("offset"));t.inputs[c]={id:s,offset:l},t.stride=Math.max(t.stride,l+1);break;case"vcount":t.vcount=r(o.textContent);break;case"p":t.p=r(o.textContent)}}return t}function z(e){var t={},a=e.sources,r=e.vertices,n=e.primitives;if(0===n.length)return t;for(var i=0;i<n.length;i++){var o=n[i],s=o.inputs,c=new THREE.BufferGeometry;e.name&&(c.name=e.name);for(var l in s){var d=s[l];switch(l){case"VERTEX":for(var u in r)c.addAttribute(u.toLowerCase(),j(o,a[r[u]],d.offset));break;case"NORMAL":c.addAttribute("normal",j(o,a[d.id],d.offset));break;case"COLOR":c.addAttribute("color",j(o,a[d.id],d.offset));break;case"TEXCOORD":c.addAttribute("uv",j(o,a[d.id],d.offset))}}var f;switch(o.type){case"lines":f=new THREE.LineSegments(c,ae);break;case"linestrips":f=new THREE.Line(c,ae);break;case"triangles":case"polylist":f=new THREE.Mesh(c,re)}t[o.material]=f}return t}function j(e,t,a){function r(e){for(var t=n[e+a]*l,r=t+l;t<r;t++)d.push(c[t])}var n=e.p,i=e.stride,o=e.vcount,s=0,c=t.array,l=t.stride,d=[];if(void 0!==e.vcount){for(var u=0,f=0,h=o.length;f<h;f++){var m=o[f];if(4===m){var p=u+0*i,v=u+1*i,g=u+2*i,b=u+3*i;r(p),r(v),r(b),r(v),r(g),r(b)}else if(3===m){var p=u+0*i,v=u+1*i,g=u+2*i;r(p),r(v),r(g)}else s=Math.max(s,m);u+=i*m}s>0&&console.log("ColladaLoader: Geometry has faces with more than 4 vertices.")}else for(var f=0,h=n.length;f<h;f+=i)r(f);return new THREE.Float32BufferAttribute(d,l)}function X(e){return d(de.geometries[e],z)}function Y(e){for(var t={name:e.getAttribute("name"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceLights:[],instanceGeometries:[],instanceNodes:[]},r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"node":i.hasAttribute("id")&&(t.nodes.push(i.getAttribute("id")),Y(i));break;case"instance_camera":t.instanceCameras.push(n(i.getAttribute("url")));break;case"instance_light":t.instanceLights.push(n(i.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(Z(i));break;case"instance_node":t.instanceNodes.push(n(i.getAttribute("url")));break;case"matrix":var o=a(i.textContent);t.matrix.multiply(ne.fromArray(o).transpose());break;case"translate":var o=a(i.textContent);ie.fromArray(o),t.matrix.multiply(ne.makeTranslation(ie.x,ie.y,ie.z));break;case"rotate":var o=a(i.textContent),s=THREE.Math.degToRad(o[3]);t.matrix.multiply(ne.makeRotationAxis(ie.fromArray(o),s));break;case"scale":var o=a(i.textContent);t.matrix.scale(ie.fromArray(o));break;case"extra":break;default:console.log(i)}}return e.hasAttribute("id")&&(de.nodes[e.getAttribute("id")]=t),t}function Z(e){for(var t={id:n(e.getAttribute("url")),materials:{}},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];if("bind_material"===r.nodeName){for(var i=r.getElementsByTagName("instance_material"),o=0;o<i.length;o++){var s=i[o],c=s.getAttribute("symbol"),l=s.getAttribute("target");t.materials[c]=n(l)}break}}return t}function J(e){for(var t=[],a=e.matrix,r=e.nodes,n=e.instanceCameras,i=e.instanceLights,o=e.instanceGeometries,s=e.instanceNodes,c=0,l=r.length;c<l;c++)t.push(K(r[c]).clone());for(var c=0,l=n.length;c<l;c++)t.push(P(n[c]).clone());for(var c=0,l=i.length;c<l;c++)t.push(V(i[c]).clone());for(var c=0,l=o.length;c<l;c++){var d=o[c],u=X(d.id);for(var f in u){var h=u[f].clone();void 0!==d.materials[f]&&(h.material=H(d.materials[f])),t.push(h)}}for(var c=0,l=s.length;c<l;c++)t.push(K(s[c]).clone());var h;if(0===r.length&&1===t.length)h=t[0];else{h=new THREE.Group;for(var c=0;c<t.length;c++)h.add(t[c])}return h.name=e.name,a.decompose(h.position,h.quaternion,h.scale),h}function K(e){return d(de.nodes[e],J)}function Q(e){for(var a={name:e.getAttribute("name"),children:[]},r=t(e,"node"),n=0;n<r.length;n++)a.children.push(Y(r[n]));de.visualScenes[e.getAttribute("id")]=a}function $(e){var t=new THREE.Group;t.name=e.name;for(var a=e.children,r=0;r<a.length;r++)t.add(J(a[r]));return t}function ee(e){return d(de.visualScenes[e],$)}function te(e){var a=t(e,"instance_visual_scene")[0];return ee(n(a.getAttribute("url")))}var ae=new THREE.LineBasicMaterial,re=new THREE.MeshPhongMaterial,ne=new THREE.Matrix4,ie=new THREE.Vector3;if(console.time("ColladaLoader"),0===e.length)return{scene:new THREE.Scene};console.time("ColladaLoader: DOMParser");var oe=(new DOMParser).parseFromString(e,"application/xml");console.timeEnd("ColladaLoader: DOMParser");var se=t(oe,"COLLADA")[0],ce=se.getAttribute("version");console.log("ColladaLoader: File version",ce);var le=i(t(se,"asset")[0]),de={images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{}};console.time("ColladaLoader: Parse"),c(se,"library_images","image",u),c(se,"library_effects","effect",m),c(se,"library_materials","material",R),c(se,"library_cameras","camera",_),c(se,"library_lights","light",U),c(se,"library_geometries","geometry",B),c(se,"library_nodes","node",Y),c(se,"library_visual_scenes","visual_scene",Q),console.timeEnd("ColladaLoader: Parse"),console.time("ColladaLoader: Build"),l(de.images,f),l(de.effects,C),l(de.materials,k),l(de.cameras,q),l(de.lights,D),l(de.geometries,z),l(de.visualScenes,$),console.timeEnd("ColladaLoader: Build");var ue=te(t(se,"scene")[0]);return"Z_UP"===le.upAxis&&(ue.rotation.x=-Math.PI/2),ue.scale.multiplyScalar(le.unit),console.timeEnd("ColladaLoader"),{animations:[],kinematics:{joints:[]},library:de,scene:ue}}};