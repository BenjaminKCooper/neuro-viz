var Editor=function(){this.DEFAULT_CAMERA=new THREE.PerspectiveCamera(50,1,.1,1e4),this.DEFAULT_CAMERA.name="Camera",this.DEFAULT_CAMERA.position.set(20,10,20),this.DEFAULT_CAMERA.lookAt(new THREE.Vector3);var e=signals.Signal;this.signals={editScript:new e,startPlayer:new e,stopPlayer:new e,enterVR:new e,enteredVR:new e,exitedVR:new e,showModal:new e,editorCleared:new e,savingStarted:new e,savingFinished:new e,themeChanged:new e,transformModeChanged:new e,snapChanged:new e,spaceChanged:new e,rendererChanged:new e,sceneBackgroundChanged:new e,sceneFogChanged:new e,sceneGraphChanged:new e,cameraChanged:new e,geometryChanged:new e,objectSelected:new e,objectFocused:new e,objectAdded:new e,objectChanged:new e,objectRemoved:new e,helperAdded:new e,helperRemoved:new e,materialChanged:new e,scriptAdded:new e,scriptChanged:new e,scriptRemoved:new e,windowResize:new e,showGridChanged:new e,refreshSidebarObject3D:new e,historyChanged:new e,refreshScriptEditor:new e},this.config=new Config("threejs-editor"),this.history=new History(this),this.storage=new Storage,this.loader=new Loader(this),this.camera=this.DEFAULT_CAMERA.clone(),this.scene=new THREE.Scene,this.scene.name="Scene",this.scene.background=new THREE.Color(11184810),this.sceneHelpers=new THREE.Scene,this.object={},this.geometries={},this.materials={},this.textures={},this.scripts={},this.selected=null,this.helpers={}};Editor.prototype={setTheme:function(e){document.getElementById("theme").href=e,this.signals.themeChanged.dispatch(e)},setScene:function(e){for(this.scene.uuid=e.uuid,this.scene.name=e.name,null!==e.background&&(this.scene.background=e.background.clone()),null!==e.fog&&(this.scene.fog=e.fog.clone()),this.scene.userData=JSON.parse(JSON.stringify(e.userData)),this.signals.sceneGraphChanged.active=!1;e.children.length>0;)this.addObject(e.children[0]);this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},addObject:function(e){var t=this;e.traverse(function(e){void 0!==e.geometry&&t.addGeometry(e.geometry),void 0!==e.material&&t.addMaterial(e.material),t.addHelper(e)}),this.scene.add(e),this.signals.objectAdded.dispatch(e),this.signals.sceneGraphChanged.dispatch()},moveObject:function(e,t,i){if(void 0===t&&(t=this.scene),t.add(e),void 0!==i){var s=t.children.indexOf(i);t.children.splice(s,0,e),t.children.pop()}this.signals.sceneGraphChanged.dispatch()},nameObject:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},removeObject:function(e){if(null!==e.parent){var t=this;e.traverse(function(e){t.removeHelper(e)}),e.parent.remove(e),this.signals.objectRemoved.dispatch(e),this.signals.sceneGraphChanged.dispatch()}},addGeometry:function(e){this.geometries[e.uuid]=e},setGeometryName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addMaterial:function(e){this.materials[e.uuid]=e},setMaterialName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addTexture:function(e){this.textures[e.uuid]=e},addHelper:function(){var e=new THREE.SphereBufferGeometry(2,4,2),t=new THREE.MeshBasicMaterial({color:16711680,visible:!1});return function(i){var s;if(i instanceof THREE.Camera)s=new THREE.CameraHelper(i,1);else if(i instanceof THREE.PointLight)s=new THREE.PointLightHelper(i,1);else if(i instanceof THREE.DirectionalLight)s=new THREE.DirectionalLightHelper(i,1);else if(i instanceof THREE.SpotLight)s=new THREE.SpotLightHelper(i,1);else if(i instanceof THREE.HemisphereLight)s=new THREE.HemisphereLightHelper(i,1);else{if(!(i instanceof THREE.SkinnedMesh))return;s=new THREE.SkeletonHelper(i)}var n=new THREE.Mesh(e,t);n.name="picker",n.userData.object=i,s.add(n),this.sceneHelpers.add(s),this.helpers[i.id]=s,this.signals.helperAdded.dispatch(s)}}(),removeHelper:function(e){if(void 0!==this.helpers[e.id]){var t=this.helpers[e.id];t.parent.remove(t),delete this.helpers[e.id],this.signals.helperRemoved.dispatch(t)}},addScript:function(e,t){void 0===this.scripts[e.uuid]&&(this.scripts[e.uuid]=[]),this.scripts[e.uuid].push(t),this.signals.scriptAdded.dispatch(t)},removeScript:function(e,t){if(void 0!==this.scripts[e.uuid]){var i=this.scripts[e.uuid].indexOf(t);i!==-1&&this.scripts[e.uuid].splice(i,1),this.signals.scriptRemoved.dispatch(t)}},select:function(e){if(this.selected!==e){var t=null;null!==e&&(t=e.uuid),this.selected=e,this.config.setKey("selected",t),this.signals.objectSelected.dispatch(e)}},selectById:function(e){return e===this.camera.id?void this.select(this.camera):void this.select(this.scene.getObjectById(e,!0))},selectByUuid:function(e){var t=this;this.scene.traverse(function(i){i.uuid===e&&t.select(i)})},deselect:function(){this.select(null)},focus:function(e){this.signals.objectFocused.dispatch(e)},focusById:function(e){this.focus(this.scene.getObjectById(e,!0))},clear:function(){this.history.clear(),this.storage.clear(),this.camera.copy(this.DEFAULT_CAMERA),this.scene.background.setHex(11184810),this.scene.fog=null;for(var e=this.scene.children;e.length>0;)this.removeObject(e[0]);this.geometries={},this.materials={},this.textures={},this.scripts={},this.deselect(),this.signals.editorCleared.dispatch()},fromJSON:function(e){var t=new THREE.ObjectLoader;if(void 0===e.scene)return void this.setScene(t.parse(e));var i=t.parse(e.camera);this.camera.copy(i),this.camera.aspect=this.DEFAULT_CAMERA.aspect,this.camera.updateProjectionMatrix(),this.history.fromJSON(e.history),this.scripts=e.scripts,this.setScene(t.parse(e.scene))},toJSON:function(){var e=this.scene,t=this.scripts;for(var i in t){var s=t[i];0!==s.length&&void 0!==e.getObjectByProperty("uuid",i)||delete t[i]}return{metadata:{},project:{gammaInput:this.config.getKey("project/renderer/gammaInput"),gammaOutput:this.config.getKey("project/renderer/gammaOutput"),shadows:this.config.getKey("project/renderer/shadows"),editable:this.config.getKey("project/editable"),vr:this.config.getKey("project/vr")},camera:this.camera.toJSON(),scene:this.scene.toJSON(),scripts:this.scripts,history:this.history.toJSON()}},objectByUuid:function(e){return this.scene.getObjectByProperty("uuid",e,!0)},execute:function(e,t){this.history.execute(e,t)},undo:function(){this.history.undo()},redo:function(){this.history.redo()}};