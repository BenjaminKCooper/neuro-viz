THREE.SoftwareRenderer=function(e){function t(e,t){d=Math.floor(e/k),u=Math.floor(t/k),v=d*k,m=u*k;var r=1<<j;p=r*v/2,M=-r*m/2,E=P/2,x=r*v/2+.5,y=r*m/2+.5,w=P/2+.5,z.width=v,z.height=m,N.fillStyle=O?"rgba(0, 0, 0, 0)":C.getStyle(),N.fillRect(0,0,v,m),R=N.getImageData(0,0,v,m),g=R.data,T=new Int32Array(g.length/4),b=d*u,H=new Int32Array(b),S=new Uint8Array(b);for(var o=0,l=T.length;o<l;o++)T[o]=P;for(var o=0;o<b;o++)S[o]=B;a(C)}function a(e){for(var t=v*m*4,a=0;a<t;a+=4)g[a]=255*e.r|0,g[a+1]=255*e.g|0,g[a+2]=255*e.b|0,g[a+3]=O?0:255;N.fillStyle=O?"rgba(0, 0, 0, 0)":e.getStyle(),N.fillRect(0,0,v,m)}function r(e,t){var a=0,r=0,o=255*e.color.r,l=255*e.color.g,i=255*e.color.b,n=new Uint8Array(768);if(t){for(;a<204;)n[r++]=Math.min(a*o/204,255),n[r++]=Math.min(a*l/204,255),n[r++]=Math.min(a*i/204,255),++a;for(;a<256;)n[r++]=Math.min(o+(a-204)*(255-o)/82,255),n[r++]=Math.min(l+(a-204)*(255-l)/82,255),n[r++]=Math.min(i+(a-204)*(255-i)/82,255),++a}else for(;a<256;)n[r++]=Math.min(a*o/255,255),n[r++]=Math.min(a*l/255,255),n[r++]=Math.min(a*i/255,255),++a;return n}function o(e,t,a,r,o,l,i,n,f){var c=4*a,s=I[f.map.id];if(s.data){var h=s.width,v=f.transparent,m=h-1,d=s.data,u=4*((l*h&m)*h+(o*h&m));if(v){var p=d[u],M=d[u+1],E=d[u+2],x=d[u+3]*f.opacity/255,y=e[c],w=e[c+1],R=e[c+2];e[c]=p*x+y*(1-x),e[c+1]=M*x+w*(1-x),e[c+2]=E*x+R*(1-x),e[c+3]=(f.opacity<<8)-1,255==e[c+3]&&(t[a]=r)}else e[c]=d[u],e[c+1]=d[u+1],e[c+2]=d[u+2],e[c+3]=(f.opacity<<8)-1,t[a]=r}}function l(e,t,a,r,o,l,i,n,f){var c=4*a,s=I[f.map.id];if(s.data){var h=s.width,v=f.transparent,m=3*(i>0?~~i:0),d=h-1,u=s.data,p=4*((l*h&d)*h+(o*h&d));if(v){var M=f.palette[m]*u[p],E=f.palette[m+1]*u[p+1],x=f.palette[m+2]*u[p+2],y=u[p+3]*f.opacity/256,w=e[c],R=e[c+1],g=e[c+2];e[c]=M*y+w*(1-y),e[c+1]=E*y+R*(1-y),e[c+2]=x*y+g*(1-y),e[c+3]=(f.opacity<<8)-1,255==e[c+3]&&(t[a]=r)}else e[c]=f.palette[m]*u[p]>>8,e[c+1]=f.palette[m+1]*u[p+1]>>8,e[c+2]=f.palette[m+2]*u[p+2]>>8,e[c+3]=(f.opacity<<8)-1,t[a]=r}}function i(e){var t=e.target;t.removeEventListener("update",i),delete V[t.id]}function n(e){var t=e.id,a=V[t];if(a&&e.map&&!I[e.map.id]&&delete V[t],void 0===V[t]){if(e.addEventListener("update",i),e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial||e instanceof THREE.SpriteMaterial){e instanceof THREE.MeshLambertMaterial?e.palette||(e.palette=r(e,!1)):e instanceof THREE.MeshPhongMaterial&&(e.palette||(e.palette=r(e,!0)));var n;if(e.map){var f=new THREE.SoftwareRenderer.Texture;if(f.fromImage(e.map.image),!f.data)return;I[e.map.id]=f,a=e instanceof THREE.MeshBasicMaterial||e instanceof THREE.SpriteMaterial?o:l}else n=e.vertexColors===THREE.FaceColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),a=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n)}else if(e instanceof THREE.LineBasicMaterial){var n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * (color1.r+color2.r) * 0.5 * 255;","buffer[ colorOffset + 1 ] = material.color.g * (color1.g+color2.g) * 0.5 * 255;","buffer[ colorOffset + 2 ] = material.color.b * (color1.b+color2.b) * 0.5 * 255;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");a=new Function("buffer, depthBuf, offset, depth, color1, color2, material",n)}else{var n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");a=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n)}V[t]=a}return a}function f(e,t,a,r,o,l,i,n,c){if(!(e.z<-1||e.z>1||t.z<-1||t.z>1||a.z<-1||a.z>1)){var h=1<<j,u=e.x*p+x|0,R=t.x*p+x|0,b=a.x*p+x|0,z=e.y*M+y|0,N=t.y*M+y|0,O=a.y*M+y|0,V=n.vertexNormalsModel&&n.vertexNormalsModel.length,I=r&&o&&l,C=Math.max(Math.sqrt((u-R)*(u-R)+(z-N)*(z-N)),Math.sqrt((R-b)*(R-b)+(N-O)*(N-O)),Math.sqrt((b-u)*(b-u)+(O-z)*(O-z)));if(!(n instanceof THREE.RenderableSprite)&&C>100*h){var P,q,D,U={vertexNormalsModel:[],color:n.color};if(I){se===ce.length?(P=new THREE.Vector2,ce.push(P),++se,q=new THREE.Vector2,ce.push(q),++se,D=new THREE.Vector2,ce.push(D),++se):(P=ce[se],++se,q=ce[se],++se,D=ce[se],++se);var W;W=(1+t.z)*(t.w/e.w)/(1+e.z),P.copy(r).multiplyScalar(W).add(o).multiplyScalar(1/(W+1)),W=(1+a.z)*(a.w/t.w)/(1+t.z),q.copy(o).multiplyScalar(W).add(l).multiplyScalar(1/(W+1)),W=(1+e.z)*(e.w/a.w)/(1+a.z),D.copy(l).multiplyScalar(W).add(r).multiplyScalar(1/(W+1))}var X,Y,Z;ie===le.length?(X=new THREE.Vector4,le.push(X),++ie,Y=new THREE.Vector4,le.push(Y),++ie,Z=new THREE.Vector4,le.push(Z),++ie):(X=le[ie],++ie,Y=le[ie],++ie,Z=le[ie],++ie),X.copy(e).add(t).multiplyScalar(.5),Y.copy(t).add(a).multiplyScalar(.5),Z.copy(a).add(e).multiplyScalar(.5);var $,_,ee;return V&&(fe===ne.length?($=new THREE.Vector3,ne.push($),++fe,_=new THREE.Vector3,ne.push(_),++fe,ee=new THREE.Vector3,ne.push(ee),++fe):($=ne[fe],++fe,_=ne[fe],++fe,ee=ne[fe],++fe),$.copy(n.vertexNormalsModel[0]).add(n.vertexNormalsModel[1]).normalize(),_.copy(n.vertexNormalsModel[1]).add(n.vertexNormalsModel[2]).normalize(),ee.copy(n.vertexNormalsModel[2]).add(n.vertexNormalsModel[0]).normalize()),V&&(U.vertexNormalsModel[0]=n.vertexNormalsModel[0],U.vertexNormalsModel[1]=$,U.vertexNormalsModel[2]=ee),f(e,X,Z,r,P,D,i,U,c),V&&(U.vertexNormalsModel[0]=n.vertexNormalsModel[1],U.vertexNormalsModel[1]=_,U.vertexNormalsModel[2]=$),f(t,Y,X,o,q,P,i,U,c),V&&(U.vertexNormalsModel[0]=$,U.vertexNormalsModel[1]=_,U.vertexNormalsModel[2]=ee),f(X,Y,Z,P,q,D,i,U,c),V&&(U.vertexNormalsModel[0]=n.vertexNormalsModel[2],U.vertexNormalsModel[1]=ee,U.vertexNormalsModel[2]=_),void f(a,Z,Y,l,D,q,i,U,c)}var te,ae,re,oe,he,ve,me=e.z*E+w|0,de=t.z*E+w|0,ue=a.z*E+w|0,I=!1;r&&o&&l&&(I=!0,te=r.x,ae=1-r.y,re=o.x,oe=1-o.y,he=l.x,ve=1-l.y);var pe,Me,Ee,xe,ye,we;V&&(pe=n.vertexNormalsModel[0],Me=n.vertexNormalsModel[1],Ee=n.vertexNormalsModel[2],xe=255*pe.z,ye=255*Me.z,we=255*Ee.z);var Re=u-R,ge=N-z,Te=R-b,be=O-N,He=b-u,Se=z-O,ze=Math.max(Math.min(u,R,b)+F>>j,0),Ne=Math.min(Math.max(u,R,b)+F>>j,v),Oe=Math.max(Math.min(z,N,O)+F>>j,0),Ve=Math.min(Math.max(z,N,O)+F>>j,m);G=Math.min(ze,G),K=Math.max(Ne,K),J=Math.min(Oe,J),Q=Math.max(Ve,Q);var Ie=k;ze&=~(Ie-1),Oe&=~(Ie-1);var Ce=ze<<j,Be=Oe<<j,Ae=ge*(Ce-u)+Re*(Be-z),je=be*(Ce-R)+Te*(Be-N),Fe=Se*(Ce-b)+He*(Be-O);(ge>0||0==ge&&Re>0)&&Ae++,(be>0||0==be&&Te>0)&&je++,(Se>0||0==Se&&He>0)&&Fe++,Ae=Ae-1>>j,je=je-1>>j,Fe=Fe-1>>j;var Le=me-de,ke=ue-me,Pe=1/(Re*Se-He*ge),qe=Pe*(Le*Se-ke*ge),De=Pe*(Le*He-Re*ke),Ue=me+(Ce-u)*qe+(Be-z)*De|0;qe=qe*h|0,De=De*h|0;var Ge,Je,Ke,Qe;if(I){var We=te-re,Xe=he-te,Ye=Pe*(We*Se-Xe*ge),Ze=Pe*(We*He-Re*Xe),$e=ae-oe,_e=ve-ae;Ge=Pe*($e*Se-_e*ge),Je=Pe*($e*He-Re*_e),Ke=te+(Ce-u)*Ye+(Be-z)*Ze,Qe=ae+(Ce-u)*Ge+(Be-z)*Je,Ye*=h,Ze*=h,Ge*=h,Je*=h}var et,tt;if(V){var at=xe-ye,rt=we-xe,ot=Pe*(at*Se-rt*ge),et=Pe*(at*He-Re*rt);tt=xe+(Ce-u)*ot+(Be-z)*et,ot*=h,et*=h}var lt=Ie-1,it=0,nt=0,ft=0,ct=0,st=0,ht=0,vt=0,mt=0;Re>=0?nt-=lt*Re:it-=lt*Re,ge>=0?nt-=lt*ge:it-=lt*ge,Te>=0?ct-=lt*Te:ft-=lt*Te,be>=0?ct-=lt*be:ft-=lt*be,He>=0?ht-=lt*He:st-=lt*He,Se>=0?ht-=lt*Se:st-=lt*Se,qe>=0?mt+=lt*qe:vt+=lt*qe,De>=0?mt+=lt*De:vt+=lt*De;var dt,ut,pt=v-Ie,Mt=Ae,Et=je,xt=Fe,yt=Ue,wt=-Ie,Rt=wt*ge,gt=wt*be,Tt=wt*Se,bt=wt*qe;I&&(dt=wt*Ye,ut=wt*Ge);var Ht;V&&(Ht=wt*ot);for(var St=ze,zt=Oe;zt<Ve;zt+=Ie){for(;St>=ze&&St<Ne&&Mt>=nt&&Et>=ct&&xt>=ht;)St+=wt,Mt+=Rt,Et+=gt,xt+=Tt,yt+=bt,I&&(Ke+=dt,Qe+=ut),V&&(tt+=Ht);for(wt=-wt,Rt=-Rt,gt=-gt,Tt=-Tt,bt=-bt,I&&(dt=-dt,ut=-ut),V&&(Ht=-Ht);;){if(St+=wt,Mt+=Rt,Et+=gt,xt+=Tt,yt+=bt,I&&(Ke+=dt,Qe+=ut),V&&(tt+=Ht),St<ze||St>=Ne)break;if(Mt<nt){if(Rt<0)break}else if(Et<ct){if(gt<0)break}else if(xt<ht){if(Tt<0)break}else{var Nt=St>>L,Ot=zt>>L,Vt=Nt+Ot*d,It=yt+vt;if(!(H[Vt]<It)){var Ct=S[Vt];Ct&A&&s(Nt,Ot),S[Vt]=Ct&~(B|A);var Bt=St+zt*v;if(Mt>=it&&Et>=ft&&xt>=st){var At=yt+mt;H[Vt]=Math.min(H[Vt],At);var jt,Ft,Lt=Mt,kt=Et,Pt=yt;I&&(jt=Ke,Ft=Qe);var qt;V&&(qt=tt);for(var Dt=0;Dt<Ie;Dt++){var Ut,Gt,Jt=Lt,Kt=kt,Qt=Pt;I&&(Ut=jt,Gt=Ft);var Wt;V&&(Wt=qt);for(var Xt=0;Xt<Ie;Xt++){var Yt=Qt;Yt<T[Bt]&&i(g,T,Bt,Yt,Ut,Gt,Wt,n,c),Jt+=ge,Kt+=be,Qt+=qe,I&&(Ut+=Ye,Gt+=Ge),V&&(Wt+=ot),Bt++}Lt+=Re,kt+=Te,Pt+=De,I&&(jt+=Ze,Ft+=Je),V&&(qt+=et),Bt+=pt}}else{var jt,Ft,Lt=Mt,kt=Et,Zt=xt,Pt=yt;I&&(jt=Ke,Ft=Qe);var qt;V&&(qt=tt);for(var Dt=0;Dt<Ie;Dt++){var Ut,Gt,Jt=Lt,Kt=kt,$t=Zt,Qt=Pt;I&&(Ut=jt,Gt=Ft);var Wt;V&&(Wt=qt);for(var Xt=0;Xt<Ie;Xt++){if((Jt|Kt|$t)>=0){var Yt=Qt;Yt<T[Bt]&&i(g,T,Bt,Yt,Ut,Gt,Wt,n,c)}Jt+=ge,Kt+=be,$t+=Se,Qt+=qe,I&&(Ut+=Ye,Gt+=Ge),V&&(Wt+=ot),Bt++}Lt+=Re,kt+=Te,Zt+=He,Pt+=De,I&&(jt+=Ze,Ft+=Je),V&&(qt+=et),Bt+=pt}}}}}Mt+=Ie*Re,Et+=Ie*Te,xt+=Ie*He,yt+=Ie*De,I&&(Ke+=Ie*Ze,Qe+=Ie*Je),V&&(tt+=Ie*et)}}}function c(e,a,r,o,l,i){if(q||(q=!0,L=0,k=1<<L,t(z.width,z.height)),!(e.z<-1||e.z>1||a.z<-1||a.z>1)){var n=Math.floor(.5*(i.linewidth-1)),f=e.x*p+x|0,c=a.x*p+x|0,h=e.y*M+y|0,u=a.y*M+y|0,R=e.z*E+w|0,b=a.z*E+w|0,N=f-c,O=h-u,V=R-b,I=Math.max(Math.min(f,c)+F>>j,0),C=Math.min(Math.max(f,c)+F>>j,v),P=Math.max(Math.min(h,u)+F>>j,0),W=Math.min(Math.max(h,u)+F>>j,m),X=Math.max(Math.min(R,b)+F>>j,0),Y=Math.max(R,b)+F>>j;G=Math.min(I,G),K=Math.max(C,K),J=Math.min(P,J),Q=Math.max(W,Q);var Z,$,_,ee,te,ae,re=Math.sqrt(O*O+N*N),oe=N/re,le=O/re,ie=V/re;for(U.set(oe,le,ie),U.cross(D),U.normalize();re>0;){Z=c+re*oe,$=u+re*le,_=b+re*ie,Z=Z+F>>j,$=$+F>>j,ae=_+F>>j;for(var ne=-n;ne<=n;++ne)if(ee=Math.floor(Z+U.x*ne),te=Math.floor($+U.y*ne),!(G>=ee||K<=ee||J>=te||Q<=te)){var fe=ee>>L,ce=te>>L,se=fe+ce*d;if(!(H[se]<X)){H[se]=Math.min(H[se],Y);var he=S[se];he&A&&s(fe,ce),S[se]=he&~(B|A);var ve=ee+te*v;ae<T[ve]&&l(g,T,ve,ae,r,o,i)}}--re}}}function s(e,t){for(var a=e*k+t*k*v,r=4*a,o=v-k,l=4*o,i=0;i<k;i++){for(var n=0;n<k;n++)T[a++]=P,g[r++]=255*C.r|0,g[r++]=255*C.g|0,g[r++]=255*C.b|0,g[r++]=O?0:255;a+=o,r+=l}}function h(){for(var e=0,t=0;t<u;t++)for(var a=0;a<d;a++)S[e]&A&&(s(a,t),S[e]=B),e++}console.log("THREE.SoftwareRenderer",THREE.REVISION),e=e||{};var v,m,d,u,p,M,E,x,y,w,R,g,T,b,H,S,z=void 0!==e.canvas?e.canvas:document.createElement("canvas"),N=z.getContext("2d",{alpha:e.alpha===!0}),O=e.alpha,V={},I={},C=new THREE.Color(0),B=1,A=2,j=4,F=(1<<j)-1,L=3,k=1<<L,P=1<<24,q=!1,D=new THREE.Vector3(0,0,1),U=new THREE.Vector3,G=1/0,J=1/0,K=0,Q=0,W=1/0,X=1/0,Y=0,Z=0,$=new THREE.Projector,_=new THREE.Vector4,ee=new THREE.Vector4,te=new THREE.Vector4,ae=new THREE.Vector2,re=new THREE.Vector2,oe=new THREE.Vector2,le=[],ie=0,ne=[],fe=0,ce=[],se=0;this.domElement=z,this.autoClear=!0,this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e,t){C.set(e),a(C)},this.setPixelRatio=function(){},this.setSize=function(e,t){d=Math.floor(e/k),u=Math.floor(t/k),v=d*k,m=u*k;var r=1<<j;p=r*v/2,M=-r*m/2,E=P/2,x=r*v/2+.5,y=r*m/2+.5,w=P/2+.5,z.width=v,z.height=m,N.fillStyle=O?"rgba(0, 0, 0, 0)":C.getStyle(),N.fillRect(0,0,v,m),R=N.getImageData(0,0,v,m),g=R.data,T=new Int32Array(g.length/4),b=d*u,H=new Int32Array(b),S=new Uint8Array(b);for(var o=0,l=T.length;o<l;o++)T[o]=P;for(var o=0;o<b;o++)S[o]=B;a(C)},this.setSize(z.width,z.height),this.clear=function(){G=1/0,J=1/0,K=0,Q=0,ie=0,fe=0,se=0;for(var e=0;e<b;e++)H[e]=P,S[e]=S[e]&B?B:A},this.render=function(e,t){this.clear();var r=e.background;r&&r.isColor&&a(r);for(var o=$.projectScene(e,t,!1,!1),l=o.elements,i=0,s=l.length;i<s;i++){var v=l[i],m=v.material,d=n(m);if(d)if(v instanceof THREE.RenderableFace)v.uvs?f(v.v1.positionScreen,v.v2.positionScreen,v.v3.positionScreen,v.uvs[0],v.uvs[1],v.uvs[2],d,v,m):f(v.v1.positionScreen,v.v2.positionScreen,v.v3.positionScreen,null,null,null,d,v,m);else if(v instanceof THREE.RenderableSprite){var u=.5*v.scale.x,p=.5*v.scale.y;_.copy(v),_.x-=u,_.y+=p,ee.copy(v),ee.x-=u,ee.y-=p,te.copy(v),te.x+=u,te.y+=p,m.map?(ae.set(0,1),re.set(0,0),oe.set(1,1),f(_,ee,te,ae,re,oe,d,v,m)):f(_,ee,te,null,null,null,d,v,m),_.copy(v),_.x+=u,_.y+=p,ee.copy(v),ee.x-=u,ee.y-=p,te.copy(v),te.x+=u,te.y-=p,m.map?(ae.set(1,1),re.set(0,0),oe.set(1,0),f(_,ee,te,ae,re,oe,d,v,m)):f(_,ee,te,null,null,null,d,v,m)}else if(v instanceof THREE.RenderableLine){var d=n(m);c(v.v1.positionScreen,v.v2.positionScreen,v.vertexColors[0],v.vertexColors[1],d,m)}}h();var M=Math.min(G,W),E=Math.min(J,X),x=Math.max(K,Y)-M,y=Math.max(Q,Z)-E;M!==1/0&&N.putImageData(R,0,0,M,E,x,y),W=G,X=J,Y=K,Z=Q}},THREE.SoftwareRenderer.Texture=function(){var e;this.fromImage=function(t){if(!(!t||t.width<=0||t.height<=0)){void 0===e&&(e=document.createElement("canvas"));var a=t.width>t.height?t.width:t.height;a=THREE.Math.nextPowerOfTwo(a),e.width==a&&e.height==a||(e.width=a,e.height=a);var r=e.getContext("2d");r.clearRect(0,0,a,a),r.drawImage(t,0,0,a,a);var o=r.getImageData(0,0,a,a);this.data=o.data,this.width=a,this.height=a,this.srcUrl=t.src}}};