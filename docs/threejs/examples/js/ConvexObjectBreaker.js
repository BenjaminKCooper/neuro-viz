THREE.ConvexObjectBreaker=function(e,t){this.minSizeForBreak=e||1.4,this.smallDelta=t||1e-4,this.tempLine1=new THREE.Line3,this.tempPlane1=new THREE.Plane,this.tempPlane2=new THREE.Plane,this.tempCM1=new THREE.Vector3,this.tempCM2=new THREE.Vector3,this.tempVector3=new THREE.Vector3,this.tempVector3_2=new THREE.Vector3,this.tempVector3_3=new THREE.Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var r=900,a=0;a<r;a++)this.segments[a]=!1},THREE.ConvexObjectBreaker.prototype={constructor:THREE.ConvexObjectBreaker,prepareBreakableObject:function(e,t,r,a,n){for(var o=e.geometry.vertices,s=0,i=o.length;s<i;s++)o[s].mark=0;var m=e.userData;m.mass=t,m.velocity=r.clone(),m.angularVelocity=a.clone(),m.breakable=n},subdivideByImpact:function(e,t,r,a,n,o){function s(n,o,h,v){if(Math.random()<.05*v||v>p)return void i.push(n);var u=Math.PI;0===v?(c.normal.copy(m.normal),c.constant=m.constant):v<=a?(u=(h-o)*(.2+.6*Math.random())+o,l.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(r,u).add(t),c.setFromCoplanarPoints(t,l.tempVector3,l.tempVector3_2)):(u=(.5*(1&v)+.2*(2-Math.random()))*Math.PI,l.tempVector3_2.copy(t).sub(n.position).applyAxisAngle(r,u).add(n.position),l.tempVector3_3.copy(r).add(n.position),c.setFromCoplanarPoints(n.position,l.tempVector3_3,l.tempVector3_2)),l.cutByPlane(n,c,l.tempResultObjects);var E=l.tempResultObjects.object1,f=l.tempResultObjects.object2;E&&s(E,o,u,v+1),f&&s(f,u,h,v+1)}var i=[],m=this.tempPlane1,c=this.tempPlane2;this.tempVector3.addVectors(t,r),m.setFromCoplanarPoints(t,e.position,this.tempVector3);var p=n+a,l=this;return s(e,0,2*Math.PI,0),i},cutByPlane:function(e,t,r){for(var a=e.geometry,n=a.vertices,o=a.faces,s=n.length,i=[],m=[],c=this.smallDelta,p=0;p<s;p++)n[p].mark=0;for(var l=s*s,p=0;p<l;p++)this.segments[p]=!1;for(var p=0,h=o.length-1;p<h;p++)for(var v=o[p],u=p+1,E=o.length;u<E;u++){var f=o[u],b=1-v.normal.dot(f.normal)<c;if(b){var d=v.a,y=v.b,k=v.c,T=f.a,g=f.b,C=f.c;d===T||d===g||d===C?y===T||y===g||y===C?(this.segments[d*s+y]=!0,this.segments[y*s+d]=!0):(this.segments[k*s+d]=!0,this.segments[d*s+k]=!0):y!==T&&y!==g&&y!==C||(this.segments[k*s+y]=!0,this.segments[y*s+k]=!0)}}var R=this.tempPlane1;e.updateMatrix(),THREE.ConvexObjectBreaker.transformPlaneToLocalSpace(t,e.matrix,R);for(var p=0,h=o.length;p<h;p++)for(var x=o[p],V=0;V<3;V++){var M=0===V?x.a:1===V?x.b:x.c,j=0===V?x.b:1===V?x.c:x.a,H=this.segments[M*s+j];if(!H){this.segments[M*s+j]=!0,this.segments[j*s+M]=!0;var P=n[M],B=n[j];if(0===P.mark){var O=R.distanceToPoint(P);if(O>c)P.mark=2,m.push(P);else if(O<-c)P.mark=1,i.push(P);else{P.mark=3,i.push(P);var w=P.clone();w.mark=3,m.push(w)}}if(0===B.mark){var O=R.distanceToPoint(B);if(O>c)B.mark=2,m.push(B);else if(O<-c)B.mark=1,i.push(B);else{B.mark=3,i.push(B);var z=B.clone();z.mark=3,m.push(z)}}var F=P.mark,I=B.mark;if(1===F&&2===I||2===F&&1===I){this.tempLine1.start.copy(P),this.tempLine1.end.copy(B);var D=R.intersectLine(this.tempLine1);if(void 0===D)return console.error("Internal error: segment does not intersect plane."),r.segmentedObject1=null,r.segmentedObject2=null,0;D.mark=1,i.push(D);var L=D.clone();L.mark=2,m.push(L)}}}var _=.5*e.userData.mass;this.tempCM1.set(0,0,0);var S=0,q=i.length;if(q>0){for(var p=0;p<q;p++)this.tempCM1.add(i[p]);this.tempCM1.divideScalar(q);for(var p=0;p<q;p++){var A=i[p];A.sub(this.tempCM1),S=Math.max(S,A.x,A.y,A.z)}this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);var G=0,J=m.length;if(J>0){for(var p=0;p<J;p++)this.tempCM2.add(m[p]);this.tempCM2.divideScalar(J);for(var p=0;p<J;p++){var A=m[p];A.sub(this.tempCM2),G=Math.max(G,A.x,A.y,A.z)}this.tempCM2.add(e.position)}var K=null,N=null,Q=0;return q>4&&(K=new THREE.Mesh(new THREE.ConvexGeometry(i),e.material),K.position.copy(this.tempCM1),K.quaternion.copy(e.quaternion),this.prepareBreakableObject(K,_,e.userData.velocity,e.userData.angularVelocity,2*S>this.minSizeForBreak),Q++),J>4&&(N=new THREE.Mesh(new THREE.ConvexGeometry(m),e.material),N.position.copy(this.tempCM2),N.quaternion.copy(e.quaternion),this.prepareBreakableObject(N,_,e.userData.velocity,e.userData.angularVelocity,2*G>this.minSizeForBreak),Q++),r.object1=K,r.object2=N,Q}},THREE.ConvexObjectBreaker.transformFreeVector=function(e,t){var r=e.x,a=e.y,n=e.z,o=t.elements;return e.x=o[0]*r+o[4]*a+o[8]*n,e.y=o[1]*r+o[5]*a+o[9]*n,e.z=o[2]*r+o[6]*a+o[10]*n,e},THREE.ConvexObjectBreaker.transformFreeVectorInverse=function(e,t){var r=e.x,a=e.y,n=e.z,o=t.elements;return e.x=o[0]*r+o[1]*a+o[2]*n,e.y=o[4]*r+o[5]*a+o[6]*n,e.z=o[8]*r+o[9]*a+o[10]*n,e},THREE.ConvexObjectBreaker.transformTiedVectorInverse=function(e,t){var r=e.x,a=e.y,n=e.z,o=t.elements;return e.x=o[0]*r+o[1]*a+o[2]*n-o[12],e.y=o[4]*r+o[5]*a+o[6]*n-o[13],e.z=o[8]*r+o[9]*a+o[10]*n-o[14],e},THREE.ConvexObjectBreaker.transformPlaneToLocalSpace=function(){var e=new THREE.Vector3;new THREE.Matrix3;return function(t,r,a){a.normal.copy(t.normal),a.constant=t.constant;var n=THREE.ConvexObjectBreaker.transformTiedVectorInverse(t.coplanarPoint(e),r);THREE.ConvexObjectBreaker.transformFreeVectorInverse(a.normal,r),a.constant=-n.dot(a.normal)}}();