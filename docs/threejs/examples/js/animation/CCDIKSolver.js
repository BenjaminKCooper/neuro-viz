THREE.CCDIKSolver=function(e){this.mesh=e,this._valid()},THREE.CCDIKSolver.prototype={constructor:THREE.CCDIKSolver,_valid:function(){for(var e=this.mesh.geometry.iks,t=this.mesh.skeleton.bones,r=0,i=e.length;r<i;r++){var o,n,a=e[r],s=t[a.effector],l=a.links;o=s;for(var h=0,E=l.length;h<E;h++)n=t[l[h].index],o.parent!==n&&console.warn("THREE.CCDIKSolver: bone "+o.name+" is not the child of bone "+n.name),o=n}},_saveOriginalBonesInfo:function(){for(var e=this.mesh.skeleton.bones,t=0,r=e.length;t<r;t++){var i=e[t];void 0===i.userData.ik&&(i.userData.ik={}),i.userData.ik.originalMatrix=i.matrix.toArray()}},update:function(e){var t=new THREE.Quaternion,r=new THREE.Vector3,i=new THREE.Vector3,o=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Quaternion,l=new THREE.Vector3,h=this.mesh.skeleton.bones,E=this.mesh.geometry.iks,p=(this.mesh.geometry.bones,Math);this.mesh.updateMatrixWorld(!0),e===!0&&this._saveOriginalBonesInfo();for(var d=0,c=E.length;d<c;d++){var m=E[d],u=h[m.effector],f=h[m.target];r.setFromMatrixPosition(f.matrixWorld);for(var H=m.links,v=void 0!==m.iteration?m.iteration:1,T=0;T<v;T++){for(var R=!1,g=0,y=H.length;g<y;g++){var x=h[H[g].index];if(H[g].enabled===!1)break;var M=H[g].limitation;a.setFromMatrixPosition(x.matrixWorld),s.setFromRotationMatrix(x.matrixWorld).inverse(),o.setFromMatrixPosition(u.matrixWorld),n.subVectors(o,a),n.applyQuaternion(s),n.normalize(),i.subVectors(r,a),i.applyQuaternion(s),i.normalize();var w=i.dot(n);if(w>1?w=1:w<-1&&(w=-1),w=p.acos(w),!(w<1e-5)){if(void 0!==m.minAngle&&w<m.minAngle&&(w=m.minAngle),void 0!==m.maxAngle&&w>m.maxAngle&&(w=m.maxAngle),l.crossVectors(n,i),l.normalize(),t.setFromAxisAngle(l,w),x.quaternion.multiply(t),void 0!==M){var k=x.quaternion.w;k>1&&(k=1);var C=p.sqrt(1-k*k);x.quaternion.set(M.x*C,M.y*C,M.z*C,k)}x.updateMatrixWorld(!0),R=!0}}if(!R)break}}this.mesh.updateMatrixWorld(!0)}},THREE.CCDIKHelper=function(e){if(void 0===e.geometry.iks||void 0===e.skeleton)throw"THREE.CCDIKHelper requires iks in mesh.geometry and skeleton in mesh.";THREE.Object3D.call(this),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.sphereGeometry=new THREE.SphereBufferGeometry(.25,16,8),this.targetSphereMaterial=new THREE.MeshBasicMaterial({color:new THREE.Color(16746632),depthTest:!1,depthWrite:!1,transparent:!0}),this.effectorSphereMaterial=new THREE.MeshBasicMaterial({color:new THREE.Color(8978312),depthTest:!1,depthWrite:!1,transparent:!0}),this.linkSphereMaterial=new THREE.MeshBasicMaterial({color:new THREE.Color(8947967),depthTest:!1,depthWrite:!1,transparent:!0}),this.lineMaterial=new THREE.LineBasicMaterial({color:new THREE.Color(16711680),depthTest:!1,depthWrite:!1,transparent:!0}),this._init(),this.update()},THREE.CCDIKHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.CCDIKHelper.prototype.constructor=THREE.CCDIKHelper,THREE.CCDIKHelper.prototype._init=function(){function e(e){var t=new THREE.BufferGeometry,r=new Float32Array(3*(2+e.links.length));return t.addAttribute("position",new THREE.BufferAttribute(r,3)),t}function t(){return new THREE.Mesh(n.sphereGeometry,n.targetSphereMaterial)}function r(){return new THREE.Mesh(n.sphereGeometry,n.effectorSphereMaterial)}function i(){return new THREE.Mesh(n.sphereGeometry,n.linkSphereMaterial)}function o(t){return new THREE.Line(e(t),n.lineMaterial)}for(var n=this,a=this.root,s=a.geometry.iks,l=0,h=s.length;l<h;l++){var E=s[l];this.add(t()),this.add(r());for(var p=0,d=E.links.length;p<d;p++)this.add(i());this.add(o(E))}},THREE.CCDIKHelper.prototype.update=function(){function e(e){return s.setFromMatrixPosition(e.matrixWorld),s.applyMatrix4(a),s}function t(t,r,i){var o=e(i);t[3*r+0]=o.x,t[3*r+1]=o.y,t[3*r+2]=o.z}for(var r=0,i=this.root,o=i.geometry.iks,n=i.skeleton.bones,a=(new THREE.Matrix4).getInverse(i.matrixWorld),s=new THREE.Vector3,l=0,h=o.length;l<h;l++){var E=o[l],p=n[E.target],d=n[E.effector],c=this.children[r++],m=this.children[r++];c.position.copy(e(p)),m.position.copy(e(d));for(var u=0,f=E.links.length;u<f;u++){var H=E.links[u],v=n[H.index],T=this.children[r++];T.position.copy(e(v))}var R=this.children[r++],g=R.geometry.attributes.position.array;t(g,0,p),t(g,1,d);for(var u=0,f=E.links.length;u<f;u++){var H=E.links[u],v=n[H.index];t(g,u+2,v)}R.geometry.attributes.position.needsUpdate=!0}};