THREE.AMFLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.AMFLoader.prototype={constructor:THREE.AMFLoader,load:function(e,t,n,a){var r=this,o=new THREE.FileLoader(r.manager);o.setResponseType("arraybuffer"),o.load(e,function(e){t(r.parse(e))},n,a)},parse:function(e){function t(e){var t=new DataView(e),n=String.fromCharCode(t.getUint8(0),t.getUint8(1));if("PK"===n){var a=null,r=null;console.log("Loading Zip");try{a=new JSZip(e)}catch(e){if(e instanceof ReferenceError)return console.log("\tjszip missing and file is compressed."),null}for(r in a.files)if(".amf"===r.toLowerCase().substr(-4))break;console.log("\tTrying to load file asset: "+r),t=new DataView(a.file(r).asArrayBuffer())}if(void 0===TextDecoder)return console.log("\tTextDecoder not present.\tPlease use TextDecoder polyfill."),null;var o=new TextDecoder("utf-8").decode(t),i=(new DOMParser).parseFromString(o,"application/xml");return"amf"!==i.documentElement.nodeName.toLowerCase()?(console.log("\tError loading AMF - no AMF document found."),null):i}function n(e){var t=1,n="millimeter";void 0!==e.documentElement.attributes.unit&&(n=e.documentElement.attributes.unit.value.toLowerCase());var a={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==a[n]&&(t=a[n]),console.log("\tUnit scale: "+t),t}function a(e){for(var t="AMF Material",n=e.attributes.id.textContent,a={r:1,g:1,b:1,a:1},o=null,i=0;i<e.children.length;i++){var l=e.children[i];"metadata"===l.nodeName&&void 0!==l.attributes.type?"name"===l.attributes.type.value&&(matname=l.textContent):"color"===l.nodeName&&(a=r(l))}return o=new THREE.MeshPhongMaterial({shading:THREE.FlatShading,color:new THREE.Color(a.r,a.g,a.b),name:t}),1!==a.a&&(o.transparent=!0,o.opacity=a.a),{id:n,material:o}}function r(e){for(var t={r:1,g:1,b:1,a:1},n=0;n<e.children.length;n++){var a=e.children[n];"r"===a.nodeName?t.r=a.textContent:"g"===a.nodeName?t.g=a.textContent:"b"===a.nodeName?t.b=a.textContent:"a"===a.nodeName&&(t.a=a.textContent)}return t}function o(e){var t={name:"",triangles:[],materialid:null},n=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);n;){if("metadata"===n.nodeName)void 0!==n.attributes.type&&"name"===n.attributes.type.value&&(t.name=n.textContent);else if("triangle"===n.nodeName){var a=n.getElementsByTagName("v1")[0].textContent,r=n.getElementsByTagName("v2")[0].textContent,o=n.getElementsByTagName("v3")[0].textContent;t.triangles.push(a),t.triangles.push(r),t.triangles.push(o)}n=n.nextElementSibling}return t}function i(e){for(var t=[],n=[],a=e.firstElementChild;a;){if("vertex"===a.nodeName)for(var r=a.firstElementChild;r;){if("coordinates"===r.nodeName){var o=r.getElementsByTagName("x")[0].textContent,i=r.getElementsByTagName("y")[0].textContent,l=r.getElementsByTagName("z")[0].textContent;t.push(o),t.push(i),t.push(l)}else if("normal"===r.nodeName){var s=r.getElementsByTagName("nx")[0].textContent,m=r.getElementsByTagName("ny")[0].textContent,d=r.getElementsByTagName("nz")[0].textContent;n.push(s),n.push(m),n.push(d)}r=r.nextElementSibling}a=a.nextElementSibling}return{vertices:t,normals:n}}function l(e){for(var t=e.attributes.id.textContent,n={name:"amfobject",meshes:[]},a=null,l=e.firstElementChild;l;){if("metadata"===l.nodeName)void 0!==l.attributes.type&&"name"===l.attributes.type.value&&(n.name=l.textContent);else if("color"===l.nodeName)a=r(l);else if("mesh"===l.nodeName){for(var s=l.firstElementChild,m={vertices:[],normals:[],volumes:[],color:a};s;){if("vertices"===s.nodeName){var d=i(s);m.normals=m.normals.concat(d.normals),m.vertices=m.vertices.concat(d.vertices)}else"volume"===s.nodeName&&m.volumes.push(o(s));s=s.nextElementSibling}n.meshes.push(m)}l=l.nextElementSibling}return{id:t,obj:n}}for(var s=t(e),m="",d="",u=n(s),c={},f={},g=s.documentElement.children,v=0;v<g.length;v++){var E=g[v];if("metadata"===E.nodeName)void 0!==E.attributes.type&&("name"===E.attributes.type.value?m=E.textContent:"author"===E.attributes.type.value&&(d=E.textContent));else if("material"===E.nodeName){var h=a(E);c[h.id]=h.material}else if("object"===E.nodeName){var p=l(E);f[p.id]=p.obj}}var b=new THREE.Group,x=new THREE.MeshPhongMaterial({color:11184895,shading:THREE.FlatShading});b.name=m,b.userData.author=d,b.userData.loader="AMF";for(var y in f){var T=f[y],C=T.meshes,N=new THREE.Group;N.name=T.name||"";for(var v=0;v<C.length;v++){var w=x,R=C[v],H=new THREE.BufferAttribute(new Float32Array(R.vertices),3),A=null;if(R.normals.length&&(A=new THREE.BufferAttribute(new Float32Array(R.normals),3)),R.color){var M=R.color;w=x.clone(),w.color=new THREE.Color(M.r,M.g,M.b),1!==M.a&&(w.transparent=!0,w.opacity=M.a)}for(var B=R.volumes,F=0;F<B.length;F++){var D=B[F],S=new THREE.BufferGeometry,L=new Uint32Array(D.triangles),j=w;S.setIndex(new THREE.BufferAttribute(L,1)),S.addAttribute("position",H.clone()),A&&S.addAttribute("normal",A.clone()),void 0!==c[D.materialId]&&(j=c[D.materialId]),S.scale(u,u,u),N.add(new THREE.Mesh(S,j.clone()))}}b.add(N)}return b}};