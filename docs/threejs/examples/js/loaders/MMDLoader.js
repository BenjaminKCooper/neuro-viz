THREE.MMDLoader=function(e){THREE.Loader.call(this),this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.parser=new MMDParser.Parser,this.textureCrossOrigin=null},THREE.MMDLoader.prototype=Object.create(THREE.Loader.prototype),THREE.MMDLoader.prototype.constructor=THREE.MMDLoader,THREE.MMDLoader.prototype.defaultToonTextures=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="],THREE.MMDLoader.prototype.setTextureCrossOrigin=function(e){this.textureCrossOrigin=e},THREE.MMDLoader.prototype.load=function(e,t,r,a,n){var o=this;this.loadModel(e,function(e){o.loadVmds(t,function(t){o.pourVmdIntoModel(e,t),r(e)},a,n)},a,n)},THREE.MMDLoader.prototype.loadModel=function(e,t,r,a){var n=this,o=this.extractUrlBase(e),i=this.extractExtension(e);this.loadFileAsBuffer(e,function(e){t(n.createModel(e,i,o,r,a))},r,a)},THREE.MMDLoader.prototype.createModel=function(e,t,r,a,n){return this.createMesh(this.parseModel(e,t),r,a,n)},THREE.MMDLoader.prototype.loadVmd=function(e,t,r,a){var n=this;this.loadFileAsBuffer(e,function(e){t(n.parseVmd(e))},r,a)},THREE.MMDLoader.prototype.loadVmds=function(e,t,r,a){function n(){var s=e.shift();o.loadVmd(s,function(r){i.push(r),e.length>0?n():t(o.mergeVmds(i))},r,a)}var o=this,i=[];e=e.slice(),n()},THREE.MMDLoader.prototype.loadAudio=function(e,t,r,a){var n=new THREE.AudioListener,o=new THREE.Audio(n),i=new THREE.AudioLoader(this.manager);i.load(e,function(e){o.setBuffer(e),t(o,n)},r,a)},THREE.MMDLoader.prototype.loadVpd=function(e,t,r,a,n){var o=this,i=(n&&"unicode"===n.charcode?this.loadFileAsText:this.loadFileAsShiftJISText).bind(this);i(e,function(e){t(o.parseVpd(e))},r,a)},THREE.MMDLoader.prototype.parseModel=function(e,t){switch(t.toLowerCase()){case"pmd":return this.parsePmd(e);case"pmx":return this.parsePmx(e);default:throw"extension "+t+" is not supported."}},THREE.MMDLoader.prototype.parsePmd=function(e){return this.parser.parsePmd(e,!0)},THREE.MMDLoader.prototype.parsePmx=function(e){return this.parser.parsePmx(e,!0)},THREE.MMDLoader.prototype.parseVmd=function(e){return this.parser.parseVmd(e,!0)},THREE.MMDLoader.prototype.parseVpd=function(e){return this.parser.parseVpd(e,!0)},THREE.MMDLoader.prototype.mergeVmds=function(e){return this.parser.mergeVmds(e)},THREE.MMDLoader.prototype.pourVmdIntoModel=function(e,t,r){this.createAnimation(e,t,r)},THREE.MMDLoader.prototype.pourVmdIntoCamera=function(e,t,r){var a=new THREE.MMDLoader.DataCreationHelper,n=function(){for(var n=a.createOrderedMotionArray(t.cameras),o=[],i=[],s=[],u=[],l=[],p=[],h=[],d=[],c=[],A=new THREE.Quaternion,f=new THREE.Euler,m=new THREE.Vector3,E=new THREE.Vector3,g=function(e,t){e.push(t.x),e.push(t.y),e.push(t.z)},v=function(e,t){e.push(t.x),e.push(t.y),e.push(t.z),e.push(t.w)},M=function(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)},y=function(e,t,r,a,n){if(r.length>2){r=r.slice(),a=a.slice(),n=n.slice();var o=a.length/r.length,i=3===o?12:4,s=2,u=1;for(s=2,endIndex=r.length;s<endIndex;s++){for(var l=0;l<o;l++)if(a[u*o+l]!==a[(u-1)*o+l]||a[u*o+l]!==a[s*o+l]){u++;break}if(s>u){r[u]=r[s];for(var l=0;l<o;l++)a[u*o+l]=a[s*o+l];for(var l=0;l<i;l++)n[u*i+l]=n[s*i+l]}}r.length=u+1,a.length=(u+1)*o,n.length=(u+1)*i}return new THREE.MMDLoader[t](e,r,a,n)},T=0;T<n.length;T++){var R=n[T],H=R.frameNum/30,x=R.position,C=R.rotation,b=R.distance,B=R.fov,k=R.interpolation;m.set(0,0,-b),E.set(x[0],x[1],x[2]),f.set(-C[0],-C[1],-C[2]),A.setFromEuler(f),m.add(E),m.applyQuaternion(A),o.length>0&&H<o[o.length-1]+.05&&(o[o.length-1]=H-1e-13),o.push(H),g(i,E),v(s,A),g(u,m),l.push(B);for(var I=0;I<3;I++)M(p,k,I);M(h,k,3);for(var I=0;I<3;I++)M(d,k,4);M(c,k,5)}if(0!==o.length){var D=[];D.push(y(".center","VectorKeyframeTrackEx",o,i,p)),D.push(y(".quaternion","QuaternionKeyframeTrackEx",o,s,h)),D.push(y(".position","VectorKeyframeTrackEx",o,u,d)),D.push(y(".fov","NumberKeyframeTrackEx",o,l,c));var w=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r,-1,D);null!==w&&(void 0===e.center&&(e.center=new THREE.Vector3(0,0,0)),void 0===e.animations&&(e.animations=[]),e.animations.push(w))}};n()},THREE.MMDLoader.prototype.extractExtension=function(e){var t=e.lastIndexOf(".");return t<0?null:e.slice(t+1)},THREE.MMDLoader.prototype.loadFile=function(e,t,r,a,n,o){var i=new THREE.FileLoader(this.manager);void 0!==o&&i.setMimeType(o),i.setResponseType(n);var s=i.load(e,function(e){t(e)},r,a);return s},THREE.MMDLoader.prototype.loadFileAsBuffer=function(e,t,r,a){this.loadFile(e,t,r,a,"arraybuffer")},THREE.MMDLoader.prototype.loadFileAsText=function(e,t,r,a){this.loadFile(e,t,r,a,"text")},THREE.MMDLoader.prototype.loadFileAsShiftJISText=function(e,t,r,a){this.loadFile(e,t,r,a,"text","text/plain; charset=shift_jis")},THREE.MMDLoader.prototype.createMesh=function(e,t,r,a){var n=this,o=new THREE.BufferGeometry,i=new THREE.MultiMaterial,s=(new THREE.MMDLoader.DataCreationHelper,{});s.vertices=[],s.uvs=[],s.normals=[],s.skinIndices=[],s.skinWeights=[],s.indices=[];var u=function(){for(var t=0;t<e.metadata.vertexCount;t++){for(var r=e.vertices[t],a=0,n=r.position.length;a<n;a++)s.vertices.push(r.position[a]);for(var a=0,n=r.normal.length;a<n;a++)s.normals.push(r.normal[a]);for(var a=0,n=r.uv.length;a<n;a++)s.uvs.push(r.uv[a]);for(var a=0;a<4;a++)s.skinIndices.push(r.skinIndices.length-1>=a?r.skinIndices[a]:0);for(var a=0;a<4;a++)s.skinWeights.push(r.skinWeights.length-1>=a?r.skinWeights[a]:0)}},l=function(){for(var t=0;t<e.metadata.faceCount;t++)for(var r=e.faces[t],a=0,n=r.indices.length;a<n;a++)s.indices.push(r.indices[a])},p=function(){for(var t=[],r=e.rigidBodies,a={},n=0,i=r.length;n<i;n++){var s=r[n],u=a[s.boneIndex];u=void 0===u?s.type:Math.max(s.type,u),a[s.boneIndex]=u}for(var n=0;n<e.metadata.boneCount;n++){var l={},p=e.bones[n];l.parent=p.parentIndex,l.name=p.name,l.pos=[p.position[0],p.position[1],p.position[2]],l.rotq=[0,0,0,1],l.scl=[1,1,1],l.parent!==-1&&(l.pos[0]-=e.bones[l.parent].position[0],l.pos[1]-=e.bones[l.parent].position[1],l.pos[2]-=e.bones[l.parent].position[2]),l.rigidBodyType=void 0!==a[n]?a[n]:-1,t.push(l)}o.bones=t},h=function(){var t=[];if("pmd"===e.metadata.format)for(var r=0;r<e.metadata.ikCount;r++){var a=e.iks[r],n={};n.target=a.target,n.effector=a.effector,n.iteration=a.iteration,n.maxAngle=4*a.maxAngle,n.links=[];for(var i=0;i<a.links.length;i++){var s={};s.index=a.links[i].index,e.bones[s.index].name.indexOf("ひざ")>=0&&(s.limitation=new THREE.Vector3(1,0,0)),n.links.push(s)}t.push(n)}else for(var r=0;r<e.metadata.boneCount;r++){var u=e.bones[r],a=u.ik;if(void 0!==a){var n={};n.target=r,n.effector=a.effector,n.iteration=a.iteration,n.maxAngle=a.maxAngle,n.links=[];for(var i=0;i<a.links.length;i++){var s={};s.index=a.links[i].index,s.enabled=!0,1===a.links[i].angleLimitation&&(s.limitation=new THREE.Vector3(1,0,0)),n.links.push(s)}t.push(n)}}o.iks=t},d=function(){if("pmd"!==e.metadata.format){for(var t=[],r=0;r<e.metadata.boneCount;r++){var a=e.bones[r],n=a.grant;if(void 0!==n){var i={};i.index=r,i.parentIndex=n.parentIndex,i.ratio=n.ratio,i.isLocal=n.isLocal,i.affectRotation=n.affectRotation,i.affectPosition=n.affectPosition,i.transformationClass=a.transformationClass,t.push(i)}}t.sort(function(e,t){return e.transformationClass-t.transformationClass}),o.grants=t}},c=function(){function t(e,t,r,a){e.array[3*t+0]+=r.position[0]*a,e.array[3*t+1]+=r.position[1]*a,e.array[3*t+2]+=r.position[2]*a}function r(r,a,n){for(var o=0;o<a.elementCount;o++){var i,s=a.elements[o];i="pmd"===e.metadata.format?e.morphs[0].elements[s.index].index:s.index,t(r,i,s,n)}}for(var a=[],n=[],i=0;i<e.metadata.morphCount;i++){for(var u=e.morphs[i],l={name:u.name},p=new THREE.Float32BufferAttribute(3*e.metadata.vertexCount,3),h=0;h<3*e.metadata.vertexCount;h++)p.array[h]=s.vertices[h];if("pmd"===e.metadata.format)0!==i&&r(p,u,1);else if(0===u.type)for(var h=0;h<u.elementCount;h++){var d=e.morphs[u.elements[h].index],c=u.elements[h].ratio;1===d.type&&r(p,d,c)}else 1===u.type?r(p,u,1):2===u.type||3===u.type||4===u.type||5===u.type||6===u.type||7===u.type||8===u.type;a.push(l),n.push(p)}o.morphTargets=a,o.morphAttributes.position=n},A=function(){function s(e,o){void 0===o&&(o={});var i;if(o.defaultTexturePath===!0)try{i=n.defaultToonTextures[parseInt(e.match("toon([0-9]{2}).bmp$")[1])]}catch(t){console.warn("THREE.MMDLoader: "+e+" seems like not right default texture path. Using toon00.bmp instead."),i=n.defaultToonTextures[0]}else i=t+e;if(void 0!==d[i])return i;var s=THREE.Loader.Handlers.get(i);null===s&&(s=e.indexOf(".tga")>=0?A:c);var u=s.load(i,function(e){if(o.isToonTexture===!0){var t=e.image,r=t.width,a=t.height;f.width=r,f.height=a,m.clearRect(0,0,r,a),m.translate(r/2,a/2),m.rotate(.5*Math.PI),m.translate(-r/2,-a/2),m.drawImage(t,0,0),e.image=m.getImageData(0,0,r,a)}e.flipY=!1,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,o.sphericalReflectionMapping===!0&&(e.mapping=THREE.SphericalReflectionMapping);for(var n=0;n<u.readyCallbacks.length;n++)u.readyCallbacks[n](u);delete u.readyCallbacks},r,a);return u.readyCallbacks=[],d[i]=u,i}function u(e,t){return void 0===t[e]&&console.warn("THREE.MMDLoader: Undefined texture",e),t[e]}function l(e){e.map.readyCallbacks.push(function(t){function r(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");return r.drawImage(e,0,0),r.getImageData(0,0,t.width,t.height)}function a(e,t,r){var a=e.width,o=e.height,i=e.data,s=253;if(i.length/(a*o)!==4)return!1;for(var u=0;u<r.length;u+=3){for(var l={x:0,y:0},p=0;p<3;p++){var h=r[3*u+p],d={x:t[2*h+0],y:t[2*h+1]};if(n(e,d)<s)return!0;l.x+=d.x,l.y+=d.y}if(l.x/=3,l.y/=3,n(e,l)<s)return!0}return!1}function n(e,t){var r=e.width,a=e.height,n=Math.round(t.x*r)%r,o=Math.round(t.y*a)%a;n<0&&(n+=r),o<0&&(o+=a);var i=o*r+n;return e.data[4*i+3]}var i=void 0!==t.image.data?t.image:r(t.image),s=o.index.array.slice(3*e.faceOffset,3*e.faceOffset+3*e.faceNum);a(i,o.attributes.uv.array,s)&&(e.transparent=!0),delete e.faceOffset,delete e.faceNum})}function p(e){return 10===e.length&&null!==e.match(/toon(10|0[0-9]).bmp/)}function h(e,t){if(8===e.type)for(var r=0;r<t.length;r++){var a=t[r];if(a.index!==-1){var n=i.materials[a.index];n.opacity!==a.diffuse[3]&&(n.transparent=!0)}}}var d={},c=new THREE.TextureLoader(n.manager),A=new THREE.TGALoader(n.manager),f=document.createElement("canvas"),m=f.getContext("2d"),E=0,g=[];null!==n.textureCrossOrigin&&c.setCrossOrigin(n.textureCrossOrigin);for(var v=0;v<e.metadata.materialCount;v++){var M=e.materials[v],y={};if(y.faceOffset=E,y.faceNum=M.faceCount,E+=M.faceCount,y.name=M.name,y.color=new THREE.Color(M.diffuse[0],M.diffuse[1],M.diffuse[2]),y.opacity=M.diffuse[3],y.specular=new THREE.Color(M.specular[0],M.specular[1],M.specular[2]),y.shininess=M.shininess,1===y.opacity?(y.side=THREE.FrontSide,y.transparent=!1):(y.side=THREE.DoubleSide,y.transparent=!0),"pmd"===e.metadata.format){if(M.fileName){var T=M.fileName,R=[],H=T.lastIndexOf("*");H>=0?(R.push(T.slice(0,H)),R.push(T.slice(H+1))):R.push(T);for(var x=0;x<R.length;x++){var C=R[x];C.indexOf(".sph")>=0||C.indexOf(".spa")>=0?(y.envMap=s(C,{sphericalReflectionMapping:!0}),C.indexOf(".sph")>=0?y.envMapType=THREE.MultiplyOperation:y.envMapType=THREE.AddOperation):y.map=s(C)}}}else{if(M.textureIndex!==-1){var C=e.textures[M.textureIndex];y.map=s(C)}if(M.envTextureIndex!==-1&&(1===M.envFlag||2==M.envFlag)){var C=e.textures[M.envTextureIndex];y.envMap=s(C,{sphericalReflectionMapping:!0}),1===M.envFlag?y.envMapType=THREE.MultiplyOperation:y.envMapType=THREE.AddOperation}}var b=void 0===y.map?1:.2;y.emissive=new THREE.Color(M.ambient[0]*b,M.ambient[1]*b,M.ambient[2]*b),g.push(y)}for(var v=0;v<g.length;v++){var B=g[v],k=e.materials[v],M=new THREE.MeshToonMaterial;if(o.addGroup(3*B.faceOffset,3*B.faceNum,v),void 0!==B.name&&(M.name=B.name),M.skinning=o.bones.length>0,M.morphTargets=o.morphTargets.length>0,M.lights=!0,M.side="pmx"===e.metadata.format&&1===(1&k.flag)?THREE.DoubleSide:B.side,M.transparent=B.transparent,M.fog=!0,M.blending=THREE.CustomBlending,M.blendSrc=THREE.SrcAlphaFactor,M.blendDst=THREE.OneMinusSrcAlphaFactor,M.blendSrcAlpha=THREE.SrcAlphaFactor,M.blendDstAlpha=THREE.DstAlphaFactor,void 0!==B.map&&(M.faceOffset=B.faceOffset,M.faceNum=B.faceNum,M.map=u(B.map,d),l(M)),void 0!==B.envMap&&(M.envMap=u(B.envMap,d),M.combine=B.envMapType,M.envMap.readyCallbacks.push(function(e){M.needsUpdate=!0})),M.opacity=B.opacity,M.color=B.color,void 0!==B.emissive&&(M.emissive=B.emissive),M.specular=B.specular,M.shininess=Math.max(B.shininess,1e-4),"pmd"===e.metadata.format){M.outlineParameters={thickness:1===k.edgeFlag?.003:0,color:new THREE.Color(0,0,0),alpha:1},0===M.outlineParameters.thickness&&(M.outlineParameters.visible=!1);var I=k.toonIndex===-1?"toon00.bmp":e.toonTextures[k.toonIndex].fileName,D=s(I,{isToonTexture:!0,defaultTexturePath:p(I)});M.gradientMap=u(D,d)}else{M.outlineParameters={thickness:k.edgeSize/300,color:new THREE.Color(k.edgeColor[0],k.edgeColor[1],k.edgeColor[2]),alpha:k.edgeColor[3]},0!==(16&k.flag)&&0!==M.outlineParameters.thickness||(M.outlineParameters.visible=!1);var I,w;if(k.toonIndex===-1||0!==k.toonFlag){var L=k.toonIndex+1;I="toon"+(L<10?"0"+L:L)+".bmp",w=!0}else I=e.textures[k.toonIndex],w=!1;var D=s(I,{isToonTexture:!0,defaultTexturePath:w});M.gradientMap=u(D,d)}i.materials.push(M)}if("pmx"===e.metadata.format)for(var v=0;v<e.morphs.length;v++){var P=e.morphs[v],Q=P.elements;if(0===P.type)for(var x=0;x<Q.length;x++){var S=e.morphs[Q[x].index],V=S.elements;h(S,V)}else h(P,Q)}},f=function(){for(var t=[],r=[],a=0;a<e.metadata.rigidBodyCount;a++){for(var n=e.rigidBodies[a],i=Object.keys(n),s={},u=0;u<i.length;u++){var l=i[u];s[l]=n[l]}if("pmx"===e.metadata.format&&s.boneIndex!==-1){var p=e.bones[s.boneIndex];s.position[0]-=p.position[0],s.position[1]-=p.position[1],s.position[2]-=p.position[2]}t.push(s)}for(var a=0;a<e.metadata.constraintCount;a++){for(var h=e.constraints[a],i=Object.keys(h),s={},u=0;u<i.length;u++){var l=i[u];s[l]=h[l]}var d=t[s.rigidBodyIndex1],c=t[s.rigidBodyIndex2];0!==d.type&&2===c.type&&d.boneIndex!==-1&&c.boneIndex!==-1&&e.bones[c.boneIndex].parentIndex===d.boneIndex&&(c.type=1),r.push(s)}o.rigidBodies=t,o.constraints=r},m=function(){o.setIndex(new(s.indices.length>65535?THREE.Uint32BufferAttribute:THREE.Uint16BufferAttribute)(s.indices,1)),o.addAttribute("position",new THREE.Float32BufferAttribute(s.vertices,3)),o.addAttribute("normal",new THREE.Float32BufferAttribute(s.normals,3)),o.addAttribute("uv",new THREE.Float32BufferAttribute(s.uvs,2)),o.addAttribute("skinIndex",new THREE.Float32BufferAttribute(s.skinIndices,4)),o.addAttribute("skinWeight",new THREE.Float32BufferAttribute(s.skinWeights,4)),o.computeBoundingSphere(),o.mmdFormat=e.metadata.format};u(),l(),p(),h(),d(),c(),A(),f(),m();var E=new THREE.SkinnedMesh(o,i);return E},THREE.MMDLoader.prototype.createAnimation=function(e,t,r){var a=new THREE.MMDLoader.DataCreationHelper,n=function(){if(0!==t.metadata.motionCount){for(var n=e.geometry.bones,o=a.createOrderedMotionArrays(n,t.motions,"boneName"),i=[],s=function(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)},u=0;u<o.length;u++){for(var l=[],p=[],h=[],d=[],c=[],A=n[u],f=o[u],m=0;m<f.length;m++){var E=f[m].frameNum/30,g=f[m].position,v=f[m].rotation,M=f[m].interpolation;l.push(E);for(var y=0;y<3;y++)p.push(A.pos[y]+g[y]);for(var y=0;y<4;y++)h.push(v[y]);for(var y=0;y<3;y++)s(d,M,y);s(c,M,3)}if(0!==l.length){var T=".bones["+A.name+"]";i.push(new THREE.MMDLoader.VectorKeyframeTrackEx(T+".position",l,p,d)),i.push(new THREE.MMDLoader.QuaternionKeyframeTrackEx(T+".quaternion",l,h,c))}}var R=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r,-1,i);null!==R&&(void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(R))}},o=function(){if(0!==t.metadata.morphCount){for(var n=a.createOrderedMotionArrays(e.geometry.morphTargets,t.morphs,"morphName"),o=[],i=0;i<n.length;i++){for(var s=[],u=[],l=n[i],p=0;p<l.length;p++)s.push(l[p].frameNum/30),u.push(l[p].weight);0!==s.length&&o.push(new THREE.NumberKeyframeTrack(".morphTargetInfluences["+i+"]",s,u))}var h=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r+"Morph",-1,o);null!==h&&(void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(h))}};n(),o()},THREE.MMDLoader.DataCreationHelper=function(){},THREE.MMDLoader.DataCreationHelper.prototype={constructor:THREE.MMDLoader.DataCreationHelper,toCharcodeStrings:function(e){for(var t="",r=0;r<e.length;r++)t+="0x"+("0000"+e[r].charCodeAt().toString(16)).substr(-4);return t},createDictionary:function(e){for(var t={},r=0;r<e.length;r++)t[e[r].name]=r;return t},initializeMotionArrays:function(e){for(var t=[],r=0;r<e.length;r++)t[r]=[];return t},sortMotionArray:function(e){e.sort(function(e,t){return e.frameNum-t.frameNum})},sortMotionArrays:function(e){for(var t=0;t<e.length;t++)this.sortMotionArray(e[t])},createMotionArray:function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t},createMotionArrays:function(e,t,r,a){for(var n=0;n<e.length;n++){var o=e[n],i=r[o[a]];void 0!==i&&t[i].push(o)}},createOrderedMotionArray:function(e){var t=this.createMotionArray(e);return this.sortMotionArray(t),t},createOrderedMotionArrays:function(e,t,r){var a=this.createDictionary(e),n=this.initializeMotionArrays(e);return this.createMotionArrays(t,n,a,r),this.sortMotionArrays(n),n}},THREE.MMDLoader.VectorKeyframeTrackEx=function(e,t,r,a){this.interpolationParameters=new Float32Array(a),THREE.VectorKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.VectorKeyframeTrackEx.prototype=Object.create(THREE.VectorKeyframeTrack.prototype),THREE.MMDLoader.VectorKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.VectorKeyframeTrackEx,THREE.MMDLoader.VectorKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.VectorKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.VectorKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.QuaternionKeyframeTrackEx=function(e,t,r,a){this.interpolationParameters=new Float32Array(a),THREE.QuaternionKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype=Object.create(THREE.QuaternionKeyframeTrack.prototype),THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.QuaternionKeyframeTrackEx,THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.NumberKeyframeTrackEx=function(e,t,r,a){this.interpolationParameters=new Float32Array(a),THREE.NumberKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.NumberKeyframeTrackEx.prototype=Object.create(THREE.NumberKeyframeTrack.prototype),THREE.MMDLoader.NumberKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.NumberKeyframeTrackEx,THREE.MMDLoader.NumberKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.NumberKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.NumberKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.CubicBezierInterpolation=function(e,t,r,a,n){THREE.Interpolant.call(this,e,t,r,a),this.params=n},THREE.MMDLoader.CubicBezierInterpolation.prototype=Object.create(THREE.LinearInterpolant.prototype),THREE.MMDLoader.CubicBezierInterpolation.prototype.constructor=THREE.MMDLoader.CubicBezierInterpolation,THREE.MMDLoader.CubicBezierInterpolation.prototype.interpolate_=function(e,t,r,a){var n=this.resultBuffer,o=this.sampleValues,i=this.valueSize,s=e*i,u=s-i,l=(r-t)/(a-t);if(4===i){var p=this.params[4*e+0],h=this.params[4*e+1],d=this.params[4*e+2],c=this.params[4*e+3],A=this._calculate(p,h,d,c,l);THREE.Quaternion.slerpFlat(n,0,o,u,o,s,A)}else if(3===i)for(var f=0;f!==i;++f){var p=this.params[12*e+4*f+0],h=this.params[12*e+4*f+1],d=this.params[12*e+4*f+2],c=this.params[12*e+4*f+3],A=this._calculate(p,h,d,c,l);n[f]=o[u+f]*(1-A)+o[s+f]*A}else{var p=this.params[4*e+0],h=this.params[4*e+1],d=this.params[4*e+2],c=this.params[4*e+3],A=this._calculate(p,h,d,c,l);n[0]=o[u]*(1-A)+o[s]*A}return n},THREE.MMDLoader.CubicBezierInterpolation.prototype._calculate=function(e,t,r,a,n){for(var o,i,s,u=.5,l=u,p=1-l,h=15,d=1e-5,c=Math,A=0;A<h;A++){o=3*p*p*l,i=3*p*l*l,s=l*l*l;var f=o*e+i*t+s-n;if(c.abs(f)<d)break;u/=2,l+=f<0?u:-u,p=1-l}return o*r+i*a+s},THREE.MMDAudioManager=function(e,t,r){var a=null===r||void 0===r?{}:r;this.audio=e,this.listener=t,this.elapsedTime=0,this.currentTime=0,this.delayTime=void 0!==a.delayTime?a.delayTime:0,this.audioDuration=this.audio.buffer.duration,this.duration=this.audioDuration+this.delayTime},THREE.MMDAudioManager.prototype={constructor:THREE.MMDAudioManager,control:function(e){this.elapsed+=e,this.currentTime+=e,this.checkIfStopAudio()&&this.audio.stop(),this.checkIfStartAudio()&&this.audio.play()},checkIfStartAudio:function(){if(this.audio.isPlaying)return!1;for(;this.currentTime>=this.duration;)this.currentTime-=this.duration;return!(this.currentTime<this.delayTime)&&(this.audio.startTime=this.currentTime-this.delayTime,!0)},checkIfStopAudio:function(){return!!this.audio.isPlaying&&this.currentTime>=this.duration}},THREE.MMDGrantSolver=function(e){this.mesh=e},THREE.MMDGrantSolver.prototype={constructor:THREE.MMDGrantSolver,update:function(){var e=new THREE.Quaternion;return function(){for(var t=0;t<this.mesh.geometry.grants.length;t++){var r=this.mesh.geometry.grants[t],a=this.mesh.skeleton.bones[r.index],n=this.mesh.skeleton.bones[r.parentIndex];r.isLocal?(r.affectPosition,r.affectRotation):(r.affectPosition,r.affectRotation&&(e.set(0,0,0,1),e.slerp(n.quaternion,r.ratio),a.quaternion.multiply(e)))}}}()},THREE.MMDHelper=function(){this.meshes=[],this.doAnimation=!0,this.doIk=!0,this.doGrant=!0,this.doPhysics=!0,this.doCameraAnimation=!0,this.sharedPhysics=!1,this.masterPhysics=null,this.audioManager=null,this.camera=null},THREE.MMDHelper.prototype={constructor:THREE.MMDHelper,add:function(e){if(!(e instanceof THREE.SkinnedMesh))throw new Error("THREE.MMDHelper.add() accepts only THREE.SkinnedMesh instance.");void 0===e.mixer&&(e.mixer=null),void 0===e.ikSolver&&(e.ikSolver=null),void 0===e.grantSolver&&(e.grantSolver=null),void 0===e.physics&&(e.physics=null),void 0===e.looped&&(e.looped=!1),this.meshes.push(e),this.initBackupBones(e)},setAudio:function(e,t,r){this.audioManager=new THREE.MMDAudioManager(e,t,r)},setCamera:function(e){e.mixer=null,this.camera=e},setPhysicses:function(e){for(var t=0;t<this.meshes.length;t++)this.setPhysics(this.meshes[t],e)},setPhysics:function(e,t){if(t=void 0===t?{}:Object.assign({},t),void 0===t.world&&this.sharedPhysics){var r=this.getMasterPhysics();null!==r&&(t.world=r.world)}var a=void 0!==t.warmup?t.warmup:60,n=new THREE.MMDPhysics(e,t);null!==e.mixer&&void 0!==e.mixer&&t.preventAnimationWarmup!==!0&&(this.animateOneMesh(0,e),n.reset()),n.warmup(a),this.updateIKParametersDependingOnPhysicsEnabled(e,!0),e.physics=n},getMasterPhysics:function(){if(null!==this.masterPhysics)return this.masterPhysics;for(var e=0,t=this.meshes.length;e<t;e++){var r=this.meshes[e].physics;if(void 0!==r&&null!==r)return this.masterPhysics=r,this.masterPhysics}return null},enablePhysics:function(e){e===!0?this.doPhysics=!0:this.doPhysics=!1;for(var t=0,r=this.meshes.length;t<r;t++)this.updateIKParametersDependingOnPhysicsEnabled(this.meshes[t],e)},updateIKParametersDependingOnPhysicsEnabled:function(e,t){for(var r=e.geometry.iks,a=e.geometry.bones,n=0,o=r.length;n<o;n++)for(var i=r[n],s=i.links,u=0,l=s.length;u<l;u++){var p=s[u];t===!0?p.enabled=!(a[p.index].rigidBodyType>0):p.enabled=!0}},setAnimations:function(){for(var e=0;e<this.meshes.length;e++)this.setAnimation(this.meshes[e])},setAnimation:function(e){if(void 0!==e.geometry.animations){e.mixer=new THREE.AnimationMixer(e),e.mixer.addEventListener("loop",function(e){if(0===e.action._clip.tracks[0].name.indexOf(".bones")){var t=e.target._root;t.looped=!0}});for(var t=!1,r=!1,a=0;a<e.geometry.animations.length;a++){var n=e.geometry.animations[a],o=e.mixer.clipAction(n);0===n.tracks[0].name.indexOf(".morphTargetInfluences")?r||(o.play(),r=!0):t||(o.play(),t=!0)}t&&(e.ikSolver=new THREE.CCDIKSolver(e),void 0!==e.geometry.grants&&(e.grantSolver=new THREE.MMDGrantSolver(e)))}},setCameraAnimation:function(e){void 0!==e.animations&&(e.mixer=new THREE.AnimationMixer(e),e.mixer.clipAction(e.animations[0]).play())},unifyAnimationDuration:function(e){e=void 0===e?{}:e;for(var t=0,r=this.camera,a=this.audioManager,n=0;n<this.meshes.length;n++){var o=this.meshes[n],i=o.mixer;if(null!==i)for(var s=0;s<i._actions.length;s++){var u=i._actions[s];t=Math.max(t,u._clip.duration)}}if(null!==r&&null!==r.mixer)for(var i=r.mixer,n=0;n<i._actions.length;n++){var u=i._actions[n];t=Math.max(t,u._clip.duration)}null!==a&&(t=Math.max(t,a.duration)),void 0!==e.afterglow&&(t+=e.afterglow);for(var n=0;n<this.meshes.length;n++){var o=this.meshes[n],i=o.mixer;if(null!==i)for(var s=0;s<i._actions.length;s++){var u=i._actions[s];u._clip.duration=t}}if(null!==r&&null!==r.mixer)for(var i=r.mixer,n=0;n<i._actions.length;n++){var u=i._actions[n];u._clip.duration=t}null!==a&&(a.duration=t)},controlAudio:function(e){null!==this.audioManager&&this.audioManager.control(e)},animate:function(e){this.controlAudio(e);for(var t=0;t<this.meshes.length;t++)this.animateOneMesh(e,this.meshes[t]);this.sharedPhysics&&this.updateSharedPhysics(e),this.animateCamera(e)},animateOneMesh:function(e,t){var r=t.mixer,a=t.ikSolver,n=t.grantSolver,o=t.physics;null!==r&&this.doAnimation===!0&&(this.restoreBones(t),r.update(e),this.backupBones(t)),null!==a&&this.doIk===!0&&a.update(),null!==n&&this.doGrant===!0&&n.update(),t.looped===!0&&(null!==o&&o.reset(),t.looped=!1),null!==o&&this.doPhysics&&!this.sharedPhysics&&o.update(e)},updateSharedPhysics:function(e){if(0!==this.meshes.length&&this.doPhysics&&this.sharedPhysics){var t=this.getMasterPhysics();if(null!==t){for(var r=0,a=this.meshes.length;r<a;r++){var n=this.meshes[r].physics;null!==n&&void 0!==n&&n.updateRigidBodies()}t.stepSimulation(e);for(var r=0,a=this.meshes.length;r<a;r++){var n=this.meshes[r].physics;null!==n&&void 0!==n&&n.updateBones()}}}},animateCamera:function(e){if(null!==this.camera){var t=this.camera.mixer;null!==t&&void 0!==this.camera.center&&this.doCameraAnimation===!0&&(t.update(e),this.camera.updateProjectionMatrix(),this.camera.up.set(0,1,0),this.camera.up.applyQuaternion(this.camera.quaternion),this.camera.lookAt(this.camera.center))}},poseAsVpd:function(e,t,r){void 0===r&&(r={}),r.preventResetPose!==!0&&e.pose();for(var a=e.skeleton.bones,n=t.bones,o={},i=0;i<a.length;i++)o[a[i].name]=i;for(var s=new THREE.Vector3,u=new THREE.Quaternion,i=0;i<n.length;i++){var l=n[i],p=o[l.name];if(void 0!==p){var h=a[p],d=l.translation,c=l.quaternion;s.set(d[0],d[1],d[2]),u.set(c[0],c[1],c[2],c[3]),h.position.add(s),h.quaternion.multiply(u)}}if(e.updateMatrixWorld(!0),r.preventIk!==!0){var A=new THREE.CCDIKSolver(e);A.update(r.saveOriginalBonesBeforeIK)}if(r.preventGrant!==!0&&void 0!==e.geometry.grants){var A=new THREE.MMDGrantSolver(e);A.update()}},initBackupBones:function(e){e.skeleton.backupBones=[];for(var t=0;t<e.skeleton.bones.length;t++)e.skeleton.backupBones.push(e.skeleton.bones[t].clone())},backupBones:function(e){e.skeleton.backupBoneIsSaved=!0;for(var t=0;t<e.skeleton.bones.length;t++){var r=e.skeleton.backupBones[t],a=e.skeleton.bones[t];r.position.copy(a.position),r.quaternion.copy(a.quaternion)}},restoreBones:function(e){if(e.skeleton.backupBoneIsSaved===!0){e.skeleton.backupBoneIsSaved=!1;for(var t=0;t<e.skeleton.bones.length;t++){var r=e.skeleton.bones[t],a=e.skeleton.backupBones[t];r.position.copy(a.position),r.quaternion.copy(a.quaternion)}}}};