<!DOCTYPE html><html lang="en"><head>
		<title>three.js webgl - materials - dynamic cube reflection</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,minimum-scale=1,maximum-scale=1">
		<style>
			body {
				background: #000;
				color: #333;
				padding: 0;
				margin: 0;
				overflow: hidden;
				font-family: georgia;
				font-size:1em;
				text-align: center;
			}
			a { color: white }

			#info { position: absolute; top: 10px; width: 100%; }
			#container { position: absolute; top: 0px; }
			#footer { position: absolute; bottom: 10px; width: 100%; }

			.h { color: skyblue }
			.c { display: inline; margin-left: 1em }
		</style>
	</head>

	<body>
		<div id="container"></div>

		<div id="info">
			<a href="http://threejs.org" target="_blank">three.js</a> - webgl dynamic cube reflection demo -
			veyron by <a href="http://artist-3d.com/free_3d_models/dnm/model_disp.php?uid=1129" target="_blank">Troyano</a> -
			gallardo by <a href="http://artist-3d.com/free_3d_models/dnm/model_disp.php?uid=1711" target="_blank">machman_3d</a>
		</div>

		<div id="footer">
			cars control: <span class="h">WASD</span> / <span class="h">arrows</span>

			<div class="c">cameras: <span class="h">1</span> / <span class="h">2</span> / <span class="h">3</span> / <span class="h">4</span>
			/ <span class="h">5</span> / <span class="h">6</span>
			</div>

			<div class="c">
			day / night: <span class="h">n</span>
			</div>

			<div class="c">
			motion blur: <span class="h">b</span>
			</div>
		</div>

		<script src="../build/three.js"></script>

		<script src="js/loaders/BinaryLoader.js"></script>

		<script src="js/shaders/BleachBypassShader.js"></script>
		<script src="js/shaders/BlendShader.js"></script>
		<script src="js/shaders/ConvolutionShader.js"></script>
		<script src="js/shaders/CopyShader.js"></script>
		<script src="js/shaders/FXAAShader.js"></script>
		<script src="js/shaders/HorizontalTiltShiftShader.js"></script>
		<script src="js/shaders/VerticalTiltShiftShader.js"></script>
		<script src="js/shaders/TriangleBlurShader.js"></script>
		<script src="js/shaders/VignetteShader.js"></script>

		<script src="js/postprocessing/EffectComposer.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
		<script src="js/postprocessing/BloomPass.js"></script>
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script>
		<script src="js/postprocessing/SavePass.js"></script>

		<script src="js/Car.js"></script>
		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>

		<script>function init(){container=document.getElementById("container"),camera=new THREE.PerspectiveCamera(18,SCREEN_WIDTH/SCREEN_HEIGHT,1,1e5),camera.position.set(3e3,0,3e3),cameraTarget=new THREE.Vector3,scene=new THREE.Scene,scene.fog=new THREE.Fog(16777215,3e3,1e4),scene.fog.color.setHSL(.51,.6,.6),createScene(),ambientLight=new THREE.AmbientLight(5592405),scene.add(ambientLight),spotLight=new THREE.SpotLight(16777215,1,0,Math.PI/2),spotLight.position.set(0,1800,1500),spotLight.target.position.set(0,0,0),spotLight.castShadow=!0,spotLight.shadow.camera.near=100,spotLight.shadow.camera.far=camera.far,spotLight.shadow.camera.fov=50,spotLight.shadow.bias=-.00125,spotLight.shadow.mapSize.width=SHADOW_MAP_WIDTH,spotLight.shadow.mapSize.height=SHADOW_MAP_HEIGHT,scene.add(spotLight),renderer=new THREE.WebGLRenderer({antialias:!1}),renderer.setClearColor(scene.fog.color),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),container.appendChild(renderer.domElement),renderer.shadowMap.renderReverseSided=!1,renderer.shadowMap.enabled=!0,stats=new Stats,container.appendChild(stats.dom),cubeCamera=new THREE.CubeCamera(1,1e5,128),scene.add(cubeCamera);var e=cubeCamera.renderTarget.texture;mlib={body:[],Chrome:new THREE.MeshLambertMaterial({color:16777215,envMap:e}),"Dark chrome":new THREE.MeshLambertMaterial({color:4473924,envMap:e}),"Black rough":new THREE.MeshLambertMaterial({color:328965}),"Dark glass":new THREE.MeshLambertMaterial({color:1052704,envMap:e,opacity:.5,transparent:!0}),"Orange glass":new THREE.MeshLambertMaterial({color:16759552,opacity:.5,transparent:!0}),"Red glass":new THREE.MeshLambertMaterial({color:16711680,opacity:.5,transparent:!0}),"Black metal":new THREE.MeshLambertMaterial({color:2236962,envMap:e,combine:THREE.MultiplyOperation}),"Orange metal":new THREE.MeshLambertMaterial({color:16737792,envMap:e,combine:THREE.MultiplyOperation})},mlib.body.push(["Orange",new THREE.MeshLambertMaterial({color:8925952,envMap:e,combine:THREE.MixOperation,reflectivity:.1})]),mlib.body.push(["Blue",new THREE.MeshLambertMaterial({color:1127253,envMap:e,combine:THREE.MixOperation,reflectivity:.1})]),mlib.body.push(["Red",new THREE.MeshLambertMaterial({color:6684672,envMap:e,combine:THREE.MixOperation,reflectivity:.1})]),mlib.body.push(["Black",new THREE.MeshLambertMaterial({color:0,envMap:e,combine:THREE.MixOperation,reflectivity:.2})]),mlib.body.push(["White",new THREE.MeshLambertMaterial({color:16777215,envMap:e,combine:THREE.MixOperation,reflectivity:.2})]),mlib.body.push(["Carmine",new THREE.MeshPhongMaterial({color:7798784,specular:16755370,envMap:e,combine:THREE.MultiplyOperation})]),mlib.body.push(["Gold",new THREE.MeshPhongMaterial({color:11180356,specular:12298905,shininess:50,envMap:e,combine:THREE.MultiplyOperation})]),mlib.body.push(["Bronze",new THREE.MeshPhongMaterial({color:1377541,specular:15623680,shininess:10,envMap:e,combine:THREE.MixOperation,reflectivity:.2})]),mlib.body.push(["Chrome",new THREE.MeshPhongMaterial({color:16777215,specular:16777215,envMap:e,combine:THREE.MultiplyOperation})]);var a=new THREE.TextureLoader;flareA=a.load("textures/lensflare2.jpg"),flareB=a.load("textures/lensflare0.png"),veyron=new THREE.Car,veyron.modelScale=3,veyron.backWheelOffset=2,veyron.callback=function(e){addCar(e,-300,-215,0,0),setMaterialsVeyron(e);for(var a=2,r=5,o={a:{map:flareA,color:16777215,blending:THREE.AdditiveBlending},b:{map:flareB,color:16777215,blending:THREE.AdditiveBlending},ar:{map:flareA,color:16711680,blending:THREE.AdditiveBlending},br:{map:flareB,color:16711680,blending:THREE.AdditiveBlending}},t=[["a",a,[47,38,120]],["a",a,[40,38,120]],["a",a,[32,38,122]],["b",r,[47,38,120]],["b",r,[40,38,120]],["b",r,[32,38,122]],["a",a,[-47,38,120]],["a",a,[-40,38,120]],["a",a,[-32,38,122]],["b",r,[-47,38,120]],["b",r,[-40,38,120]],["b",r,[-32,38,122]],["ar",a,[22,50,-123]],["ar",a,[32,49,-123]],["br",r,[22,50,-123]],["br",r,[32,49,-123]],["ar",a,[-22,50,-123]],["ar",a,[-32,49,-123]],["br",r,[-22,50,-123]],["br",r,[-32,49,-123]]],n=0;n<t.length;n++){var i=o[t[n][0]],l=t[n][1],s=t[n][2][0],d=t[n][2][1],c=t[n][2][2],E=new THREE.SpriteMaterial(i),m=new THREE.Sprite(E),b=128,p=128;m.scale.set(l*b,l*p,l),m.position.set(s,d,c),e.bodyMesh.add(m),sprites.push(m)}},veyron.loadPartsBinary("obj/veyron/parts/veyron_body_bin.js","obj/veyron/parts/veyron_wheel_bin.js"),gallardo=new THREE.Car,gallardo.modelScale=2,gallardo.backWheelOffset=45,gallardo.callback=function(e){addCar(e,300,-110,0,-110),setMaterialsGallardo(e);for(var a=2,r=5,o={a:{map:flareA,color:16777215,blending:THREE.AdditiveBlending},b:{map:flareB,color:16777215,blending:THREE.AdditiveBlending},ar:{map:flareA,color:16711680,blending:THREE.AdditiveBlending},br:{map:flareB,color:16711680,blending:THREE.AdditiveBlending}},t=[["a",a,[70,10,160]],["a",a,[66,-1,175]],["a",a,[66,-1,165]],["b",r,[70,10,160]],["b",r,[66,-1,175]],["b",r,[66,-1,165]],["a",a,[-70,10,160]],["a",a,[-66,-1,175]],["a",a,[-66,-1,165]],["b",r,[-70,10,160]],["b",r,[-66,-1,175]],["b",r,[-66,-1,165]],["ar",a,[61,19,-185]],["ar",a,[55,19,-185]],["br",r,[61,19,-185]],["br",r,[55,19,-185]],["ar",a,[-61,19,-185]],["ar",a,[-55,19,-185]],["br",r,[-61,19,-185]],["br",r,[-55,19,-185]]],n=0;n<t.length;n++){var i=o[t[n][0]],l=t[n][1],s=t[n][2][0],d=t[n][2][1],c=t[n][2][2],E=new THREE.SpriteMaterial(i),m=new THREE.Sprite(E),b=128,p=128;m.scale.set(l*b,l*p,l),m.position.set(s,d,c),e.bodyMesh.add(m),sprites.push(m)}},gallardo.loadPartsBinary("obj/gallardo/parts/gallardo_body_bin.js","obj/gallardo/parts/gallardo_wheel_bin.js"),config.gallardo.model=gallardo,config.veyron.model=veyron,currentCar=gallardo,document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),window.addEventListener("resize",onWindowResize,!1),renderer.autoClear=!1;var r={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};renderTarget=new THREE.WebGLRenderTarget(SCREEN_WIDTH,SCREEN_HEIGHT,r),effectSave=new THREE.SavePass(new THREE.WebGLRenderTarget(SCREEN_WIDTH,SCREEN_HEIGHT,r)),effectBlend=new THREE.ShaderPass(THREE.BlendShader,"tDiffuse1"),effectFXAA=new THREE.ShaderPass(THREE.FXAAShader);var o=new THREE.ShaderPass(THREE.VignetteShader),t=new THREE.ShaderPass(THREE.BleachBypassShader);effectBloom=new THREE.BloomPass(.75),effectFXAA.uniforms.resolution.value.set(1/SCREEN_WIDTH,1/SCREEN_HEIGHT),hblur=new THREE.ShaderPass(THREE.HorizontalTiltShiftShader),vblur=new THREE.ShaderPass(THREE.VerticalTiltShiftShader);var n=7;hblur.uniforms.h.value=n/SCREEN_WIDTH,vblur.uniforms.v.value=n/SCREEN_HEIGHT,FOLLOW_CAMERA?currentCar==gallardo?hblur.uniforms.r.value=vblur.uniforms.r.value=rMap.gallardo:currentCar==veyron&&(hblur.uniforms.r.value=vblur.uniforms.r.value=rMap.veyron):hblur.uniforms.r.value=vblur.uniforms.r.value=.35,o.uniforms.offset.value=1.05,o.uniforms.darkness.value=1.5,effectBlend.uniforms.tDiffuse2.value=effectSave.renderTarget.texture,effectBlend.uniforms.mixRatio.value=.65;var i=new THREE.RenderPass(scene,camera);o.renderToScreen=!0,composer=new THREE.EffectComposer(renderer,renderTarget),composer.addPass(i),composer.addPass(effectFXAA),composer.addPass(effectBlend),composer.addPass(effectSave),composer.addPass(effectBloom),composer.addPass(t),composer.addPass(hblur),composer.addPass(vblur),composer.addPass(o)}function setSpritesOpacity(e){for(var a=0;a<sprites.length;a++)sprites[a].material.opacity=e}function createScene(){var e=(new THREE.TextureLoader).load("textures/cube/Park3Med/ny.jpg");e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(50,50),groundBasic=new THREE.MeshBasicMaterial({color:16777215,map:e}),groundBasic.color.setHSL(.1,.9,.7),ground=new THREE.Mesh(new THREE.PlaneBufferGeometry(5e4,5e4),groundBasic),ground.position.y=-215,ground.rotation.x=-Math.PI/2,scene.add(ground),ground.castShadow=!1,ground.receiveShadow=!0;var a=new THREE.CylinderGeometry(2,50,1e3,32),r=new THREE.SphereGeometry(100,32,16),o=-462,t=-88;addObject(a,16711680,1500,250,0,o),addObject(a,16755200,-1500,250,0,o),addObject(a,65280,0,250,1500,o),addObject(a,65450,0,250,-1500,o),addObject(r,16711680,1500,-125,200,t),addObject(r,16755200,-1500,-125,200,t),addObject(r,65280,200,-125,1500,t),addObject(r,65450,200,-125,-1500,t)}function addObject(e,a,r,o,t,n){var i=new THREE.Mesh(e,new THREE.MeshLambertMaterial({color:a}));i.position.set(r,o,t),i.castShadow=!0,i.receiveShadow=!0,scene.add(i);var l=new THREE.Mesh(shadowPlane,shadowMaterial);l.position.y=n,l.rotation.x=-Math.PI/2,i.add(l)}function generateDropShadowTexture(e,a,r,o){var t={minFilter:THREE.LinearMipmapLinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},n=new THREE.WebGLRenderTarget(a,r,t),i=new THREE.MeshBasicMaterial({color:0}),l=e.geometry.clone(),s=new THREE.Mesh(l,i),d=new THREE.Scene;d.add(s),s.geometry.computeBoundingBox();var c=s.geometry.boundingBox,E=new THREE.Vector3;E.subVectors(c.max,c.min);var m=.15,a=E.z,r=E.x,b=E.y,p=c.min.z-m*a,u=c.max.z+m*a,h=c.max.x+m*r,v=c.min.x-m*r,g=c.max.y+m*b,f=c.min.y-m*b,T=new THREE.OrthographicCamera(p,u,h,v,g,f);T.position.y=c.max.y,T.lookAt(d.position),d.add(T);var R=new THREE.RenderPass(d,T),H=THREE.TriangleBlurShader,w=new THREE.ShaderPass(H,"texture"),M=new THREE.ShaderPass(H,"texture");R.clearColor=new THREE.Color(0),R.clearAlpha=0;var y=o/a,C=o/r;w.uniforms.delta.value=new THREE.Vector2(y,0),M.uniforms.delta.value=new THREE.Vector2(0,C);var S=new THREE.EffectComposer(renderer,n);return S.addPass(R),S.addPass(w),S.addPass(M),renderer.clear(),S.render(.1),n}function addCar(e,a,r,o,t){e.root.position.set(a,r,o),scene.add(e.root),e.enableShadows(!0),FOLLOW_CAMERA&&e==currentCar&&(e.root.add(camera),camera.position.set(350,500,2200),cameraTarget.z=500,cameraTarget.y=150,camera.lookAt(cameraTarget));var n=generateDropShadowTexture(e.bodyMesh,64,32,15);e.bodyMesh.geometry.computeBoundingBox();var i=e.bodyMesh.geometry.boundingBox,l=1.1*e.modelScale,s=l*(i.max.z-i.min.z),d=1.25*l*(i.max.x-i.min.x),c=new THREE.PlaneBufferGeometry(s,d),E=new THREE.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,map:n.texture,polygonOffset:!1,polygonOffsetFactor:-.5,polygonOffsetUnits:1}),m=new THREE.Mesh(c,E);m.position.y=t+10,m.rotation.x=-Math.PI/2,m.rotation.z=Math.PI/2,e.root.add(m)}function setCurrentCar(e,a){var r=currentCar;currentCar=config[e].model,"front"==a||"back"==a?(hblur.uniforms.r.value=vblur.uniforms.r.value=config[e].r,FOLLOW_CAMERA=!0,r.root.remove(camera),currentCar.root.add(camera),"front"==a?camera.position.set(350,500,2200):"back"==a&&camera.position.copy(config[e].backCam),cameraTarget.set(0,150,500)):(FOLLOW_CAMERA=!1,r.root.remove(camera),camera.position.set(2e3,0,2e3),cameraTarget.set(0,0,0),spotLight.position.set(0,1800,1500),hblur.uniforms.r.value=vblur.uniforms.r.value=.35)}function onWindowResize(e){SCREEN_WIDTH=window.innerWidth,SCREEN_HEIGHT=window.innerHeight,camera.aspect=SCREEN_WIDTH/SCREEN_HEIGHT,camera.updateProjectionMatrix(),renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),composer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),hblur.uniforms.h.value=10.75/SCREEN_WIDTH,vblur.uniforms.v.value=10.75/SCREEN_HEIGHT,effectFXAA.uniforms.resolution.value.set(1/SCREEN_WIDTH,1/SCREEN_HEIGHT)}function onKeyDown(e){switch(e.keyCode){case 38:controlsGallardo.moveForward=!0;break;case 87:controlsVeyron.moveForward=!0;break;case 40:controlsGallardo.moveBackward=!0;break;case 83:controlsVeyron.moveBackward=!0;break;case 37:controlsGallardo.moveLeft=!0;break;case 65:controlsVeyron.moveLeft=!0;break;case 39:controlsGallardo.moveRight=!0;break;case 68:controlsVeyron.moveRight=!0;break;case 49:setCurrentCar("gallardo","center");break;case 50:setCurrentCar("veyron","center");break;case 51:setCurrentCar("gallardo","front");break;case 52:setCurrentCar("veyron","front");break;case 53:setCurrentCar("gallardo","back");break;case 54:setCurrentCar("veyron","back");break;case 78:vdir*=-1;break;case 66:blur=!blur}}function onKeyUp(e){switch(e.keyCode){case 38:controlsGallardo.moveForward=!1;break;case 87:controlsVeyron.moveForward=!1;break;case 40:controlsGallardo.moveBackward=!1;break;case 83:controlsVeyron.moveBackward=!1;break;case 37:controlsGallardo.moveLeft=!1;break;case 65:controlsVeyron.moveLeft=!1;break;case 39:controlsGallardo.moveRight=!1;break;case 68:controlsVeyron.moveRight=!1}}function setMaterialsGallardo(e){var a=e.bodyMaterials;a[0]=mlib.body[0][1],a[1]=mlib["Dark chrome"],a=e.wheelMaterials,a[0]=mlib.Chrome,a[1]=mlib["Black rough"]}function setMaterialsVeyron(e){var a=e.bodyMaterials;a[0]=mlib["Black metal"],a[1]=mlib.Chrome,a[2]=mlib.Chrome,a[3]=mlib["Dark chrome"],a[4]=mlib["Red glass"],a[5]=mlib["Orange glass"],a[6]=mlib["Black rough"],a[7]=mlib["Dark glass"],a=e.wheelMaterials,a[0]=mlib.Chrome,a[1]=mlib["Black rough"]}function animate(){requestAnimationFrame(animate),render(),stats.update()}function render(){var e=clock.getDelta();v=THREE.Math.clamp(v+.5*e*vdir,.1,.9),scene.fog.color.setHSL(.51,.5,.75*v),renderer.setClearColor(scene.fog.color);var a=(v-.05)/.85;setSpritesOpacity(a<.3?1-v/.3:0),veyron.loaded&&(veyron.bodyMaterials[1]=mlib.Chrome,veyron.bodyMaterials[2]=mlib.Chrome,veyron.wheelMaterials[0]=mlib.Chrome),gallardo.loaded&&(gallardo.wheelMaterials[0]=mlib.Chrome),effectBloom.copyUniforms.opacity.value=THREE.Math.mapLinear(a,0,1,1,.75),ambientLight.color.setHSL(0,0,THREE.Math.mapLinear(a,0,1,.1,.3)),groundBasic.color.setHSL(.1,.5,THREE.Math.mapLinear(a,0,1,.4,.65)),blur?(effectSave.enabled=!0,effectBlend.enabled=!0):(effectSave.enabled=!1,effectBlend.enabled=!1),veyron.updateCarModel(e,controlsVeyron),gallardo.updateCarModel(e,controlsGallardo),FOLLOW_CAMERA?(spotLight.position.x=currentCar.root.position.x-500,spotLight.position.z=currentCar.root.position.z-500):(cameraTarget.x=currentCar.root.position.x,cameraTarget.z=currentCar.root.position.z),spotLight.target.position.x=currentCar.root.position.x,spotLight.target.position.z=currentCar.root.position.z;var r=!0;r&&(veyron.setVisible(!1),gallardo.setVisible(!1),cubeCamera.position.copy(currentCar.root.position),renderer.autoClear=!0,cubeCamera.updateCubeMap(renderer,scene),veyron.setVisible(!0),gallardo.setVisible(!0)),renderer.autoClear=!1,renderer.shadowMap.enabled=!0,camera.lookAt(cameraTarget),renderer.setRenderTarget(null),renderer.clear(),composer.render(.1),renderer.shadowMap.enabled=!1}Detector.webgl||Detector.addGetWebGLMessage();var FOLLOW_CAMERA=!1,SCREEN_WIDTH=window.innerWidth,SCREEN_HEIGHT=window.innerHeight,SHADOW_MAP_WIDTH=1024,SHADOW_MAP_HEIGHT=1024,container,stats,camera,cameraTarget,scene,renderer,renderTarget,spotLight,ambientLight,cubeCamera,clock=new THREE.Clock,controlsGallardo={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1},controlsVeyron={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1},mlib,gallardo,veyron,currentCar,effectDirt,hblur,vblur,effectBloom,effectKeep,effectBlend,effectFXAA,config={veyron:{r:.5,model:null,backCam:new THREE.Vector3(550,100,-1e3)},gallardo:{r:.35,model:null,backCam:new THREE.Vector3(550,0,-1500)}},flareA,flareB,sprites=[],ground,groundBasic,blur=!1,v=.9,vdir=1;init(),animate();var canvas=document.createElement("canvas");canvas.width=128,canvas.height=128;var context=canvas.getContext("2d"),gradient=context.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,canvas.width/2);gradient.addColorStop(.1,"rgba(0,0,0,1)"),gradient.addColorStop(1,"rgba(0,0,0,0)"),context.fillStyle=gradient,context.fillRect(0,0,canvas.width,canvas.height);var shadowTexture=new THREE.CanvasTexture(canvas),shadowPlane=new THREE.PlaneBufferGeometry(400,400),shadowMaterial=new THREE.MeshBasicMaterial({opacity:.35,transparent:!0,map:shadowTexture,polygonOffset:!1,polygonOffsetFactor:-.5,polygonOffsetUnits:1});</script>

	

</body></html>