var Script=function(e){var t=e.signals,r=new UI.Panel;r.setId("script"),r.setPosition("absolute"),r.setBackgroundColor("#272822"),r.setDisplay("none");var a=new UI.Panel;a.setPadding("10px"),r.add(a);var n=(new UI.Text).setColor("#fff");a.add(n);var i=function(){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width",32),e.setAttribute("height",32);var t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M 12,12 L 22,22 M 22,12 12,22"),t.setAttribute("stroke","#fff"),e.appendChild(t),e}(),s=new UI.Element(i);s.setPosition("absolute"),s.setTop("3px"),s.setRight("1px"),s.setCursor("pointer"),s.onClick(function(){r.setDisplay("none")}),a.add(s);var o;t.rendererChanged.add(function(e){o=e});var l,u,c,d,m=CodeMirror(r.dom,{value:"",lineNumbers:!0,matchBrackets:!0,indentWithTabs:!0,tabSize:4,indentUnit:4,hintOptions:{completeSingle:!1}});m.setOption("theme","monokai"),m.on("change",function(){m.state.focused!==!1&&(clearTimeout(l),l=setTimeout(function(){var t=m.getValue();if(v(t)){if("object"==typeof c)return void(t!==c.source&&e.execute(new SetScriptValueCommand(d,c,"source",t,m.getCursor())));if("programInfo"===c){var r=JSON.parse(t);if(JSON.stringify(d.material.defines)!==JSON.stringify(r.defines)){var a=new SetMaterialValueCommand(d,"defines",r.defines);a.updatable=!1,e.execute(a)}if(JSON.stringify(d.material.uniforms)!==JSON.stringify(r.uniforms)){var a=new SetMaterialValueCommand(d,"uniforms",r.uniforms);a.updatable=!1,e.execute(a)}if(JSON.stringify(d.material.attributes)!==JSON.stringify(r.attributes)){var a=new SetMaterialValueCommand(d,"attributes",r.attributes);a.updatable=!1,e.execute(a)}}}},300))});var f=m.getWrapperElement();f.addEventListener("keydown",function(e){e.stopPropagation()});var p=[],g=[],v=function(e){var r,a=[];return m.operation(function(){for(;p.length>0;)m.removeLineClass(p.shift(),"background","errorLine");for(;g.length>0;)m.removeLineWidget(g.shift());switch(u){case"javascript":try{var n=esprima.parse(e,{tolerant:!0});a=n.errors}catch(e){a.push({lineNumber:e.lineNumber-1,message:e.message})}for(var i=0;i<a.length;i++){var s=a[i];s.message=s.message.replace(/Line [0-9]+: /,"")}break;case"json":a=[],jsonlint.parseError=function(e,t){e=e.split("\n")[3],a.push({lineNumber:t.loc.first_line-1,message:e})};try{jsonlint.parse(e)}catch(e){}break;case"glsl":try{var l="vertexShader"===c?glslprep.Shader.VERTEX:glslprep.Shader.FRAGMENT;glslprep.parseGlsl(e,l)}catch(e){e instanceof glslprep.SyntaxError?a.push({lineNumber:e.line,message:"Syntax Error: "+e.message}):console.error(e.stack||e)}if(0!==a.length)break;if(o instanceof THREE.WebGLRenderer==!1)break;d.material[c]=e,d.material.needsUpdate=!0,t.materialChanged.dispatch(d.material);var f=o.info.programs;r=!0;for(var v=/^(?:ERROR|WARNING): \d+:(\d+): (.*)/g,i=0,h=f.length;i!==h;++i){var b=f[i].diagnostics;if(void 0!==b&&b.material===d.material){b.runnable||(r=!1);for(var S=b[c],y=S.prefix.split(/\r\n|\r|\n/).length;;){var C=v.exec(S.log);if(null===C)break;a.push({lineNumber:C[1]-y,message:C[2]})}break}}}for(var i=0;i<a.length;i++){var s=a[i],w=document.createElement("div");w.className="esprima-error",w.textContent=s.message;var N=Math.max(s.lineNumber,0);p.push(N),m.addLineClass(N,"background","errorLine");var k=m.addLineWidget(N,w);g.push(k)}return void 0!==r?r:0===a.length})},h=new CodeMirror.TernServer({caseInsensitive:!0,plugins:{threejs:null}});return m.setOption("extraKeys",{"Ctrl-Space":function(e){h.complete(e)},"Ctrl-I":function(e){h.showType(e)},"Ctrl-O":function(e){h.showDocs(e)},"Alt-.":function(e){h.jumpToDef(e)},"Alt-,":function(e){h.jumpBack(e)},"Ctrl-Q":function(e){h.rename(e)},"Ctrl-.":function(e){h.selectName(e)}}),m.on("cursorActivity",function(e){"javascript"===u&&h.updateArgHints(e)}),m.on("keypress",function(e,t){if("javascript"===u){var r=String.fromCharCode(t.which||t.keyCode);/[\w\.]/.exec(r)&&h.complete(e)}}),t.editorCleared.add(function(){r.setDisplay("none")}),t.editScript.add(function(e,t){var a,i,s;if("object"==typeof t)a="javascript",i=t.name,s=t.source,n.setValue(e.name+" / "+i);else{switch(t){case"vertexShader":a="glsl",i="Vertex Shader",s=e.material.vertexShader||"";break;case"fragmentShader":a="glsl",i="Fragment Shader",s=e.material.fragmentShader||"";break;case"programInfo":a="json",i="Program Properties";var o={defines:e.material.defines,uniforms:e.material.uniforms,attributes:e.material.attributes};s=JSON.stringify(o,null,"\t")}n.setValue(e.material.name+" / "+i)}u=a,c=t,d=e,r.setDisplay(""),m.setValue(s),"json"===a&&(a={name:"javascript",json:!0}),m.setOption("mode",a)}),t.scriptRemoved.add(function(e){c===e&&r.setDisplay("none")}),t.refreshScriptEditor.add(function(e,t,r){if(c===t){var a=m.getHistory();n.setValue(e.name+" / "+t.name),m.setValue(t.source),void 0!==r&&m.setCursor(r),m.setHistory(a)}}),r};