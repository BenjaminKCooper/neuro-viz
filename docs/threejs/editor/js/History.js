History=function(i){this.editor=i,this.undos=[],this.redos=[],this.lastCmdTime=new Date,this.idCounter=0,this.historyDisabled=!1,this.config=i.config,Command(i);var s=this;this.editor.signals.startPlayer.add(function(){s.historyDisabled=!0}),this.editor.signals.stopPlayer.add(function(){s.historyDisabled=!1})},History.prototype={execute:function(i,s){var t=this.undos[this.undos.length-1],e=(new Date).getTime()-this.lastCmdTime.getTime(),o=t&&t.updatable&&i.updatable&&t.object===i.object&&t.type===i.type&&t.script===i.script&&t.attributeName===i.attributeName;o&&"SetScriptValueCommand"===i.type?(t.update(i),i=t):o&&e<500?(t.update(i),i=t):(this.undos.push(i),i.id=++this.idCounter),i.name=void 0!==s?s:i.name,i.execute(),i.inMemory=!0,this.config.getKey("settings/history")&&(i.json=i.toJSON()),this.lastCmdTime=new Date,this.redos=[],this.editor.signals.historyChanged.dispatch(i)},undo:function(){if(this.historyDisabled)return void alert("Undo/Redo disabled while scene is playing.");var i=void 0;return this.undos.length>0&&(i=this.undos.pop(),i.inMemory===!1&&i.fromJSON(i.json)),void 0!==i&&(i.undo(),this.redos.push(i),this.editor.signals.historyChanged.dispatch(i)),i},redo:function(){if(this.historyDisabled)return void alert("Undo/Redo disabled while scene is playing.");var i=void 0;return this.redos.length>0&&(i=this.redos.pop(),i.inMemory===!1&&i.fromJSON(i.json)),void 0!==i&&(i.execute(),this.undos.push(i),this.editor.signals.historyChanged.dispatch(i)),i},toJSON:function(){var i={};if(i.undos=[],i.redos=[],!this.config.getKey("settings/history"))return i;for(var s=0;s<this.undos.length;s++)this.undos[s].hasOwnProperty("json")&&i.undos.push(this.undos[s].json);for(var s=0;s<this.redos.length;s++)this.redos[s].hasOwnProperty("json")&&i.redos.push(this.redos[s].json);return i},fromJSON:function(i){if(void 0!==i){for(var s=0;s<i.undos.length;s++){var t=i.undos[s],e=new window[t.type];e.json=t,e.id=t.id,e.name=t.name,this.undos.push(e),this.idCounter=t.id>this.idCounter?t.id:this.idCounter}for(var s=0;s<i.redos.length;s++){var t=i.redos[s],e=new window[t.type];e.json=t,e.id=t.id,e.name=t.name,this.redos.push(e),this.idCounter=t.id>this.idCounter?t.id:this.idCounter}this.editor.signals.historyChanged.dispatch(this.undos[this.undos.length-1])}},clear:function(){this.undos=[],this.redos=[],this.idCounter=0,this.editor.signals.historyChanged.dispatch()},goToState:function(i){if(this.historyDisabled)return void alert("Undo/Redo disabled while scene is playing.");this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;var s=this.undos.length>0?this.undos[this.undos.length-1]:void 0;if(void 0===s||i>s.id)for(s=this.redo();void 0!==s&&i>s.id;)s=this.redo();else for(;;){if(s=this.undos[this.undos.length-1],void 0===s||i===s.id)break;s=this.undo()}this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch(),this.editor.signals.historyChanged.dispatch(s)},enableSerialization:function(i){this.goToState(-1),this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;for(var s=this.redo();void 0!==s;)s.hasOwnProperty("json")||(s.json=s.toJSON()),s=this.redo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.goToState(i)}};