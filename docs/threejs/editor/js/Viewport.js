var Viewport=function(e){function t(e,t){return F.set(2*e.x-1,-(2*e.y)+1),P.setFromCamera(F,h),P.intersectObjects(t)}function n(e,t,n){var o=e.getBoundingClientRect();return[(t-o.left)/o.width,(n-o.top)/o.height]}function o(){if(0===y.distanceTo(L)){var n=t(L,R);if(n.length>0){var o=n[0].object;void 0!==o.userData.object?e.select(o.userData.object):e.select(o)}else e.select(null);u()}}function a(e){e.preventDefault();var t=n(f.dom,e.clientX,e.clientY);y.fromArray(t),document.addEventListener("mouseup",d,!1)}function d(e){var t=n(f.dom,e.clientX,e.clientY);L.fromArray(t),o(),document.removeEventListener("mouseup",d,!1)}function i(e){var t=e.changedTouches[0],o=n(f.dom,t.clientX,t.clientY);y.fromArray(o),document.addEventListener("touchend",r,!1)}function r(e){var t=e.changedTouches[0],a=n(f.dom,t.clientX,t.clientY);L.fromArray(a),o(),document.removeEventListener("touchend",r,!1)}function c(e){var o=n(f.dom,e.clientX,e.clientY);M.fromArray(o);var a=t(M,R);if(a.length>0){var d=a[0];l.objectFocused.dispatch(d.object)}}function s(){requestAnimationFrame(s),m&&m.isPresenting&&u()}function u(){g.updateMatrixWorld(),v.updateMatrixWorld(),m&&m.isPresenting?(p.update(),h.updateMatrixWorld(),m.render(v,w),m.render(g,w)):(E.render(v,h),E instanceof THREE.RaytracingRenderer==!1&&E.render(g,h))}var l=e.signals,f=new UI.Panel;f.setId("viewport"),f.setPosition("absolute"),f.add(new Viewport.Info(e));var m,p,E=null,h=e.camera,v=e.scene,g=e.sceneHelpers,R=[];if(WEBVR.isAvailable()===!0){var w=new THREE.PerspectiveCamera;w.projectionMatrix=h.projectionMatrix,h.add(w)}var b=new THREE.GridHelper(30,60);g.add(b);var H=new THREE.Box3,C=new THREE.BoxHelper;C.material.depthTest=!1,C.material.transparent=!0,C.visible=!1,g.add(C);var T=null,x=null,j=null,A=new THREE.TransformControls(h,f.dom);A.addEventListener("change",function(){var t=A.object;void 0!==t&&(C.update(t),void 0!==e.helpers[t.id]&&e.helpers[t.id].update(),l.refreshSidebarObject3D.dispatch(t)),u()}),A.addEventListener("mouseDown",function(){var e=A.object;T=e.position.clone(),x=e.rotation.clone(),j=e.scale.clone(),V.enabled=!1}),A.addEventListener("mouseUp",function(){var t=A.object;if(void 0!==t)switch(A.getMode()){case"translate":T.equals(t.position)||e.execute(new SetPositionCommand(t,t.position,T));break;case"rotate":x.equals(t.rotation)||e.execute(new SetRotationCommand(t,t.rotation,x));break;case"scale":j.equals(t.scale)||e.execute(new SetScaleCommand(t,t.scale,j))}V.enabled=!0}),g.add(A);var P=new THREE.Raycaster,F=new THREE.Vector2,y=new THREE.Vector2,L=new THREE.Vector2,M=new THREE.Vector2;f.dom.addEventListener("mousedown",a,!1),f.dom.addEventListener("touchstart",i,!1),f.dom.addEventListener("dblclick",c,!1);var V=new THREE.EditorControls(h,f.dom);V.addEventListener("change",function(){A.update(),l.cameraChanged.dispatch(h)}),l.editorCleared.add(function(){V.center.set(0,0,0),u()}),l.enterVR.add(function(){m.isPresenting?m.exitPresent():m.requestPresent()}),l.themeChanged.add(function(e){switch(e){case"css/light.css":g.remove(b),b=new THREE.GridHelper(30,60,4473924,8947848),g.add(b);break;case"css/dark.css":g.remove(b),b=new THREE.GridHelper(30,60,12303291,8947848),g.add(b)}u()}),l.transformModeChanged.add(function(e){A.setMode(e)}),l.snapChanged.add(function(e){A.setTranslationSnap(e)}),l.spaceChanged.add(function(e){A.setSpace(e)}),l.rendererChanged.add(function(e){null!==E&&f.dom.removeChild(E.domElement),E=e,E.autoClear=!1,E.autoUpdateScene=!1,E.setPixelRatio(window.devicePixelRatio),E.setSize(f.dom.offsetWidth,f.dom.offsetHeight),f.dom.appendChild(E.domElement),WEBVR.isAvailable()===!0&&(p=new THREE.VRControls(w),m=new THREE.VREffect(E),window.addEventListener("vrdisplaypresentchange",function(e){effect.isPresenting?l.enteredVR.dispatch():l.exitedVR.dispatch()},!1)),u()}),l.sceneGraphChanged.add(function(){u()}),l.cameraChanged.add(function(){u()}),l.objectSelected.add(function(e){C.visible=!1,A.detach(),null!==e&&e!==v&&(H.setFromObject(e),H.isEmpty()===!1&&(C.update(H),C.visible=!0),A.attach(e)),u()}),l.objectFocused.add(function(e){V.focus(e)}),l.geometryChanged.add(function(e){void 0!==e&&C.update(e),u()}),l.objectAdded.add(function(e){e.traverse(function(e){R.push(e)})}),l.objectChanged.add(function(t){e.selected===t&&(C.update(t),A.update()),t instanceof THREE.PerspectiveCamera&&t.updateProjectionMatrix(),void 0!==e.helpers[t.id]&&e.helpers[t.id].update(),u()}),l.objectRemoved.add(function(e){e.traverse(function(e){R.splice(R.indexOf(e),1)})}),l.helperAdded.add(function(e){R.push(e.getObjectByName("picker"))}),l.helperRemoved.add(function(e){R.splice(R.indexOf(e.getObjectByName("picker")),1)}),l.materialChanged.add(function(e){u()}),l.sceneBackgroundChanged.add(function(e){v.background.setHex(e),u()});var k=null;return l.sceneFogChanged.add(function(e,t,n,o,a){if(k!==e){switch(e){case"None":v.fog=null;break;case"Fog":v.fog=new THREE.Fog;break;case"FogExp2":v.fog=new THREE.FogExp2}k=e}v.fog instanceof THREE.Fog?(v.fog.color.setHex(t),v.fog.near=n,v.fog.far=o):v.fog instanceof THREE.FogExp2&&(v.fog.color.setHex(t),v.fog.density=a),u()}),l.windowResize.add(function(){e.DEFAULT_CAMERA.aspect=f.dom.offsetWidth/f.dom.offsetHeight,e.DEFAULT_CAMERA.updateProjectionMatrix(),h.aspect=f.dom.offsetWidth/f.dom.offsetHeight,h.updateProjectionMatrix(),E.setSize(f.dom.offsetWidth,f.dom.offsetHeight),u()}),l.showGridChanged.add(function(e){b.visible=e,u()}),requestAnimationFrame(s),f};